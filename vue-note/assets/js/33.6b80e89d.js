(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{316:function(t,n,s){"use strict";s.r(n);var a=s(14),e=Object(a.a)({},(function(){var t=this,n=t._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"_3-2-组件的patch过程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-组件的patch过程"}},[t._v("#")]),t._v(" 3.2 组件的patch过程")]),t._v(" "),n("p",[t._v("  之前我们已经分析过了，当我们通过"),n("code",[t._v("createComponent")]),t._v("创建了组件的"),n("code",[t._v("vnode")]),t._v("之后执行一系列逻辑，最后通过"),n("code",[t._v("vm.__patch__")]),t._v("方法把"),n("code",[t._v("vnode")]),t._v("转化为真正的"),n("code",[t._v("Dom")]),t._v("节点。这个过程我们在第二章节已经分析过了，但是它是针对某一个普通的"),n("code",[t._v("vnode")]),t._v("，这一小节我们来看看组件的"),n("code",[t._v("vnode")]),t._v("有什么不同。\n我们在执行"),n("code",[t._v("patch")]),t._v("（"),n("code",[t._v("patch.js")]),t._v("中的"),n("code",[t._v("patch")]),t._v("方法）逻辑时会执行"),n("code",[t._v("createElm")]),t._v("方法，其中有这样一段逻辑")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("createComponent")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" parentElm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" refElm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("  判断"),n("code",[t._v("createComponent()")]),t._v("不为空就"),n("code",[t._v("return")]),t._v("，我们来看看"),n("code",[t._v("patch")]),t._v("过程中"),n("code",[t._v("createComponent()")]),t._v("方法做了什么事，注意这里的"),n("code",[t._v("createComponent")]),t._v("方法与上节课的方法不是一回事。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("createComponent")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" parentElm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" refElm")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("isDef")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" isReactivated "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("isDef")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("componentInstance"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("keepAlive\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("isDef")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("hook"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("isDef")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("init"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("i")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* hydrating */")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// after calling the init hook, if the vnode is a child component")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// it should've created a child instance and mounted it. the child")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// component also has set the placeholder vnode's elm.")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// in that case we can just return the element and be done.")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 在调用init hook之后，如果vnode是一个子组件，那么它应该创建一个子实例并挂载它。子组件还设置了占位符vnode的elm。在这种情况下，我们只需返回元素就可以了")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("isDef")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("componentInstance"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("initComponent")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("insert")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parentElm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" refElm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("isTrue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("isReactivated"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("reactivateComponent")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" insertedVnodeQueue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" parentElm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" refElm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("  首先是获取到"),n("code",[t._v("vnode.data")]),t._v("，然后判断"),n("code",[t._v("data")]),t._v("存在与否，然后定义"),n("code",[t._v("isReactivated")]),t._v("，这个变量是与"),n("code",[t._v("keepAlive")]),t._v("有关的内容，我们先不做分析，再往下我们看看"),n("code",[t._v("i")]),t._v("中有没有"),n("code",[t._v("hook")]),t._v("，"),n("code",[t._v("hook")]),t._v("中有没有"),n("code",[t._v("init")]),t._v("方法，如果有就执行"),n("code",[t._v("init()")]),t._v("方法，这里的"),n("code",[t._v("i")]),t._v("变量重复利用被赋值为"),n("code",[t._v("init")]),t._v("方法。\n那么"),n("code",[t._v("init")]),t._v("方法是什么东西呢？又是在哪定义的呢？我们在上一小节分析组件"),n("code",[t._v("vnode")]),t._v("的生成是时有一段注册"),n("code",[t._v("hook")]),t._v("的方法")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[t._v("installComponentHooks")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("  就是在这个函数中注册了组件的这些钩子，也就是在"),n("code",[t._v("data.hook")]),t._v("上注册了这些hook钩子，我们接下来看看"),n("code",[t._v("init")]),t._v("方法的定义")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vnode"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" VNodeWithData"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("hydrating")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" boolean"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v("boolean "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("componentInstance "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("componentInstance"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_isDestroyed "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n    vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("keepAlive\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// kept-alive components, treat as a patch")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("mountedNode")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vnode "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// work around flow")]),t._v("\n    componentVNodeHooks"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("prepatch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mountedNode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mountedNode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" child "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("componentInstance "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("createComponentInstanceForVnode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      activeInstance\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    child"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("$mount")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hydrating "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("elm "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hydrating"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("  因为"),n("code",[t._v("if")]),t._v("里面是有关"),n("code",[t._v("keepAlive")]),t._v("的逻辑，所以我们直接看"),n("code",[t._v("else")]),t._v("逻辑，定义"),n("code",[t._v("child")]),t._v("并设置它和"),n("code",[t._v("vnode.componentInstance")]),t._v("为"),n("code",[t._v("createComponentInstanceForVnode()")]),t._v("，我们先来看"),n("code",[t._v("createComponentInstanceForVnode")]),t._v("方法，"),n("code",[t._v("vnode.componentInstance")]),t._v("也是在这里被赋值，在"),n("code",[t._v("new VNode")]),t._v("时实际上是赋值为"),n("code",[t._v("undefined")]),t._v("，这里我们需要注意一下，在"),n("code",[t._v("3.4")]),t._v("小节时候我们会用到。这里特别注意一下传入的第二个参数"),n("code",[t._v("activeInstance")]),t._v("，这个变量是什么我们后面会分析。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("createComponentInstanceForVnode")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// we know it's MountedComponentVNode but flow doesn't")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("vnode")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// activeInstance in lifecycle state")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("parent")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Component "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("options")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" InternalComponentOptions "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("_isComponent")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("_parentVnode")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    parent\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// check inline-template render functions")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" inlineTemplate "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("inlineTemplate\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("isDef")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("inlineTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("render "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" inlineTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("render\n    options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("staticRenderFns "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" inlineTemplate"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("staticRenderFns\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("componentOptions"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Ctor")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("  该函数接收两个参数，第一个是组件"),n("code",[t._v("vnode")]),t._v("，第二个是"),n("code",[t._v("parent")]),t._v("，实际上就是当前vm实例。它首先定义"),n("code",[t._v("options")]),t._v("对象，第一个"),n("code",[t._v("_isComponent")]),t._v("属性为"),n("code",[t._v("true")]),t._v("，它肯定是作为组件的标识存在了；第二个属性"),n("code",[t._v("_parentVnode")]),t._v("为"),n("code",[t._v("vnode")]),t._v("，也就是组件"),n("code",[t._v("vnode")]),t._v("，我们可以理解为占位"),n("code",[t._v("vnode")]),t._v("，它是个占位节点；第三个属性"),n("code",[t._v("parent")]),t._v("即当前"),n("code",[t._v("vm")]),t._v("实例（相对于子组件来说它就是父vm实例，但是此时子组件还未实例化）。接下来是"),n("code",[t._v("template")]),t._v("逻辑先跳过，最后返回"),n("code",[t._v("new vnode.componentOptions.Ctor(options)")]),t._v("。")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),n("p",[t._v("options中的第一个属性_isComponent为true这里要特别注意一下，后面我们会用到。")])]),t._v(" "),n("p",[t._v("那这里的vnode.componentOptions.Ctor是什么东西呢？我再来回顾一下上个小节的内容：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" vnode "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("VNode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("vue-component-")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("Ctor"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cid"),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Ctor"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" propsData"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" listeners"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tag"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" children "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    asyncFactory\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("  在创建组件"),n("code",[t._v("vnode")]),t._v("函数最后生成组件"),n("code",[t._v("vnode")]),t._v("时候第八个参数是一个对象，它其实就是"),n("code",[t._v("vnode.componentOptions")]),t._v("对象，可以看到这个对象里是有"),n("code",[t._v("Ctor")]),t._v("的，然后再回顾一下"),n("code",[t._v("Ctor")]),t._v("是怎么来的？其实就是通过"),n("code",[t._v("Vue.extend")]),t._v("方法创建的"),n("code",[t._v("Sub")]),t._v("子构造器，那么"),n("code",[t._v("new Sub")]),t._v("时候会发生什么事呢？我们再看"),n("code",[t._v("Sub")]),t._v("构造函数的定义。")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("Sub")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("VueComponent")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("options")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("_init")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("  它在"),n("code",[t._v("new")]),t._v("的过程中执行了"),n("code",[t._v("this._init(options)")]),t._v("方法，这就又回到我们"),n("code",[t._v("Vue")]),t._v("的初始化时候执行的"),n("code",[t._v("_init")]),t._v("方法了，因为"),n("code",[t._v("Sub")]),t._v("构造器是从"),n("code",[t._v("Vue")]),t._v("继承来的，所以"),n("code",[t._v("Sub")]),t._v("跟"),n("code",[t._v("Vue")]),t._v("其实基本上是一致的，所以这儿"),n("code",[t._v("this._init(options)")]),t._v("方法的调用实际上就是在执行"),n("code",[t._v("Vue")]),t._v("的初始化方法，所以我们再回到"),n("code",[t._v("init.js")]),t._v("文件下的"),n("code",[t._v("_init()")]),t._v("的定义，可以看到在初始各个选项前先执行的"),n("code",[t._v("option")]),t._v("的合并：")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[t._v("  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// merge options 合并option")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_isComponent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// optimize internal component instantiation 优化内部组件实例化")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// since dynamic options merging is pretty slow, and none of the 因为动态选项合并非常慢，而且")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// internal component options needs special treatment. 内部组件选项需要特殊处理")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("initInternalComponent")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$options "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("mergeOptions")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolveConstructorOptions")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("constructor"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      options "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      vm\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("  首先判断的是"),n("code",[t._v("options._isComponent")]),t._v("，如果为"),n("code",[t._v("true")]),t._v("则执行的是组件的逻辑，我们上面特别标注了"),n("code",[t._v("options._isComponent")]),t._v("，所以这里会执行"),n("code",[t._v("initInternalComponent")]),t._v("方法。\n这个方法也是定义在"),n("code",[t._v("init.js")]),t._v("文件下的，我们接下来看看它做了什么")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("initInternalComponent")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("vm")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Component"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("options")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" InternalComponentOptions")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" opts "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$options "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Object"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("constructor"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// doing this because it's faster than dynamic enumeration.")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这样做是因为它比动态枚举更快")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" parentVnode "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_parentVnode\n  opts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("parent "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("parent\n  opts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_parentVnode "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" parentVnode\n\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" vnodeComponentOptions "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" parentVnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("componentOptions\n  opts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("propsData "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vnodeComponentOptions"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("propsData\n  opts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_parentListeners "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vnodeComponentOptions"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("listeners\n  opts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_renderChildren "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vnodeComponentOptions"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("children\n  opts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_componentTag "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vnodeComponentOptions"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tag\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("render"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    opts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("render "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("render\n    opts"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("staticRenderFns "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("staticRenderFns\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("  它接收了两个参数一个"),n("code",[t._v("vm")]),t._v("一个"),n("code",[t._v("options")]),t._v("，这个vm实际上就是"),n("code",[t._v("Sub")]),t._v("构造的实例，首先通过"),n("code",[t._v("Object.create")]),t._v("方法创建了一个继承自"),n("code",[t._v("vm.constructor.options")]),t._v("的对象并赋值给"),n("code",[t._v("opts")]),t._v("和"),n("code",[t._v("vm.$options")]),t._v("，然后获取到"),n("code",[t._v("options")]),t._v("上的父占位节点然后给"),n("code",[t._v("opts")]),t._v("的"),n("code",[t._v("parent")]),t._v("属性赋值为"),n("code",[t._v("options.parent")]),t._v("，"),n("code",[t._v("opts._parentVnode")]),t._v("赋值为"),n("code",[t._v("options.parentVnode")]),t._v("，也就是占位"),n("code",[t._v("vnode")]),t._v("。这两个属性都是在"),n("code",[t._v("createComponentInstanceForVnode")]),t._v("方法中定义的，回顾一下上文我们就可以看到定义"),n("code",[t._v("options")]),t._v("时候有这些属性。"),n("code",[t._v("options.parent")]),t._v("是这个子组件的父"),n("code",[t._v("vm")]),t._v("实例，这儿先特别注意一下这个属性，之后我们来说它为什么是组件的父级"),n("code",[t._v("vm")]),t._v("实例。我先接着往下看，接下来就是吧"),n("code",[t._v("parentVnode.componentOptions")]),t._v("对象中的一些属性添加到"),n("code",[t._v("opts")]),t._v("上。"),n("br"),t._v("\n  那么"),n("code",[t._v("parentVnode.componentOptions")]),t._v("又是个什么东西呢？其实之前在"),n("code",[t._v("new")]),t._v(" 一个子类构造器的时候已经使用过了它了\n我们再来回顾一下生成组件"),n("code",[t._v("vnode")]),t._v("时候执行的方法")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" vnode "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("VNode")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("vue-component-")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("Ctor"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cid"),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("name "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("name"),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" Ctor"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" propsData"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" listeners"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tag"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" children "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  asyncFactory\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("  它的第"),n("code",[t._v("7")]),t._v("参数就是"),n("code",[t._v("componentoptions")]),t._v("，生成"),n("code",[t._v("vnode")]),t._v("的时候他也被添加到"),n("code",[t._v("VNode")]),t._v("中，也就是的"),n("code",[t._v("vnode.componentoptions")]),t._v("，之后"),n("code",[t._v("createComponentInstanceForVnode")]),t._v("方法接收的第一个参数就是生成的"),n("code",[t._v("vnode")]),t._v("，接着定义"),n("code",[t._v("options")]),t._v("时候又被作为它的"),n("code",[t._v("_parentVnode")]),t._v("属性，最后在"),n("code",[t._v("new Sub")]),t._v("时传入了"),n("code",[t._v("options")]),t._v("，所以我们在"),n("code",[t._v("init")]),t._v("中取到的"),n("code",[t._v("options")]),t._v("参数会有这些属性。说到这里我们其实还没真正分析到"),n("code",[t._v("initInternalComponent")]),t._v("方法做了什么事，其实它与非组件初始化逻辑类似，都是在对"),n("code",[t._v("options")]),t._v("进行合并，合并后的结果保存在"),n("code",[t._v("vm.options")]),t._v("中。最后有关"),n("code",[t._v("options.render")]),t._v("内容我们先不做分析，这是对应上面"),n("code",[t._v("inlineTemplate")]),t._v("存在时候的内容。\n值得一提的是这里的"),n("code",[t._v("vm.constructor.options")]),t._v("是"),n("code",[t._v("Vue")]),t._v("的一些公共配置，比如说一些全局组件、全局指令、全局过滤器等；这些在"),n("RouterLink",{attrs:{to:"/appendix/mergeOptions.html"}},[t._v("mergeOptions文档")]),t._v("中有涉及。"),n("br"),t._v("\n  我继续往下看"),n("code",[t._v("init")]),t._v("时候执行了"),n("code",[t._v("initLifecycle(vm)")]),t._v("逻辑，我们来看看这个函数做了什么事，"),n("code",[t._v("initLifecycle")]),t._v("函数定义于"),n("code",[t._v("lifecycle.js")]),t._v("文件下")],1),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("initLifecycle")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("vm")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Component")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" options "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$options\n\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// locate first non-abstract parent")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" parent "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("parent "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 定义parent引用当前组件父组件")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果父组件存在且子组件不是抽象的")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parent "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("abstract"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果父组件是抽象的且父组件还存在父组件就向上寻找父组件，直到其不是抽象为止")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("parent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("abstract "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" parent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$parent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      parent "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" parent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$parent\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将子组件实例vm push到父组件的$children中")]),t._v("\n    parent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$children"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$parent "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" parent\n  vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$root "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" parent "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" parent"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$root "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" vm\n  vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$children "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$refs "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_watcher "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n  vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_inactive "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n  vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_directInactive "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n  vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_isMounted "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n  vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_isDestroyed "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n  vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_isBeingDestroyed "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("  该函数主要功能就是对父子组件建立联系，将子组件的"),n("code",[t._v("vm")]),t._v("实例保存到父组件的"),n("code",[t._v("$children")]),t._v("中，当然要求是父子组件都不能是抽象组件。那么什么是抽象组件呢？"),n("br"),t._v("\n  抽象组件有两个特点："),n("br"),t._v("\n  ①不渲染真实"),n("code",[t._v("dom")]),t._v("，比如内置组件"),n("code",[t._v("keep-alive")]),t._v("和"),n("code",[t._v("transition")]),t._v("组件；"),n("br"),t._v("\n  ②不出现在父子关系路径上述逻辑是其实就是第二个特点的实现，之后就是在vm上初始化一些属性。"),n("br"),t._v("\n  在这里我们又见到了"),n("code",[t._v("parent")]),t._v("，我们之前说它是父"),n("code",[t._v("vm")]),t._v("实例，它被一级一级函数调用传递下来，直到合并选项的时候挂载到"),n("code",[t._v("vm.$options")]),t._v("上，它的来源是执行"),n("code",[t._v("createComponentInstanceForVnode()")]),t._v("函数时候作为第二个参数被传入，那时它还不叫"),n("code",[t._v("parent")]),t._v("，而是"),n("code",[t._v("activeInstance")]),t._v("。这便是"),n("code",[t._v("parent")]),t._v("的源头了，我们再来看"),n("code",[t._v("activeInstance")]),t._v("的定义，它实际上也是定义在"),n("code",[t._v("lifecycle.js")]),t._v("文件下的")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("activeInstance")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" any "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n")])])]),n("p",[t._v("  可以看到它是在全局被定义为"),n("code",[t._v("null")]),t._v("，很显然"),n("code",[t._v("null")]),t._v("不是我们想要的结果，所以我们来看看它在哪被赋值。在它定义的下面有这样一个函数定义")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setActiveInstance")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("vm")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Component")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" prevActiveInstance "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" activeInstance\n  activeInstance "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vm\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    activeInstance "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" prevActiveInstance\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("  实现了一个闭包函数，返回函数将"),n("code",[t._v("activeInstance")]),t._v("设为"),n("code",[t._v("prevActiveInstance")]),t._v("，外层函数执行时，实际上是用了中间变量"),n("code",[t._v("prevActiveInstance")]),t._v("去保存"),n("code",[t._v("activeInstance")]),t._v("，然后将"),n("code",[t._v("activeInstance")]),t._v("设置为"),n("code",[t._v("vm")]),t._v("，内层函数执行却又把"),n("code",[t._v("activeInstance")]),t._v("恢复初始值，我们再来看看它的调用以便于分析为什么要这么做。"),n("br"),t._v(" "),n("code",[t._v("setActiveInstance")]),t._v("方法的调用也是在"),n("code",[t._v("lifecycle.js")]),t._v("文件下，在"),n("code",[t._v("lifecycleMixin")]),t._v("方法下的"),n("code",[t._v("_update")]),t._v("方法下被调用的，我们第二章分析"),n("code",[t._v("_update")]),t._v("方法的时候是跳过组件相关逻辑直接去分析"),n("code",[t._v("__patch__")]),t._v("方法，现在我们来分析组件相关逻辑")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Vue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("_update")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("vnode")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" VNode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hydrating"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" boolean")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("vm")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Component "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" prevEl "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$el\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" prevVnode "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_vnode\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" restoreActiveInstance "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setActiveInstance")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("prevVnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// initial render")]),t._v("\n    vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$el "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("__patch__")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$el"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hydrating"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* removeOnly */")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// updates")]),t._v("\n    vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$el "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("__patch__")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("prevVnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vnode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n  "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("restoreActiveInstance")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("  在执行"),n("code",[t._v("setActiveInstanc")]),t._v("e时候将"),n("code",[t._v("activeInstance")]),t._v("设置为"),n("code",[t._v("vm")]),t._v("，在执行完"),n("code",[t._v("patch")]),t._v("后又将其设置为初始值，下面我们来调试运行来看一下这个过程")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Vue")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("data")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("a")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'我是root'")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("render")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("h")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("h")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("App"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("$mount")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'#app'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("  我们还是这个小例子，根组件渲染了"),n("code",[t._v("App")]),t._v("组件，"),n("code",[t._v("new Vue")]),t._v("时候执行了"),n("code",[t._v("init")]),t._v("方法进行初始化，生成跟组件"),n("code",[t._v("vm")]),t._v("实例后就结束了，至于内容挂载其实是要靠我们的"),n("code",[t._v("$mount")]),t._v("方法，在"),n("code",[t._v("init")]),t._v("中最后一段逻辑是这样的")]),t._v(" "),n("div",{staticClass:"language-js extra-class"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("el"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("$mount")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$options"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("el"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("  当"),n("code",[t._v("vm.options.el")]),t._v("存在时才会调用挂载方法，显然首次初始化时候"),n("code",[t._v("el")]),t._v("是不存在的，所以我们在"),n("code",[t._v("new Vue()")]),t._v("后会手动调用"),n("code",[t._v("$mount")]),t._v("方法并传入挂载点"),n("code",[t._v("#app")]),t._v("。"),n("br"),t._v("\n  之后流程就如我们第二章所分析的那样去执行"),n("code",[t._v("lifecycle.js")]),t._v("下的"),n("code",[t._v("mountComponent")]),t._v("方法，之后通过渲染"),n("code",[t._v("water")]),t._v("来执行"),n("code",[t._v("updateComponent")]),t._v("进而执行"),n("code",[t._v("_render")]),t._v("方法生成"),n("code",[t._v("vnode")]),t._v("，在生成"),n("code",[t._v("vnode")]),t._v("的过程中，我们调用了"),n("code",[t._v("createElement")]),t._v("进而执行了"),n("code",[t._v("createComponent")]),t._v("方法，其实就是我们本章"),n("code",[t._v("3.1")]),t._v("小节所述流程。"),n("code",[t._v("createComponent")]),t._v("方法生成组件"),n("code",[t._v("App")]),t._v("的"),n("code",[t._v("vnode")]),t._v("。所以根组件生成的"),n("code",[t._v("vnode")]),t._v("实际上是"),n("code",[t._v("App")]),t._v("的组件"),n("code",[t._v("vnode")]),t._v("，为什么父组件会生成子组件"),n("code",[t._v("vnode")]),t._v("呢？我们来想想"),n("code",[t._v("vnode")]),t._v("是什么，"),n("code",[t._v("vnode")]),t._v("是虚拟"),n("code",[t._v("dom")]),t._v("，在根组件中调用"),n("code",[t._v("render")]),t._v("函数就是去生成"),n("code",[t._v("App")]),t._v("的"),n("code",[t._v("vnode")]),t._v("，"),n("code",[t._v("App")]),t._v("组件实际上就是根组件要渲染的内容。所以Vue子组件的"),n("code",[t._v("vnode")]),t._v("实际上是父组件生成的。这可能会造成一些误解，组件生成的"),n("code",[t._v("vnode")]),t._v("可能并不是组件"),n("code",[t._v("vnode")]),t._v("，因为组件生成的"),n("code",[t._v("vnode")]),t._v("总是它的内容，只有它又包含子组件时，它才会生成组件"),n("code",[t._v("vnode")]),t._v("，那么子组件生成的"),n("code",[t._v("vnode")]),t._v("是怎么样的呢？以我们"),n("code",[t._v("App")]),t._v("组件为例，我们这么一段内容")]),t._v(" "),n("div",{staticClass:"language-html extra-class"},[n("pre",{pre:!0,attrs:{class:"language-html"}},[n("code",[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("hello world"),n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token tag"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),n("p",[t._v("  那么它生成的"),n("code",[t._v("vnode")]),t._v("其实就是个普通的div的"),n("code",[t._v("vnode")]),t._v("，而不是组件"),n("code",[t._v("vnode")]),t._v("，这是我们一定要注意的，如果思维不能转化过来的话，以后我们的分析中就会陷入很多误区。"),n("br"),t._v("\n  我们再接着讲整个挂载流程，在执行完3.1小节所述流程后其实是生生了根组件的"),n("code",[t._v("vnode")]),t._v("，这时候会执行"),n("code",[t._v("vm._update()")]),t._v("方法（"),n("code",[t._v("lifecycle.js")]),t._v("下"),n("code",[t._v("updateComponent")]),t._v("方法）。进而再执行"),n("code",[t._v("vm.__patch__")]),t._v("方法，最终执行的其实就是本章开头所讲述的流程。这儿生成的是组件"),n("code",[t._v("vnode")]),t._v("所以在"),n("code",[t._v("patch")]),t._v("过程中多执行了一些方法，其中"),n("code",[t._v("createComponent()")]),t._v("方法会执行并返回"),n("code",[t._v("true")]),t._v("，根据开头所示逻辑，当该函数返回"),n("code",[t._v("true")]),t._v("时会直接"),n("code",[t._v("return")]),t._v("。我们已经知道"),n("code",[t._v("createElm")]),t._v("方法是将"),n("code",[t._v("vnode")]),t._v("转化成真实"),n("code",[t._v("dom")]),t._v("的方法，但是这里我们直接返回了，没有执行后续插入"),n("code",[t._v("dom")]),t._v("的逻辑。那岂不是说组件就没有被渲染成真实"),n("code",[t._v("dom")]),t._v("吗？答案显然不是的，所以我们可以断言组件的插入逻辑肯定是在"),n("code",[t._v("createComponent()")]),t._v("中，我们再回顾一下"),n("code",[t._v("createComponent()")]),t._v("方法，可以看到它的核心逻辑其实就是执行"),n("code",[t._v("init")]),t._v("函数，而"),n("code",[t._v("init")]),t._v("函数除了我们提到的"),n("code",[t._v("createComponentInstanceForVnode()")]),t._v("方法外还执行了另一个重要逻辑，就是"),n("code",[t._v("child.$mount()")]),t._v("方法，而"),n("code",[t._v("child")]),t._v("又是"),n("code",[t._v("createComponentInstanceForVnode()")]),t._v("返回的，所以"),n("code",[t._v("child")]),t._v("其实就是"),n("code",[t._v("Vue")]),t._v("子类构造器构造的子组件实例，也就是我们的"),n("code",[t._v("App")]),t._v("组件实例了，所以它同样有"),n("code",[t._v("$mount")]),t._v("方法，显然这就是组件实际被挂载的逻辑。代码执行到这里其实已经和普通内容的挂载没什么两样了。"),n("br"),t._v("\n  讲到这里其实就跟之前的内容串起来了，上面我们抛开正题从头分析"),n("code",[t._v("Vue")]),t._v("执行过程的目的是什么呢？记得我们之前"),n("code",[t._v("createComponentInstanceForVnode()")]),t._v("的第二个参数是"),n("code",[t._v("activeInstance")]),t._v("，我们在分析时特别标注了这个东西，这个全局变量是穿插在整个"),n("code",[t._v("Vue")]),t._v("组件挂载中的东西，熟悉整个代码的执行流程才能更好的理解它。它英文意思是——活跃的实例，我们把它理解为正在激活的组件实例，或者正在更新或挂载的组件实例。它是在"),n("code",[t._v("__patch__")]),t._v("前被赋值的，而子组件会在"),n("code",[t._v("__patch__")]),t._v("过程中遇到子组件然后在实例化子组件时"),n("code",[t._v("activeInstance")]),t._v("作为子组件的父"),n("code",[t._v("vm")]),t._v("实例被传入，也只能是父组件实例，因为子组件还没有被实例化，所以这个参数被重定义为"),n("code",[t._v("parent")]),t._v("一级一级的传入，最后它被保留在子组件"),n("code",[t._v("vm.$options.parent")]),t._v("中，在子组件实例化过程中"),n("code",[t._v("vm.$options.parent")]),t._v("使子组件和父组件建立联系。为了把"),n("code",[t._v("activeInstance")]),t._v("讲清楚，我们花费大篇章节去说明组件化执行的整个流程，这不仅使我们更好的理解"),n("code",[t._v("activeInstance")]),t._v("是什么，更使我们对整个代码执行过程有了更深的理解。"),n("br"),t._v("\n  最后我们再补充一些上面没提到的内容。什么是占位"),n("code",[t._v("vnode")]),t._v("？什么是渲染"),n("code",[t._v("vnode")]),t._v("？占位"),n("code",[t._v("vnode")]),t._v("并不是真的节点，只是用于占位。比如组件"),n("code",[t._v("vnode")]),t._v("就是一个占位vnode，在父组件中创建但是并不用于渲染真实节点，在"),n("code",[t._v("patch")]),t._v("过程中遇到组件"),n("code",[t._v("vnode")]),t._v("会实例化组件，再将组件中的内容转化为"),n("code",[t._v("vnode")]),t._v("最后再调用"),n("code",[t._v("patch")]),t._v("完成渲染，实际上占位节点作用就是占位，它告诉渲染器这里有个节点不能直接渲染需要做一些特别处理才能去渲染。渲染"),n("code",[t._v("vnode")]),t._v("就是真正用于渲染的"),n("code",[t._v("vnode")]),t._v("，可以转化为"),n("code",[t._v("dom")]),t._v("，它的"),n("code",[t._v("tag")]),t._v("一般是"),n("code",[t._v("html")]),t._v("元素如"),n("code",[t._v("div")]),t._v("等。"),n("code",[t._v("patch")]),t._v("插入顺序是怎样的？"),n("code",[t._v("patch")]),t._v("过程是一个深度遍历的过程，"),n("code",[t._v("js")]),t._v("是单线程的，所以"),n("code",[t._v("patch")]),t._v("方法总是遍历执行到最深处，最终体现是先插入子后插入父。"),n("br"),t._v("\n  到这里我们组件的"),n("code",[t._v("patch")]),t._v("就讲解完了，下一小节我们讲解选项合并。")])])}),[],!1,null,null,null);n.default=e.exports}}]);
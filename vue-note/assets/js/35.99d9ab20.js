(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{309:function(t,s,a){"use strict";a.r(s);var e=a(14),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"_4-3-依赖收集-下"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-依赖收集-下"}},[t._v("#")]),t._v(" 4.3 依赖收集（下）")]),t._v(" "),s("p",[t._v("  上一个小节我们从源码层面分析了Vue的依赖分析过程，这个小节我们通过一个小例子来具体分析依赖收集的整个过程。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Vue")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("el")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'#app'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("render")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("h")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("h")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("App"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[t._v("  组件App如下：")]),t._v(" "),s("div",{staticClass:"language-vue extra-class"},[s("pre",{pre:!0,attrs:{class:"language-vue"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("template")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    hello world{{ b }}\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("template")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token script"}},[s("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("data")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("b")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'我是app'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("c")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("d")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'我也是app'")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("  可以看到上面是一个十分简单的小例子，首先又是我们"),s("code",[t._v("new Vue")]),t._v("做了什么的那一套逻辑，我想这里可以不必再详细描述了，我们直接从执行"),s("code",[t._v("mountComponent")]),t._v("方法挂载开始说，在这个过程中执行了"),s("code",[t._v("new Watcher")]),t._v("创建我们的观察者，"),s("code",[t._v("new Watcher")]),t._v("时执行到它的"),s("code",[t._v("get")]),t._v("方法，这个在上小节已经说过了，"),s("code",[t._v("get")]),t._v("方法会先执行"),s("code",[t._v("pushTarget(this)")]),t._v("，这个方法就会给"),s("code",[t._v("Dep")]),t._v("类的静态属性"),s("code",[t._v("target")]),t._v("赋值，赋值为我们这里创建的"),s("code",[t._v("watcher")]),t._v("，我们"),s("code",[t._v("new Watcher")]),t._v("时会有")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("uid "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// uid for batching")]),t._v("\n")])])]),s("p",[t._v("  也就是每个"),s("code",[t._v("watcher")]),t._v("都有唯一的"),s("code",[t._v("id")]),t._v("，那么这里就是"),s("code",[t._v("id")]),t._v("为1的观察者，"),s("code",[t._v("pushTarget")]),t._v("执行完成后就会执行"),s("code",[t._v("getter")]),t._v("函数，"),s("code",[t._v("get")]),t._v("函数就是"),s("code",[t._v("new Watcher")]),t._v("时传入的"),s("code",[t._v("updateComponent")]),t._v("方法，它长面这个样子")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("updateComponent")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  vm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("_update")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("_render")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" hydrating"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// hydrating 服务端渲染相关")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("  是不是回忆起来了呢？然后执行"),s("code",[t._v("vm._render")]),t._v("生成"),s("code",[t._v("App")]),t._v("组件的占位"),s("code",[t._v("vnode")]),t._v("，然后调用"),s("code",[t._v("vm._update")]),t._v("方法，"),s("code",[t._v("vm._update")]),t._v("方法就会执行"),s("code",[t._v("patch")]),t._v("方法去插入节点，"),s("code",[t._v("patch")]),t._v("时发现这是个组件"),s("code",[t._v("vnode")]),t._v("，它就开始初始化子组件，初始化子组件就又是"),s("code",[t._v("new Vue")]),t._v("的这一系列逻辑，这时候有一些不同之处，当然这个不同之处不是"),s("code",[t._v("Vue")]),t._v("带来的，而是我们写的"),s("code",[t._v("dome")]),t._v("带来的，初始化组件时执行"),s("code",[t._v("initState")]),t._v("方法也就是4.1小节讲的那个流程，把"),s("code",[t._v("data")]),t._v("里的数据都处理为响应式的，当然初始化根组件时也执行了"),s("code",[t._v("initState")]),t._v("，但是那里我们没有定义"),s("code",[t._v("data")]),t._v("，所以不需要特别指出这个过程。我们子组件定义了"),s("code",[t._v("data")]),t._v("所以就要特别指出了。\n之后还是一样的流程"),s("code",[t._v("new Watcher")]),t._v("生产一个"),s("code",[t._v("id")]),t._v("为2的"),s("code",[t._v("watcher")]),t._v("，然后又执行"),s("code",[t._v("pushTarge")]),t._v("t方法，把"),s("code",[t._v("Dep.target")]),t._v("设置为"),s("code",[t._v("watcher2")]),t._v("(id为2这里就暂且这么去称呼)，同时"),s("code",[t._v("targetStack")]),t._v("中也将"),s("code",[t._v("watcher2 push")]),t._v("进去，再继续执行到"),s("code",[t._v("vm._render")]),t._v("方法，这里因为模板了绑定了'{ { b } }'，实际上会访问"),s("code",[t._v("this.b")]),t._v("，这就触发了"),s("code",[t._v("get")]),t._v("拦截了，这时候"),s("code",[t._v("Dep.target")]),t._v("是"),s("code",[t._v("watcher2")]),t._v("，所以会执行if中逻辑，也就是执行d"),s("code",[t._v("ep.depend")]),t._v("，这个方法又会调用"),s("code",[t._v("Dep.target.addDep")]),t._v("，也就是"),s("code",[t._v("watcher2.addDep(this)")]),t._v("，这里的"),s("code",[t._v("dep")]),t._v("是在"),s("code",[t._v("defineReactive")]),t._v("中定义的"),s("code",[t._v("dep")]),t._v("，如下所示\n")]),s("div",{staticClass:"center"},[s("img",{attrs:{src:"/4.3.1.png"}})]),s("p"),t._v(" "),s("p",[t._v("  可以看到它已经排行老7了，因为"),s("code",[t._v("new Dep")]),t._v("的地方比较多，我们也不必深究为什么它是老7。我们只要知道它长什么样子就可以了。"),s("code",[t._v("addDep")]),t._v("方法执行呢就会往"),s("code",[t._v("watcher2")]),t._v("的"),s("code",[t._v("newDepIds")]),t._v("中添加"),s("code",[t._v("dep.id")]),t._v("，往"),s("code",[t._v("newDep")]),t._v("中添加"),s("code",[t._v("dep7")]),t._v("，最后如果旧的"),s("code",[t._v("depIds")]),t._v("中没有"),s("code",[t._v("id为7")]),t._v("的值，就执行"),s("code",[t._v("dep.addSub(this)")]),t._v("，实际上就是将"),s("code",[t._v("watcher2")]),t._v("添加到"),s("code",[t._v("dep7")]),t._v("的"),s("code",[t._v("subs")]),t._v("中，这样"),s("code",[t._v("watcher2")]),t._v("就做为订阅者去订阅这些数据的变化，一旦数据发生改变就可以通知订阅者去更新数据。"),s("br"),t._v("\n  这里还有个新旧"),s("code",[t._v("dep")]),t._v("的概念，包括"),s("code",[t._v("deps、depIds、newDeps、newDepIds")]),t._v("，我们先继续往下看，说了这么多其实它就是执行了"),s("code",[t._v("this.b")]),t._v("的"),s("code",[t._v("get")]),t._v("拦截而已，它的结果其实就是取到了"),s("code",[t._v("b")]),t._v("的值"),s("code",[t._v("'我是app'")]),t._v("，然后完成"),s("code",[t._v("render")]),t._v("过程，再完成"),s("code",[t._v("patch")]),t._v("过程，最后其实也就是完成了"),s("code",[t._v("updateComponent")]),t._v("，也就是完成了"),s("code",[t._v("watcher2")]),t._v("的"),s("code",[t._v("get")]),t._v("函数的一部分，这里我们再回顾一次"),s("code",[t._v("watcher")]),t._v("的"),s("code",[t._v("get")]),t._v("函数执行")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pushTarget")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" value\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" vm "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vm\n  value "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getter")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("call")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("vm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" vm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("popTarget")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cleanupDeps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" value\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("  我们上面分析那么其实都是在执行执行完成了"),s("code",[t._v("this.getter.call")]),t._v("，再往下执行是"),s("code",[t._v("popTarget")]),t._v("，这部分是我们上节没有讲到的，我们来看一下"),s("code",[t._v("popTarget")]),t._v("方法")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("popTarget")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  targetStack"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pop")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  Dep"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("target "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" targetStack"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("targetStack"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("  这里执行完"),s("code",[t._v("watcher2")]),t._v("之后就将"),s("code",[t._v("targetStack.pop()")]),t._v("，这样堆栈中就只剩"),s("code",[t._v("watcher1")]),t._v("了，这是再重新把"),s("code",[t._v("Dep.target")]),t._v("设置为上一个"),s("code",[t._v("watcher")]),t._v("，在这里也就是"),s("code",[t._v("watcher1")]),t._v("，关于"),s("code",[t._v("Vue")]),t._v("这种先子后父的顺序是贯穿整个"),s("code",[t._v("Vue")]),t._v("执行过程的，关于保存当前正在执行的内容也是很多地方都有体现，在不同场景下也是通过不同方法去保存的，这里是通过堆栈的方式去保存"),s("code",[t._v("watcher")]),t._v("的。"),s("code",[t._v("currentRenderingInstance、activeInstance")]),t._v("其实也都是类似的思路，但是他们是通过局部变量保存的。\n再接着往下看执行"),s("code",[t._v("this.cleanupDeps")]),t._v("，我们再看这里做了什么事")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cleanupDeps")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("deps"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("i"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("--")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" dep "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("deps"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("newDepIds"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("has")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dep"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      dep"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("removeSub")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" tmp "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("depIds\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("depIds "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("newDepIds\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("newDepIds "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tmp\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("newDepIds"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("clear")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  tmp "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("deps\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("deps "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("newDeps\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("newDeps "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tmp\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("newDeps"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("先获取"),s("code",[t._v("this.deps")]),t._v("数组长度并定义"),s("code",[t._v("i")]),t._v("保存，通过"),s("code",[t._v("while(i--)")]),t._v("循环直到"),s("code",[t._v("i")]),t._v("为0为止，这个循环做了什么事呢？这里就与我们之前提到的新旧"),s("code",[t._v("dep")]),t._v("的概念有关了，这里先要判断新的"),s("code",[t._v("dep")]),t._v("的"),s("code",[t._v("id")]),t._v("列表"),s("code",[t._v("newDepIds")]),t._v("中没有"),s("code",[t._v("dep.id")]),t._v("，说明这个旧的依赖不需要了，就调用"),s("code",[t._v("dep.removeSub(this)")]),t._v("把观察者"),s("code",[t._v("watcher")]),t._v("从"),s("code",[t._v("dep")]),t._v("的"),s("code",[t._v("subs")]),t._v("中删除")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("removeSub")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("sub")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Watcher")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("remove")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("subs"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sub"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("  我们"),s("code",[t._v("removeSub")]),t._v("方法就是执行了"),s("code",[t._v("remove")]),t._v("方法，"),s("code",[t._v("remove")]),t._v("方法详见util文档。"),s("br"),t._v("\n  接下来定义"),s("code",[t._v("tmp")]),t._v("保存"),s("code",[t._v("this.depIds")]),t._v("，然后将"),s("code",[t._v("this.depIds")]),t._v("设置为"),s("code",[t._v("this.newDepIds")]),t._v("，将"),s("code",[t._v("this.newDepIds = tmp")]),t._v("，也就是将新旧"),s("code",[t._v("id")]),t._v("数组互换，然后执行"),s("code",[t._v("this.newDepIds.clear")]),t._v("将数组清空，然后对"),s("code",[t._v("deps")]),t._v("和"),s("code",[t._v("newDeps")]),t._v("也执行相同的操作。这个方法就是将旧的依赖收集换成新的依赖收集，然后再将新依赖收集全部清空等待下一次重新收集新依赖。"),s("br"),t._v("\n  这里为什么要这样做呢？我们简单改一下"),s("code",[t._v("App.vue")])]),t._v(" "),s("div",{staticClass:"language-vue extra-class"},[s("pre",{pre:!0,attrs:{class:"language-vue"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("template")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    hello world\n    {{ isB ? b : c.d }}\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("template")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token script"}},[s("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("data")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("isB")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("b")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'我是app'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("c")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("d")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'我也是app'")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("  在这里我们依赖是有分支切换的，"),s("code",[t._v("isB")]),t._v("为"),s("code",[t._v("true")]),t._v(" 的时候，依赖项其实"),s("code",[t._v("b")]),t._v("，若修改"),s("code",[t._v("isB")]),t._v("为"),s("code",[t._v("false")]),t._v("的时候，依赖项是"),s("code",[t._v("c.d")]),t._v("，这个时候要修改"),s("code",[t._v("c.d")]),t._v("的值的话肯定会触发页面更新，但是如果我们修改"),s("code",[t._v("b")]),t._v("的值呢？"),s("code",[t._v("b")]),t._v("已经不在页面上显示了，如果我们没有执行"),s("code",[t._v("clearupDeps")]),t._v("方法的话，它其实也不会报错，而是会触发一次更新，因为"),s("code",[t._v("b")]),t._v("已经不显示了，我们对这次更新是无感知的，但它是实实在在发生的。为了避免这种不必要更新的情况，这里通过重新收集依赖并替换旧的依赖方式来解决。"),s("br"),t._v("\n  到这里我们依赖收集的内容就都讲完了，可能你还是没有明白"),s("code",[t._v("dep")]),t._v("是什么？为什么这么定义，收集这个有什么用？"),s("code",[t._v("watcher")]),t._v("又是什么？它为什么能做观察者或者订阅者的？尽管整个收集过程我们已经很清楚了，但是这么设计理由是什么我们不清楚，这么设计有什么用也不清楚。不要着急，这是因为我们不知道它是怎么实现更新的，依赖收集就是为派发更新做的准备，如果没有派发更新，依赖收集也就没了意义，所以下一小节我们就来了解一下"),s("code",[t._v("Vue")]),t._v("是怎么通过修改数据来触发页面的更新吧。")])])}),[],!1,null,null,null);s.default=n.exports}}]);
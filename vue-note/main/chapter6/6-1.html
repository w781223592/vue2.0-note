<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>卷心菜笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="./logo.jpg">
    <meta name="description" content="基于vue@2.6.14的学习笔记">
    
    <link rel="preload" href="./assets/css/0.styles.88a4e9f5.css" as="style"><link rel="preload" href="./assets/js/app.2826a362.js" as="script"><link rel="preload" href="./assets/js/2.8a65079d.js" as="script"><link rel="preload" href="./assets/js/58.0595fbec.js" as="script"><link rel="prefetch" href="./assets/js/10.c266c0d8.js"><link rel="prefetch" href="./assets/js/11.e1eaa455.js"><link rel="prefetch" href="./assets/js/12.a175422e.js"><link rel="prefetch" href="./assets/js/13.ce6b27c7.js"><link rel="prefetch" href="./assets/js/14.4ab13b5a.js"><link rel="prefetch" href="./assets/js/15.89c1bf18.js"><link rel="prefetch" href="./assets/js/16.78f7cadf.js"><link rel="prefetch" href="./assets/js/17.eee5b860.js"><link rel="prefetch" href="./assets/js/18.e94d03e8.js"><link rel="prefetch" href="./assets/js/19.9e73c1ac.js"><link rel="prefetch" href="./assets/js/20.334ef7f2.js"><link rel="prefetch" href="./assets/js/21.ce6ec28c.js"><link rel="prefetch" href="./assets/js/22.8276901b.js"><link rel="prefetch" href="./assets/js/23.c4649d50.js"><link rel="prefetch" href="./assets/js/24.e1df98bf.js"><link rel="prefetch" href="./assets/js/25.c325e810.js"><link rel="prefetch" href="./assets/js/26.4ec079ec.js"><link rel="prefetch" href="./assets/js/27.0e97179e.js"><link rel="prefetch" href="./assets/js/28.0a90597d.js"><link rel="prefetch" href="./assets/js/29.04a6e255.js"><link rel="prefetch" href="./assets/js/3.5443ad74.js"><link rel="prefetch" href="./assets/js/30.4c6515c4.js"><link rel="prefetch" href="./assets/js/31.60d2f4c4.js"><link rel="prefetch" href="./assets/js/32.bf54c965.js"><link rel="prefetch" href="./assets/js/33.61b55587.js"><link rel="prefetch" href="./assets/js/34.c3f3eb0f.js"><link rel="prefetch" href="./assets/js/35.3e97ba3f.js"><link rel="prefetch" href="./assets/js/36.0ff1be33.js"><link rel="prefetch" href="./assets/js/37.2859b7ee.js"><link rel="prefetch" href="./assets/js/38.c2a0a515.js"><link rel="prefetch" href="./assets/js/39.0fcd1b2d.js"><link rel="prefetch" href="./assets/js/4.4dfc388f.js"><link rel="prefetch" href="./assets/js/40.a45a4a21.js"><link rel="prefetch" href="./assets/js/41.7d171f2d.js"><link rel="prefetch" href="./assets/js/42.f2f5ea2d.js"><link rel="prefetch" href="./assets/js/43.544241cd.js"><link rel="prefetch" href="./assets/js/44.6014c885.js"><link rel="prefetch" href="./assets/js/45.3c1b0136.js"><link rel="prefetch" href="./assets/js/46.2a63fa48.js"><link rel="prefetch" href="./assets/js/47.7131563e.js"><link rel="prefetch" href="./assets/js/48.c3d6bdc3.js"><link rel="prefetch" href="./assets/js/49.08f18c4b.js"><link rel="prefetch" href="./assets/js/5.7771716e.js"><link rel="prefetch" href="./assets/js/50.06bd69e2.js"><link rel="prefetch" href="./assets/js/51.ed19bd31.js"><link rel="prefetch" href="./assets/js/52.cdd244b0.js"><link rel="prefetch" href="./assets/js/53.7e1f2059.js"><link rel="prefetch" href="./assets/js/54.95edb54c.js"><link rel="prefetch" href="./assets/js/55.4ad5a772.js"><link rel="prefetch" href="./assets/js/56.d55c7dcb.js"><link rel="prefetch" href="./assets/js/57.9926dcec.js"><link rel="prefetch" href="./assets/js/59.4793d557.js"><link rel="prefetch" href="./assets/js/6.f0272f8f.js"><link rel="prefetch" href="./assets/js/60.f92f02e3.js"><link rel="prefetch" href="./assets/js/61.b3b4fa7d.js"><link rel="prefetch" href="./assets/js/62.773f83d2.js"><link rel="prefetch" href="./assets/js/63.f2e2a6e0.js"><link rel="prefetch" href="./assets/js/64.71a49175.js"><link rel="prefetch" href="./assets/js/65.3ebdd57e.js"><link rel="prefetch" href="./assets/js/66.7abb5241.js"><link rel="prefetch" href="./assets/js/67.ed6fbab5.js"><link rel="prefetch" href="./assets/js/68.8798425e.js"><link rel="prefetch" href="./assets/js/69.875b50ee.js"><link rel="prefetch" href="./assets/js/7.55ad3c14.js"><link rel="prefetch" href="./assets/js/70.44d1903b.js"><link rel="prefetch" href="./assets/js/71.897ebf84.js"><link rel="prefetch" href="./assets/js/72.05498643.js"><link rel="prefetch" href="./assets/js/73.ddf48f99.js"><link rel="prefetch" href="./assets/js/74.09357e4a.js"><link rel="prefetch" href="./assets/js/75.bb0567a1.js"><link rel="prefetch" href="./assets/js/76.ac9407c1.js"><link rel="prefetch" href="./assets/js/77.136d3e39.js"><link rel="prefetch" href="./assets/js/78.577e17e9.js"><link rel="prefetch" href="./assets/js/79.dd1ef766.js"><link rel="prefetch" href="./assets/js/8.8d9c7635.js"><link rel="prefetch" href="./assets/js/80.6d018d78.js"><link rel="prefetch" href="./assets/js/81.0caa34e0.js"><link rel="prefetch" href="./assets/js/82.88a5092b.js"><link rel="prefetch" href="./assets/js/83.cb5759fe.js"><link rel="prefetch" href="./assets/js/84.8eb37a19.js"><link rel="prefetch" href="./assets/js/85.446cc3ec.js"><link rel="prefetch" href="./assets/js/86.6ae4ae72.js"><link rel="prefetch" href="./assets/js/87.51a4cddc.js"><link rel="prefetch" href="./assets/js/88.5cb86311.js"><link rel="prefetch" href="./assets/js/89.11fe5589.js"><link rel="prefetch" href="./assets/js/9.9bd6d99d.js"><link rel="prefetch" href="./assets/js/90.b3555572.js">
    <link rel="stylesheet" href="./assets/css/0.styles.88a4e9f5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><!----> <span class="site-name">卷心菜笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./main/" class="nav-link router-link-active">
  正文
</a></div><div class="nav-item"><a href="/./appendix/mergeOptions.html" class="nav-link">
  附录
</a></div><div class="nav-item"><a href="/./util/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/w781223592/vue2.0-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/./main/" class="nav-link router-link-active">
  正文
</a></div><div class="nav-item"><a href="/./appendix/mergeOptions.html" class="nav-link">
  附录
</a></div><div class="nav-item"><a href="/./util/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/w781223592/vue2.0-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/./main/" aria-current="page" class="sidebar-link">前言</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第一章 初识Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter1/1-1.html" class="sidebar-link">1.1 Vue目录设计</a></li><li><a href="/./main/chapter1/1-2.html" class="sidebar-link">1.2 Vue入口文件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第二章 Vue初始化和挂载</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter2/2-1.html" class="sidebar-link">2.1 new Vue()时做了什么</a></li><li><a href="/./main/chapter2/2-2.html" class="sidebar-link">2.2 Vue实例挂载的实现</a></li><li><a href="/./main/chapter2/2-3.html" class="sidebar-link">2.3 Vue挂载时的mountComponent</a></li><li><a href="/./main/chapter2/2-4.html" class="sidebar-link">2.4 Virtual DOM</a></li><li><a href="/./main/chapter2/2-5.html" class="sidebar-link">2.5 最终的挂载方法_update</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第三章 组件化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter3/3-1.html" class="sidebar-link">3.1 创建组件vnode</a></li><li><a href="/./main/chapter3/3-2.html" class="sidebar-link">3.2组件的patch过程</a></li><li><a href="/./main/chapter3/3-3.html" class="sidebar-link">3.3合并配置</a></li><li><a href="/./main/chapter3/3-4.html" class="sidebar-link">3.4生命周期（上）</a></li><li><a href="/./main/chapter3/3-5.html" class="sidebar-link">3.5生命周期（下）</a></li><li><a href="/./main/chapter3/3-6.html" class="sidebar-link">3.6组件的注册</a></li><li><a href="/./main/chapter3/3-7.html" class="sidebar-link">3.7 异步组件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第四章 响应式原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter4/4-1.html" class="sidebar-link">4.1 响应式对象</a></li><li><a href="/./main/chapter4/4-2.html" class="sidebar-link">4.2 依赖收集（上）</a></li><li><a href="/./main/chapter4/4-3.html" class="sidebar-link">4.3 依赖收集（下）</a></li><li><a href="/./main/chapter4/4-4.html" class="sidebar-link">4.4 派发更新</a></li><li><a href="/./main/chapter4/4-5.html" class="sidebar-link">4.5 nextTick</a></li><li><a href="/./main/chapter4/4-6.html" class="sidebar-link">4.6 检测变化的坑</a></li><li><a href="/./main/chapter4/4-7.html" class="sidebar-link">4.7 计算属性</a></li><li><a href="/./main/chapter4/4-8.html" class="sidebar-link">4.8 侦听器</a></li><li><a href="/./main/chapter4/4-9.html" class="sidebar-link">4.9 组件更新</a></li><li><a href="/./main/chapter4/4-10.html" class="sidebar-link">4.10 diff算法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第五章 编译</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter5/5-1.html" class="sidebar-link">5.1 初探编译器</a></li><li><a href="/./main/chapter5/5-2.html" class="sidebar-link">5.2 从入口开始</a></li><li><a href="/./main/chapter5/5-3.html" class="sidebar-link">5.3 parse之解析模板（上）</a></li><li><a href="/./main/chapter5/5-4.html" class="sidebar-link">5.4 parse之解析模板（下）</a></li><li><a href="/./main/chapter5/5-5.html" class="sidebar-link">5.5 parse之生成AST（1）</a></li><li><a href="/./main/chapter5/5-6.html" class="sidebar-link">5.6 parse之生成AST（2）</a></li><li><a href="/./main/chapter5/5-7.html" class="sidebar-link">5.7 parse之生成AST（3）</a></li><li><a href="/./main/chapter5/5-8.html" class="sidebar-link">5.8 parse之生成AST（4）</a></li><li><a href="/./main/chapter5/5-9.html" class="sidebar-link">5.9 parse之生成AST（5）</a></li><li><a href="/./main/chapter5/5-10.html" class="sidebar-link">5.10 optimize优化</a></li><li><a href="/./main/chapter5/5-11.html" class="sidebar-link">5.11 generate代码生成（1）</a></li><li><a href="/./main/chapter5/5-12.html" class="sidebar-link">5.12 generate代码生成（2）</a></li><li><a href="/./main/chapter5/5-13.html" class="sidebar-link">5.11 generate代码生成（3）</a></li><li><a href="/./main/chapter5/5-14.html" class="sidebar-link">5.11 generate代码生成（4）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>第六章 扩展</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter6/6-1.html" aria-current="page" class="active sidebar-link">6.1 events（1）</a></li><li><a href="/./main/chapter6/6-2.html" class="sidebar-link">6.1 events（2）</a></li><li><a href="/./main/chapter6/6-3.html" class="sidebar-link">6.1 events（3）</a></li><li><a href="/./main/chapter6/6-4.html" class="sidebar-link">6.1 events（4）</a></li><li><a href="/./main/chapter6/6-5.html" class="sidebar-link">6.5 v-model（1）</a></li><li><a href="/./main/chapter6/6-6.html" class="sidebar-link">6.6 v-model（3）</a></li><li><a href="/./main/chapter6/6-7.html" class="sidebar-link">6.7v-model（3）</a></li><li><a href="/./main/chapter6/6-8.html" class="sidebar-link">6.8v-model（4）</a></li><li><a href="/./main/chapter6/6-9.html" class="sidebar-link">6.9 slot（上）</a></li><li><a href="/./main/chapter6/6-10.html" class="sidebar-link">6.10 slot（中）</a></li><li><a href="/./main/chapter6/6-11.html" class="sidebar-link">6.11 slot（下）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第七章 内置组件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter7/7-1.html" class="sidebar-link">7.1 keep-alive（上）</a></li><li><a href="/./main/chapter7/7-2.html" class="sidebar-link">7.2 keep-alive（下）</a></li><li><a href="/./main/chapter7/7-3.html" class="sidebar-link">7.3 transition（上）</a></li><li><a href="/./main/chapter7/7-4.html" class="sidebar-link">7.4 transition（中）</a></li><li><a href="/./main/chapter7/7-5.html" class="sidebar-link">7.5 transition（下）</a></li><li><a href="/./main/chapter7/7-6.html" class="sidebar-link">7.6 transition-group</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第八章 Vue-router</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter8/8-1.html" class="sidebar-link">8.1 vue-router的注册</a></li><li><a href="/./main/chapter8/8-2.html" class="sidebar-link">8.2 VueRouter实例化</a></li><li><a href="/./main/chapter8/8-3.html" class="sidebar-link">8.3 动态路由</a></li><li><a href="/./main/chapter8/8-4.html" class="sidebar-link">8.4 match</a></li><li><a href="/./main/chapter8/8-5.html" class="sidebar-link">8.5 导航守卫（上）</a></li><li><a href="/./main/chapter8/8-6.html" class="sidebar-link">8.5 导航守卫（中）</a></li><li><a href="/./main/chapter8/8-7.html" class="sidebar-link">8.5 导航守卫（下）</a></li><li><a href="/./main/chapter8/8-8.html" class="sidebar-link">8.8 路径切换</a></li><li><a href="/./main/chapter8/8-9.html" class="sidebar-link">8.9 router-view组件</a></li><li><a href="/./main/chapter8/8-10.html" class="sidebar-link">8.10 router-link组件</a></li><li><a href="/./main/chapter8/8-11.html" class="sidebar-link">8.11 history模式</a></li></ul></section></li><li><a href="/./main/finish.html" class="sidebar-link">结束感言</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>  我们上小节分析了复杂编译过程，但是我们还有很多逻辑没有覆盖到，它涉及了比较复杂的指令，比如<code>v-on</code>、<code>v-slot</code>等指令的处理，那么这个小节我们就来分析这些复杂的指令是怎么工作的。</p> <h1 id="_6-1-events-1"><a href="#_6-1-events-1" class="header-anchor">#</a> 6.1 events（1）</h1> <p>  Vue对于指令的解析大部分都在<code>processAttrs</code>中，包括对指令的修饰符处理，对一些特殊的指令比如<code>v-if</code>、<code>v-for</code>等会有专门的<code>process</code>系列函数处理，这些特殊的指令我们在编译章节已经分析的差不多了。
这个小节我们就来分析<code>v-on</code>指令，首先我们来回顾一下<code>processAttrs</code>中对<code>v-on</code>指令的处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>dirRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// mark element as dynamic</span>
  el<span class="token punctuation">.</span>hasBindings <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token comment">// modifiers</span>
  modifiers <span class="token operator">=</span> <span class="token function">parseModifiers</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>dirRE<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>onRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// v-on</span>
    name <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>onRE<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    isDynamic <span class="token operator">=</span> dynamicArgRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isDynamic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      name <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">addHandler</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> modifiers<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> warn<span class="token punctuation">,</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> isDynamic<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在解析到<code>v-</code>或者<code>@</code>开头时会执行这段代码。这里会通过<code>onRE</code>正则匹配<code>v-on</code>指令或者<code>@</code>，如果匹配到就会执行一个<code>addHandler</code>方法，我们来看<code>addHandler</code>方法的实现</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">addHandler</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement<span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token literal-property property">modifiers</span><span class="token operator">:</span> <span class="token operator">?</span>ASTModifiers<span class="token punctuation">,</span>
  important<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  warn<span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span>
  range<span class="token operator">?</span><span class="token operator">:</span> Range<span class="token punctuation">,</span>
  dynamic<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  modifiers <span class="token operator">=</span> modifiers <span class="token operator">||</span> emptyObject
  <span class="token comment">// warn prevent and passive modifier</span>
  <span class="token comment">/* istanbul ignore if */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> warn <span class="token operator">&amp;&amp;</span>
    modifiers<span class="token punctuation">.</span>prevent <span class="token operator">&amp;&amp;</span> modifiers<span class="token punctuation">.</span>passive
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span>
      <span class="token string">'passive and prevent can\'t be used together. '</span> <span class="token operator">+</span>
      <span class="token string">'Passive handler can\'t prevent default event.'</span><span class="token punctuation">,</span>
      range
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 标准化右键单击、中键单击，因为它们实际上没有启动，这在技术上是特定于浏览器的， 但至少目前浏览器是唯一具有右/中点击的目标环境</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiers<span class="token punctuation">.</span>right<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dynamic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      name <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)==='click'?'contextmenu':(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">'click'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      name <span class="token operator">=</span> <span class="token string">'contextmenu'</span>
      <span class="token keyword">delete</span> modifiers<span class="token punctuation">.</span>right
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiers<span class="token punctuation">.</span>middle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dynamic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      name <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)==='click'?'mouseup':(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">'click'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      name <span class="token operator">=</span> <span class="token string">'mouseup'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 省略部分</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个方法比较长我们一点点来分析，首先这里第一个参数元素对象<code>el</code>，第二个参数是<code>事件名称</code>，第三个是事件<code>value</code>，第四个参数是<code>修饰符</code>。<code>important</code>等我们用到了再去看它是做什么的。
首先要获取修饰符对象<code>modifiers</code>，然后接下来会判断是否同时使用了<code>passive</code>修饰符和<code>prevent</code>修饰符，这两个同时使用时会移除<code>prevent</code>，因为它两是互斥的。
接下来会判断是否是鼠标右键和中键点击事件，其修饰符分别为right和middle。然后并根据是否是动态事件名进行不同处理，实际上对这两个修饰符来说是只能用在click事件上的，其他事件上使用会被忽略。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// check capture modifier</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiers<span class="token punctuation">.</span>capture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> modifiers<span class="token punctuation">.</span>capture
    name <span class="token operator">=</span> <span class="token function">prependModifierMarker</span><span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> dynamic<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiers<span class="token punctuation">.</span>once<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> modifiers<span class="token punctuation">.</span>once
    name <span class="token operator">=</span> <span class="token function">prependModifierMarker</span><span class="token punctuation">(</span><span class="token string">'~'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> dynamic<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* istanbul ignore if */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiers<span class="token punctuation">.</span>passive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> modifiers<span class="token punctuation">.</span>passive
    name <span class="token operator">=</span> <span class="token function">prependModifierMarker</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> dynamic<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  这里又处理了几个修饰符，比如<code>capture</code>修饰符，我们知道这个修饰符会让我们的事件在捕获阶段就执行，而正常是在冒泡阶段执行的。然后是<code>once</code>修饰符和<code>passive</code>修饰符。这几个修饰符处理方案相同，都是先从<code>modifiers</code>中移除它们并执行一个<code>prependModifierMarker</code>方法，只是传入的第一个参数不同。<br>
我们来看<code>prependModifierMarker</code>方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">prependModifierMarker</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">symbol</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> string<span class="token punctuation">,</span> dynamic<span class="token operator">?</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">return</span> dynamic
    <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_p(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>symbol<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;)</span><span class="token template-punctuation string">`</span></span>
    <span class="token operator">:</span> symbol <span class="token operator">+</span> name <span class="token comment">// mark the event as captured</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  我们来看非动态情况，对于<code>click</code>事件的来说，<code>capture</code>修饰符会处理为<code>!click、once</code>修饰符会处理为<code>~click</code>、<code>passive</code>修饰符会处理为<code>&amp;click</code>。<br>
对于动态的处理则是会通过一个<code>_p</code>函数</p> <div class="language-js extra-class"><pre class="language-js"><code>  target<span class="token punctuation">.</span>_p <span class="token operator">=</span> prependModifier
</code></pre></div><p><code>prependModifier</code>方法如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">prependModifier</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">value</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">symbol</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> symbol <span class="token operator">+</span> value <span class="token operator">:</span> value
<span class="token punctuation">}</span>
</code></pre></div><p>和<code>prependModifierMarker</code> 实际上是一样的。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> events
  <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiers<span class="token punctuation">.</span>native<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> modifiers<span class="token punctuation">.</span>native
    events <span class="token operator">=</span> el<span class="token punctuation">.</span>nativeEvents <span class="token operator">||</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>nativeEvents <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    events <span class="token operator">=</span> el<span class="token punctuation">.</span>events <span class="token operator">||</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  如果使用了<code>native</code>修饰符，就将<code>el.nativeEvents</code>赋值给<code>events</code>，并且删除<code>native</code>，否则将<code>el.events</code>赋值给<code>events</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> <span class="token literal-property property">newHandler</span><span class="token operator">:</span> any <span class="token operator">=</span> <span class="token function">rangeSetItem</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dynamic <span class="token punctuation">}</span><span class="token punctuation">,</span> range<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiers <span class="token operator">!==</span> emptyObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newHandler<span class="token punctuation">.</span>modifiers <span class="token operator">=</span> modifiers
  <span class="token punctuation">}</span>
</code></pre></div><p>  定义<code>newHandler</code>对象，里面<code>value</code>属性和<code>dynamic</code>属性，<code>rangeSetItem</code>意义不大我们之前也分析过了，这里就认为没有调用这个方法就好了。<br>
  接下来如果判断<code>modifiers !== emptyObject</code>那就将<code>modifiers</code>保存到<code>newHandler</code>中。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> handlers <span class="token operator">=</span> events<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
  <span class="token comment">/* istanbul ignore if */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>handlers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    important <span class="token operator">?</span> handlers<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>newHandler<span class="token punctuation">)</span> <span class="token operator">:</span> handlers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newHandler<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>handlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    events<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> important <span class="token operator">?</span> <span class="token punctuation">[</span>newHandler<span class="token punctuation">,</span> handlers<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span>handlers<span class="token punctuation">,</span> newHandler<span class="token punctuation">]</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    events<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> newHandler
  <span class="token punctuation">}</span>
  el<span class="token punctuation">.</span>plain <span class="token operator">=</span> <span class="token boolean">false</span>
</code></pre></div><p>  这里首先获取<code>handlers</code>，也就是去找<code>events</code>中是否有对应<code>name</code>的事件信息，如果没有的话直接将<code>events[name]</code>设置为<code>newHandler</code>，如果我们绑定了，如果<code>handlers</code>已经存在了，说明绑定了两个相同的事件，比如绑定两个<code>click</code>事件，那么处理第二个点击事件时会发现<code>events[name]</code>是一个对象了，那么会执行else if逻辑。这时会把同名的事件监听放到一个数组中并赋值给<code>events[name]</code>，至于<code>important</code>是表示事件优先级的，如果<code>important</code>为<code>true</code>那么就将这个事件放到数组前面，否则就添加到后面。那如果定义了三个<code>click</code>事件呢？这时候<code>handlers</code>已经是数组了，那么就直接添加到数组就可以了，但是还是要根据<code>important</code>来确定是用<code>unshift</code>还是<code>push</code>。<br>
  最后将el.plain置为false。<br>
  为更直观的展示我们addHandler方法的处理结果，我们写一个小demo</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;div @click.once=&quot;add&quot;&gt;
    a
  &lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><code>el.events</code>会处理为如下形式</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string-property property">'~click'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'add'</span><span class="token punctuation">,</span> <span class="token literal-property property">dynamic</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">modifiers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  分析完<code>v-on</code>指令的<code>parse</code>过程后，下面就是我们代码生成环节了，这样就会执行到<code>genData</code>逻辑了。在<code>genData</code>函数中我们有很多逻辑没去分析，这里有这样一段代码是专门用来处理事件的</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// event handlers</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">genHandlers</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>events<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>nativeEvents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">genHandlers</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>nativeEvents<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  对于普通事件和<code>native</code>事件都是用<code>genHandlers</code>函数处理的，不同之处在于第二个参数。我们来看它的定义。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">genHandlers</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">events</span><span class="token operator">:</span> ASTElementHandlers<span class="token punctuation">,</span>
  <span class="token literal-property property">isNative</span><span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">const</span> prefix <span class="token operator">=</span> isNative <span class="token operator">?</span> <span class="token string">'nativeOn:'</span> <span class="token operator">:</span> <span class="token string">'on:'</span>
  <span class="token keyword">let</span> staticHandlers <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>
  <span class="token keyword">let</span> dynamicHandlers <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> name <span class="token keyword">in</span> events<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> handlerCode <span class="token operator">=</span> <span class="token function">genHandler</span><span class="token punctuation">(</span>events<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> events<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dynamicHandlers <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>handlerCode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      staticHandlers <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>handlerCode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  staticHandlers <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>staticHandlers<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">`</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dynamicHandlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> prefix <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_d(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>staticHandlers<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dynamicHandlers<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">])</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> prefix <span class="token operator">+</span> staticHandlers
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  这个方法处理很简单，如果是一个<code>native</code>事件的话就使<code>prefix</code>为<code>nativeOn</code>，否则等于<code>on</code>，我们知道<code>render</code>函数中对于普通标签的上的事件绑定是写在<code>data.on</code>中的，而组件的事件监听则是要写在<code>nativeOn</code>中的。<br>
然后这里同样存在静态命名的函数名和动态命名的参数名，所以这里又定义了两个变量来保存。<br>
接下来遍历<code>events</code>对象，然后执行<code>genHandler</code>函数生成<code>handleCode</code>，它总体上就是一个函数<code>function() {...}</code>。因为<code>genHandler</code>内容比较长我们先继续往下分析，最后我们再去处理它。<br>
接下来的处理也很简单，如果是动态的事件名则在dynamicHandlers基础上拼接一个<code>name: handlerCode,</code>，否则拼接到<code>staticHandlers</code>。直到<code>events</code>循环完毕。<br>
后面的逻辑其实就是我们<code>v-bind</code>的指令的既视感，处理方式完全一样，我想就不需要重复分析了。不过这里会在前面拼接prefix，也就<code>on</code>或者<code>nativeOn</code>，之前<code>v-bind</code>前面拼接的是<code>attrs</code>。当然这都是非常合理的。<br>
所以我们接下来的重点就放在<code>handlerCode</code>的生成函数<code>genHandler</code>了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genHandler</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">handler</span><span class="token operator">:</span> ASTElementHandler <span class="token operator">|</span> Array<span class="token operator">&lt;</span>ASTElementHandler<span class="token operator">&gt;</span></span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'function(){}'</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>handler<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">handler</span> <span class="token operator">=&gt;</span> <span class="token function">genHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> isMethodPath <span class="token operator">=</span> simplePathRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
  <span class="token keyword">const</span> isFunctionExpression <span class="token operator">=</span> fnExpRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
  <span class="token keyword">const</span> isFunctionInvocation <span class="token operator">=</span> simplePathRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>fnInvokeRE<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>handler<span class="token punctuation">.</span>modifiers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
   <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  可以看到这里首先判断<code>handler</code>是否存在，如果不存在就返回一个空函数，以防止报错。然后判断<code>handler</code>是否是一个数组，如果是的话就要循环调用<code>genHandler</code>去生成代码。并最后放入一个数组字符串中。
然后接下来才是<code>genHandler</code>正式逻辑，首先定义<code>isMethodPath</code>进行一个简单的路径校验，比如说<code>a、a.b、a['b']、a[&quot;b&quot;]、a[b]</code>等简单路径。这是通过<code>simplePathRE</code>正则做到的，正则定义如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> simplePathRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[A-Za-z_$][\w$]*(?:\.[A-Za-z_$][\w$]*|\['[^']*?']|\[&quot;[^&quot;]*?&quot;]|\[\d+]|\[[A-Za-z_$][\w$]*])*$</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>  看起来是比较复杂，其实就是校验是不是我们上面的几种<code>path</code>形式，可以看到这里是不允许我们携带<code>()</code>的。接下来是通过<code>fnExpRE</code>校验<code>handler.value</code>，也就是判断是否是一个函数形式，其正则如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fnExpRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^([\w$_]+|\([^)]*?\))\s*=&gt;|^function(?:\s+[\w$]+)?\s*\(</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>  判断是否是<code>() =&gt; | function (</code>这样的函数表达式，也就是说我们模板中既可以直接使用methods、data等选项中定义的函数，也可以直接在模板中定义，如下所示：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>a<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>() =&gt; {}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>  第三个则是先将<code>value</code>删除<code>fnInvokeRE</code>匹配然后校验是否是满足<code>simplePathRE</code>，如果满足说明是函数的调用。我们来看<code>fnInvokeRE</code>正则</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fnInvokeRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\([^)]*?\);*$</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>  就是判断是否带有<code>()</code>，并且运行<code>()</code>中有非<code>)</code>字符，也就是<code>a('b')</code>的形式。这里会将<code>('b')</code>去掉只剩下<code>a</code>，<code>a</code>显然是满足<code>simplePathRE</code>的。这三个正则其实就是判断Vue允许的几种绑定事件的方式。<br>
  然后接下来就是一个大的if和else逻辑，我们先看if，if判断的是不含有任何事件修饰符，我们看其内部逻辑</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>isMethodPath <span class="token operator">||</span> isFunctionExpression<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> handler<span class="token punctuation">.</span>value
  <span class="token punctuation">}</span>
  <span class="token comment">/* istanbul ignore if */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__WEEX__ <span class="token operator">&amp;&amp;</span> handler<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genWeexHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span>params<span class="token punctuation">,</span> handler<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function($event){</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
    isFunctionInvocation <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>handler<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> handler<span class="token punctuation">.</span>value
  <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">`</span></span> <span class="token comment">// inline statement</span>
</code></pre></div><p>  如果是一个路径形式或者函数定义，那么直接返回<code>value</code>就好了。接下来是一个WEEK平台的逻辑，我们不用去管他。<br>
  最后我们返回了一个函数定义字符串这个函数闭包持有了<code>$event</code>变量，函数内部则是判断是否是函数调用，如果是函数调用，那就<code>return</code>其调用结果，而且我们在调用时也可以传入劫持的<code>$event</code>变量，只要我们定义为<code>a('b', $event)</code>就可以了。如果不是函数调用那就直接是<code>handler.value</code>，注意这里没有return。
实际上这里是我们第四种事件绑定方式，直接写函数表达式，官方说法就是内联语句。因为前面判断了其他两种方式，而这里又不满足第三种方式，那就只剩最后一种方式了。如下所示</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>a($event)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>c=1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>  显然后者是必须要包裹在一个函数才可以执行，而前者为了能正常访问<code>$event</code>也需要再包裹一层函数。<br>
  接下来我们就看else逻辑，else逻辑就是存在修饰符的逻辑，显然是要对修饰符进行处理，首先会执行</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">let</span> genModifierCode <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">const</span> keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> handler<span class="token punctuation">.</span>modifiers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>modifierCode<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      genModifierCode <span class="token operator">+=</span> modifierCode<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
      <span class="token comment">// left/right</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>keyCodes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'exact'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token literal-property property">modifiers</span><span class="token operator">:</span> ASTModifiers <span class="token operator">=</span> <span class="token punctuation">(</span>handler<span class="token punctuation">.</span>modifiers<span class="token operator">:</span> any<span class="token punctuation">)</span>
      genModifierCode <span class="token operator">+=</span> <span class="token function">genGuard</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span><span class="token string">'ctrl'</span><span class="token punctuation">,</span> <span class="token string">'shift'</span><span class="token punctuation">,</span> <span class="token string">'alt'</span><span class="token punctuation">,</span> <span class="token string">'meta'</span><span class="token punctuation">]</span>
          <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">keyModifier</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>modifiers<span class="token punctuation">[</span>keyModifier<span class="token punctuation">]</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">keyModifier</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">$event.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keyModifier<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">Key</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'||'</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  先初始化几个变量<code>code、genModifierCode、keys</code>，然后遍历<code>handler.modifiers</code>对象，然后会检查<code>modifierCode</code>中是否含有这个修饰符</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// #4868: modifiers that prevent the execution of the listener</span>
<span class="token comment">// need to explicitly return null so that we can determine whether to remove the listener for .once</span>
<span class="token comment">// 阻止侦听器执行的修饰符需要显式返回null，以便我们可以确定是否删除.once的侦听器</span>
<span class="token keyword">const</span> <span class="token function-variable function">genGuard</span> <span class="token operator">=</span> <span class="token parameter">condition</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">if(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>condition<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)return null;</span><span class="token template-punctuation string">`</span></span>

<span class="token keyword">const</span> <span class="token literal-property property">modifierCode</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> string <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">stop</span><span class="token operator">:</span> <span class="token string">'$event.stopPropagation();'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">prevent</span><span class="token operator">:</span> <span class="token string">'$event.preventDefault();'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">self</span><span class="token operator">:</span> <span class="token function">genGuard</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">$event.target !== $event.currentTarget</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">ctrl</span><span class="token operator">:</span> <span class="token function">genGuard</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">!$event.ctrlKey</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">shift</span><span class="token operator">:</span> <span class="token function">genGuard</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">!$event.shiftKey</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">alt</span><span class="token operator">:</span> <span class="token function">genGuard</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">!$event.altKey</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">meta</span><span class="token operator">:</span> <span class="token function">genGuard</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">!$event.metaKey</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token function">genGuard</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'button' in $event &amp;&amp; $event.button !== 0</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">middle</span><span class="token operator">:</span> <span class="token function">genGuard</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'button' in $event &amp;&amp; $event.button !== 1</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token function">genGuard</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'button' in $event &amp;&amp; $event.button !== 2</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  modifierCode定义这些修饰符实现的代码串，比如<code>stop</code>我们知道是阻止冒泡，其实际上是通过<code>e.stopPropagation()实</code>现的。而其它<code>genGuard</code>返回的则是满足这些条件时返回一个<code>null</code>值，为什么返回<code>null</code>注释里已经写清楚了。<br>
  如果是<code>modifierCode</code>定义的修饰符的话，将其代码串拼接到<code>genModifierCode</code>就好了，如果<code>key</code>在<code>keyCodes</code>中也定义了还要将<code>key</code>添加到<code>keys</code>数组中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token literal-property property">keyCodes</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> number <span class="token operator">|</span> Array<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">esc</span><span class="token operator">:</span> <span class="token number">27</span><span class="token punctuation">,</span>
  <span class="token literal-property property">tab</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
  <span class="token literal-property property">enter</span><span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">,</span>
  <span class="token literal-property property">space</span><span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
  <span class="token literal-property property">up</span><span class="token operator">:</span> <span class="token number">38</span><span class="token punctuation">,</span>
  <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token number">37</span><span class="token punctuation">,</span>
  <span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token number">39</span><span class="token punctuation">,</span>
  <span class="token literal-property property">down</span><span class="token operator">:</span> <span class="token number">40</span><span class="token punctuation">,</span>
  <span class="token string-property property">'delete'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">46</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  keyCodes定义如上，这里主要是对<code>left</code>和<code>right</code>修饰符处理，因为其它们是比较特殊的按键修饰符。而其它按键修饰符在这里不会访问到，因为没有在<code>modifierCode</code>中定义。<br>
接下来是对<code>.exact</code>修饰符的判断，这个修饰符允许我们控制由精确的系统修饰符组合触发的事件。我们先来说说什么是系统修饰符。<code>.ctrl、.alt、.shift、.meta</code>这些就是系统修饰符，如下所示</p> <div class="language-html extra-class"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">v-on:</span>click.ctrl</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>doSomething<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Do something<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>  这里我们按住<code>ctrl</code>键并点击鼠标左键时才会触发事件，而使用<code>.exact</code>修饰符时</p> <div class="language-html extra-class"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">v-on:</span>click.ctrl.exact</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>onCtrlClick<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>A<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>  我们同时按<code>ctrl + alt + 左键点击</code>，这时也能触发事件，知道这些后我们else if的逻辑就很简单，也是通过<code>genGuard</code>函数返回一个代码串拼接到<code>genModifierCode</code>。<br>
  接下来如果是其他修饰符就都将其push到<code>keys</code>数组中，然后跳出<code>for</code>循环，接下来判断<code>keys</code>数组不为空的话执行下面逻辑：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>keys<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    code <span class="token operator">+=</span> <span class="token function">genKeyFilter</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  所以这里我们要来看看<code>genKeyFilter</code>逻辑</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genKeyFilter</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">keys</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span></span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token comment">// make sure the key filters only apply to KeyboardEvents</span>
    <span class="token comment">// #9441: can't use 'keyCode' in $event because Chrome autofill fires fake</span>
    <span class="token comment">// key events that do not have keyCode property...</span>
    <span class="token comment">//确保密钥筛选器仅适用于KeyboardEvents</span>
    <span class="token comment">//#9441:无法在$event中使用“keyCode”，因为Chrome自动填充会激发不具有keyCode属性的假键事件。。。</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">if(!$event.type.indexOf('key')&amp;&amp;</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keys<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>genFilterCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&amp;&amp;'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)return null;</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  这个我们简单了解一下就行了，会通过<code>genFilterCode</code>处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genFilterCode</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">key</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">const</span> keyVal <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>keyVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">$event.keyCode!==</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keyVal<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> keyCode <span class="token operator">=</span> keyCodes<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token keyword">const</span> keyName <span class="token operator">=</span> keyNames<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_k($event.keyCode,</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>keyCode<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">$event.key,</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>keyName<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  将key转化为十进制数字，如果<code>keyVal</code>存在就返回<code>$event.keyCode !== ${keyVal}</code>，否则就去找<code>keyCode</code>和k<code>eyName</code>。然后返回_k方法调用，并传入几个参数，第一个参数<code>$event.keyCode</code>，第二个参数<code>key</code>，第三个<code>keyCode</code>，第四个<code>$event.key</code>，第五个<code>keyName</code>。<br>
  keyNames定义如下所示</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// KeyboardEvent.key aliases</span>
<span class="token keyword">const</span> <span class="token literal-property property">keyNames</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> string <span class="token operator">|</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// #7880: IE11 and Edge use `Esc` for Escape key name.</span>
  <span class="token literal-property property">esc</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Esc'</span><span class="token punctuation">,</span> <span class="token string">'Escape'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">tab</span><span class="token operator">:</span> <span class="token string">'Tab'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">enter</span><span class="token operator">:</span> <span class="token string">'Enter'</span><span class="token punctuation">,</span>
  <span class="token comment">// #9112: IE11 uses `Spacebar` for Space key name.</span>
  <span class="token literal-property property">space</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'Spacebar'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// #7806: IE11 uses key names without `Arrow` prefix for arrow keys.</span>
  <span class="token literal-property property">up</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Up'</span><span class="token punctuation">,</span> <span class="token string">'ArrowUp'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Left'</span><span class="token punctuation">,</span> <span class="token string">'ArrowLeft'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Right'</span><span class="token punctuation">,</span> <span class="token string">'ArrowRight'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">down</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Down'</span><span class="token punctuation">,</span> <span class="token string">'ArrowDown'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// #9112: IE11 uses `Del` for Delete key name.</span>
  <span class="token string-property property">'delete'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Backspace'</span><span class="token punctuation">,</span> <span class="token string">'Delete'</span><span class="token punctuation">,</span> <span class="token string">'Del'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  然后看<code>_k</code>方法</p> <div class="language-js extra-class"><pre class="language-js"><code>  target<span class="token punctuation">.</span>_k <span class="token operator">=</span> checkKeyCodes
</code></pre></div><p>  再来看<code>checkKeyCodes</code>方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">checkKeyCodes</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">eventKeyCode</span><span class="token operator">:</span> number<span class="token punctuation">,</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  builtInKeyCode<span class="token operator">?</span><span class="token operator">:</span> number <span class="token operator">|</span> Array<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  eventKeyName<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  builtInKeyName<span class="token operator">?</span><span class="token operator">:</span> string <span class="token operator">|</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span>boolean <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mappedKeyCode <span class="token operator">=</span> config<span class="token punctuation">.</span>keyCodes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">||</span> builtInKeyCode
  <span class="token keyword">if</span> <span class="token punctuation">(</span>builtInKeyName <span class="token operator">&amp;&amp;</span> eventKeyName <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>config<span class="token punctuation">.</span>keyCodes<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">isKeyNotMatch</span><span class="token punctuation">(</span>builtInKeyName<span class="token punctuation">,</span> eventKeyName<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedKeyCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">isKeyNotMatch</span><span class="token punctuation">(</span>mappedKeyCode<span class="token punctuation">,</span> eventKeyCode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>eventKeyName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">hyphenate</span><span class="token punctuation">(</span>eventKeyName<span class="token punctuation">)</span> <span class="token operator">!==</span> key
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> eventKeyCode <span class="token operator">===</span> <span class="token keyword">undefined</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  先获取<code>mappedKeyCode</code>，也就是我们传入的<code>keyCode</code>，当然这里首先去获取的是我们用户<code>Vue.config</code>中自定义的是按键，如果找不到才使用传入的默认值。<br>
  这里<code>isKeyNotMatch</code>是对比期望值和实际值的异同</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> isKeyNotMatch<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>expect<span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span> Array<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token literal-property property">actual</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>expect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> expect<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>actual<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> expect <span class="token operator">!==</span> actual
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  在我们定义的<code>keyCodes</code>和<code>keyNames</code>有很多是有数组项的，所以如果是数组的话就看实际值是否是数组中的一项。这里都是不相等时返回<code>true</code>。因为我们最后生成的代码是<code>return null</code>，也就是说不满足按键要求会也就是实际和期望不同时会什么都不做返回<code>null</code>。<br>
  至于这块<code>checkKeyCodes</code>定义这么复杂是为了处理兼容性问题，还有谷歌浏览器的伪<code>key</code>事件，这里我们了解一下就好了。因为<code>keyCode</code>已经在废弃的边缘了，所以首先是判断<code>event.key</code>的，然后才判断<code>event.keyCode</code>，关于这些我们就分析到这里了。对于按键修饰符我们使用还是比较少的，就不详细叙述了。<br>
  我们写个小demo</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;input v-on:keyup.enter=&quot;add&quot;&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>  最后<code>genFilterCode</code>返回<code>_k($event.keyCode,\&quot;enter\&quot;,13,$event.key,\&quot;Enter\&quot;)</code>，最后<code>genFilter</code>返回<code>&quot;if(!$event.type.indexOf('key')&amp;&amp;_k($event.keyCode,\&quot;enter\&quot;, 13, $event.key,\&quot;Enter\&quot;)) return null;&quot;</code>，这个结果就会拼接到<code>code</code>上，可以看到这些修饰符的作用就是一些条件判断，然后拦截我们的事件，不满足这些条件就不会执行我们用户定义的事件。<br>
  我们接着往下看<code>genHandler</code></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// Make sure modifiers like prevent and stop get executed after key filtering</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>genModifierCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    code <span class="token operator">+=</span> genModifierCode
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> handlerCode <span class="token operator">=</span> isMethodPath
    <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>handler<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.apply(null, arguments)</span><span class="token template-punctuation string">`</span></span>
    <span class="token operator">:</span> isFunctionExpression
      <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">return (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>handler<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">).apply(null, arguments)</span><span class="token template-punctuation string">`</span></span>
      <span class="token operator">:</span> isFunctionInvocation
        <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>handler<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token operator">:</span> handler<span class="token punctuation">.</span>value
  <span class="token comment">/* istanbul ignore if */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__WEEX__ <span class="token operator">&amp;&amp;</span> handler<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">genWeexHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">.</span>params<span class="token punctuation">,</span> code <span class="token operator">+</span> handlerCode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function($event){</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>handlerCode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><p>  然后如果<code>genModifierCode</code>存在的话，就将它也拼接到<code>code</code>后面，这里说要确保<code>stop</code>等事件修饰符在按键修饰符后面判断。<br>
  接下来的三元运算符也很简单，就是和之前一样去处理四种绑定形式的代码，但是这里由于需要在前面插入if控制语句拦截，所以都需要用一个外层函数去包裹它们，所以最后统一做这件事就可以了，中间WEEX平台逻辑我们忽略就好了。最后就返回一个<code>&quot;function($event){if(!$event.type.indexOf('key')&amp;&amp;_k($event.keyCode,&quot;enter&quot;,13,$event.key,&quot;Enter&quot;))return null;return add.apply(null, arguments)}&quot;</code>。<br>
  到这里我们<code>genHandlers</code>方法就分析完了，最后<code>genData</code>会生成一个
<code>&quot;{on:{\&quot;keyup\&quot;:function($event){if(!$event.type.indexOf('key')&amp;&amp;_k($event.keyCode,\&quot;enter\&quot;,13,$event.key,\&quot;Enter\&quot;))return null;return add.apply(null, arguments)}}</code>。也就是将这段代码串放到<code>data.on</code>中，之后交给<code>render</code>函数处理。这里我们在分析过程中为了说清楚按键修饰符而改变了<code>demo</code>，但这对我们最终结果影响是不大的。<br>
  这个小节我们把代码事件的编译过程基本就分析完了，但是对于事件的代码生成还有一部分生僻逻辑我们没有去分析，下个小节我们将简单了解一下这部分内容，然后再去看看我们事件在运行过程中是怎么实现的。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/./main/chapter5/5-14.html" class="prev">
        5.11 generate代码生成（4）
      </a></span> <span class="next"><a href="/./main/chapter6/6-2.html">
        6.1 events（2）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.2826a362.js" defer></script><script src="./assets/js/2.8a65079d.js" defer></script><script src="./assets/js/58.0595fbec.js" defer></script>
  </body>
</html>

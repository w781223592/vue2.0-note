<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>6.11 slot（下） | 卷心菜笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="./logo.jpg">
    <meta name="description" content="基于vue@2.6.14的学习笔记">
    
    <link rel="preload" href="./assets/css/0.styles.34509ede.css" as="style"><link rel="preload" href="./assets/js/app.cb86b5c8.js" as="script"><link rel="preload" href="./assets/js/2.8a65079d.js" as="script"><link rel="preload" href="./assets/js/60.9a43de0b.js" as="script"><link rel="prefetch" href="./assets/js/10.35fa5c54.js"><link rel="prefetch" href="./assets/js/11.a8d301ee.js"><link rel="prefetch" href="./assets/js/12.28dadb6d.js"><link rel="prefetch" href="./assets/js/13.959f52a9.js"><link rel="prefetch" href="./assets/js/14.9e967e5c.js"><link rel="prefetch" href="./assets/js/15.89c1bf18.js"><link rel="prefetch" href="./assets/js/16.78f7cadf.js"><link rel="prefetch" href="./assets/js/17.eee5b860.js"><link rel="prefetch" href="./assets/js/18.e94d03e8.js"><link rel="prefetch" href="./assets/js/19.c9b980d9.js"><link rel="prefetch" href="./assets/js/20.82c7f25f.js"><link rel="prefetch" href="./assets/js/21.5878b705.js"><link rel="prefetch" href="./assets/js/22.e7794d4a.js"><link rel="prefetch" href="./assets/js/23.b1e09bbf.js"><link rel="prefetch" href="./assets/js/24.e1df98bf.js"><link rel="prefetch" href="./assets/js/25.1c2fb721.js"><link rel="prefetch" href="./assets/js/26.36c3f7e0.js"><link rel="prefetch" href="./assets/js/27.a3f09949.js"><link rel="prefetch" href="./assets/js/28.123d6383.js"><link rel="prefetch" href="./assets/js/29.04a6e255.js"><link rel="prefetch" href="./assets/js/3.3554c1dd.js"><link rel="prefetch" href="./assets/js/30.f5e711c8.js"><link rel="prefetch" href="./assets/js/31.7ddb232a.js"><link rel="prefetch" href="./assets/js/32.3710a144.js"><link rel="prefetch" href="./assets/js/33.836eb573.js"><link rel="prefetch" href="./assets/js/34.c3f3eb0f.js"><link rel="prefetch" href="./assets/js/35.3e97ba3f.js"><link rel="prefetch" href="./assets/js/36.0ff1be33.js"><link rel="prefetch" href="./assets/js/37.57e976da.js"><link rel="prefetch" href="./assets/js/38.778b591d.js"><link rel="prefetch" href="./assets/js/39.f89500e6.js"><link rel="prefetch" href="./assets/js/4.414ef3ae.js"><link rel="prefetch" href="./assets/js/40.0bb1a72b.js"><link rel="prefetch" href="./assets/js/41.1b14daa9.js"><link rel="prefetch" href="./assets/js/42.da61de9e.js"><link rel="prefetch" href="./assets/js/43.afa151ce.js"><link rel="prefetch" href="./assets/js/44.beed5647.js"><link rel="prefetch" href="./assets/js/45.15cb664e.js"><link rel="prefetch" href="./assets/js/46.19b76064.js"><link rel="prefetch" href="./assets/js/47.81dd06b3.js"><link rel="prefetch" href="./assets/js/48.da28ae74.js"><link rel="prefetch" href="./assets/js/49.6ec02c7d.js"><link rel="prefetch" href="./assets/js/5.7771716e.js"><link rel="prefetch" href="./assets/js/50.33adc7e6.js"><link rel="prefetch" href="./assets/js/51.ad4dcf8f.js"><link rel="prefetch" href="./assets/js/52.1f63a577.js"><link rel="prefetch" href="./assets/js/53.f08905cc.js"><link rel="prefetch" href="./assets/js/54.95edb54c.js"><link rel="prefetch" href="./assets/js/55.4ad5a772.js"><link rel="prefetch" href="./assets/js/56.d55c7dcb.js"><link rel="prefetch" href="./assets/js/57.2bdbd5d4.js"><link rel="prefetch" href="./assets/js/58.6996ec46.js"><link rel="prefetch" href="./assets/js/59.42c770e8.js"><link rel="prefetch" href="./assets/js/6.f0272f8f.js"><link rel="prefetch" href="./assets/js/61.9fda2ee3.js"><link rel="prefetch" href="./assets/js/62.40ba97a6.js"><link rel="prefetch" href="./assets/js/63.a8ceda24.js"><link rel="prefetch" href="./assets/js/64.063b5356.js"><link rel="prefetch" href="./assets/js/65.609bfe39.js"><link rel="prefetch" href="./assets/js/66.10bbf1b3.js"><link rel="prefetch" href="./assets/js/67.ed6fbab5.js"><link rel="prefetch" href="./assets/js/68.edf47e53.js"><link rel="prefetch" href="./assets/js/69.58c89969.js"><link rel="prefetch" href="./assets/js/7.44545bae.js"><link rel="prefetch" href="./assets/js/70.44d1903b.js"><link rel="prefetch" href="./assets/js/71.f54eb805.js"><link rel="prefetch" href="./assets/js/72.e0f8bc14.js"><link rel="prefetch" href="./assets/js/73.2292a46a.js"><link rel="prefetch" href="./assets/js/74.259c6d32.js"><link rel="prefetch" href="./assets/js/75.a5535961.js"><link rel="prefetch" href="./assets/js/76.2e270b76.js"><link rel="prefetch" href="./assets/js/77.a4bffe25.js"><link rel="prefetch" href="./assets/js/78.e00f48eb.js"><link rel="prefetch" href="./assets/js/79.dd1ef766.js"><link rel="prefetch" href="./assets/js/8.54165142.js"><link rel="prefetch" href="./assets/js/80.6d018d78.js"><link rel="prefetch" href="./assets/js/81.8647d108.js"><link rel="prefetch" href="./assets/js/82.9c326a94.js"><link rel="prefetch" href="./assets/js/83.0a8e8403.js"><link rel="prefetch" href="./assets/js/84.e1f731e8.js"><link rel="prefetch" href="./assets/js/85.446cc3ec.js"><link rel="prefetch" href="./assets/js/86.7800fc8e.js"><link rel="prefetch" href="./assets/js/87.51a4cddc.js"><link rel="prefetch" href="./assets/js/88.5cb86311.js"><link rel="prefetch" href="./assets/js/89.11fe5589.js"><link rel="prefetch" href="./assets/js/9.2a932dde.js"><link rel="prefetch" href="./assets/js/90.b3555572.js">
    <link rel="stylesheet" href="./assets/css/0.styles.34509ede.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><!----> <span class="site-name">卷心菜笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./main/" class="nav-link router-link-active">
  正文
</a></div><div class="nav-item"><a href="/./appendix/mergeOptions.html" class="nav-link">
  附录
</a></div><div class="nav-item"><a href="/./util/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/w781223592/vue2.0-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/./main/" class="nav-link router-link-active">
  正文
</a></div><div class="nav-item"><a href="/./appendix/mergeOptions.html" class="nav-link">
  附录
</a></div><div class="nav-item"><a href="/./util/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/w781223592/vue2.0-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/./main/" aria-current="page" class="sidebar-link">前言</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第一章 初识Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter1/1-1.html" class="sidebar-link">1.1 Vue目录设计</a></li><li><a href="/./main/chapter1/1-2.html" class="sidebar-link">1.2 Vue入口文件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第二章 Vue初始化和挂载</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter2/2-1.html" class="sidebar-link">2.1 new Vue()时做了什么</a></li><li><a href="/./main/chapter2/2-2.html" class="sidebar-link">2.2 Vue实例挂载的实现</a></li><li><a href="/./main/chapter2/2-3.html" class="sidebar-link">2.3 Vue挂载时的mountComponent</a></li><li><a href="/./main/chapter2/2-4.html" class="sidebar-link">2.4 Virtual DOM</a></li><li><a href="/./main/chapter2/2-5.html" class="sidebar-link">2.5 最终的挂载方法_update</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第三章 组件化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter3/3-1.html" class="sidebar-link">3.1 创建组件vnode</a></li><li><a href="/./main/chapter3/3-2.html" class="sidebar-link">3.2组件的patch过程</a></li><li><a href="/./main/chapter3/3-3.html" class="sidebar-link">3.3合并配置</a></li><li><a href="/./main/chapter3/3-4.html" class="sidebar-link">3.4生命周期（上）</a></li><li><a href="/./main/chapter3/3-5.html" class="sidebar-link">3.5生命周期（下）</a></li><li><a href="/./main/chapter3/3-6.html" class="sidebar-link">3.6组件的注册</a></li><li><a href="/./main/chapter3/3-7.html" class="sidebar-link">3.7 异步组件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第四章 响应式原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter4/4-1.html" class="sidebar-link">4.1 响应式对象</a></li><li><a href="/./main/chapter4/4-2.html" class="sidebar-link">4.2 依赖收集（上）</a></li><li><a href="/./main/chapter4/4-3.html" class="sidebar-link">4.3 依赖收集（下）</a></li><li><a href="/./main/chapter4/4-4.html" class="sidebar-link">4.4 派发更新</a></li><li><a href="/./main/chapter4/4-5.html" class="sidebar-link">4.5 nextTick</a></li><li><a href="/./main/chapter4/4-6.html" class="sidebar-link">4.6 检测变化的坑</a></li><li><a href="/./main/chapter4/4-7.html" class="sidebar-link">4.7 计算属性</a></li><li><a href="/./main/chapter4/4-8.html" class="sidebar-link">4.8 侦听器</a></li><li><a href="/./main/chapter4/4-9.html" class="sidebar-link">4.9 组件更新</a></li><li><a href="/./main/chapter4/4-10.html" class="sidebar-link">4.10 diff算法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第五章 编译</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter5/5-1.html" class="sidebar-link">5.1 初探编译器</a></li><li><a href="/./main/chapter5/5-2.html" class="sidebar-link">5.2 从入口开始</a></li><li><a href="/./main/chapter5/5-3.html" class="sidebar-link">5.3 parse之解析模板（上）</a></li><li><a href="/./main/chapter5/5-4.html" class="sidebar-link">5.4 parse之解析模板（下）</a></li><li><a href="/./main/chapter5/5-5.html" class="sidebar-link">5.5 parse之生成AST（1）</a></li><li><a href="/./main/chapter5/5-6.html" class="sidebar-link">5.6 parse之生成AST（2）</a></li><li><a href="/./main/chapter5/5-7.html" class="sidebar-link">5.7 parse之生成AST（3）</a></li><li><a href="/./main/chapter5/5-8.html" class="sidebar-link">5.8 parse之生成AST（4）</a></li><li><a href="/./main/chapter5/5-9.html" class="sidebar-link">5.9 parse之生成AST（5）</a></li><li><a href="/./main/chapter5/5-10.html" class="sidebar-link">5.10 optimize优化</a></li><li><a href="/./main/chapter5/5-11.html" class="sidebar-link">5.11 generate代码生成（1）</a></li><li><a href="/./main/chapter5/5-12.html" class="sidebar-link">5.12 generate代码生成（2）</a></li><li><a href="/./main/chapter5/5-13.html" class="sidebar-link">5.13 generate代码生成（3）</a></li><li><a href="/./main/chapter5/5-14.html" class="sidebar-link">5.14 generate代码生成（4）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>第六章 扩展</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter6/6-1.html" class="sidebar-link">6.1 events（1）</a></li><li><a href="/./main/chapter6/6-2.html" class="sidebar-link">6.2 events（2）</a></li><li><a href="/./main/chapter6/6-3.html" class="sidebar-link">6.3 events（3）</a></li><li><a href="/./main/chapter6/6-4.html" class="sidebar-link">6.4 events（4）</a></li><li><a href="/./main/chapter6/6-5.html" class="sidebar-link">6.5 v-model（1）</a></li><li><a href="/./main/chapter6/6-6.html" class="sidebar-link">6.6 v-model（2）</a></li><li><a href="/./main/chapter6/6-7.html" class="sidebar-link">6.7v-model（3）</a></li><li><a href="/./main/chapter6/6-8.html" class="sidebar-link">6.8v-model（4）</a></li><li><a href="/./main/chapter6/6-9.html" class="sidebar-link">6.9 slot（上）</a></li><li><a href="/./main/chapter6/6-10.html" class="sidebar-link">6.10 slot（中）</a></li><li><a href="/./main/chapter6/6-11.html" aria-current="page" class="active sidebar-link">6.11 slot（下）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第七章 内置组件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter7/7-1.html" class="sidebar-link">7.1 keep-alive（上）</a></li><li><a href="/./main/chapter7/7-2.html" class="sidebar-link">7.2 keep-alive（下）</a></li><li><a href="/./main/chapter7/7-3.html" class="sidebar-link">7.3 transition（上）</a></li><li><a href="/./main/chapter7/7-4.html" class="sidebar-link">7.4 transition（中）</a></li><li><a href="/./main/chapter7/7-5.html" class="sidebar-link">7.5 transition（下）</a></li><li><a href="/./main/chapter7/7-6.html" class="sidebar-link">7.6 transition-group</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第八章 Vue-router</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter8/8-1.html" class="sidebar-link">8.1 vue-router的注册</a></li><li><a href="/./main/chapter8/8-2.html" class="sidebar-link">8.2 VueRouter实例化</a></li><li><a href="/./main/chapter8/8-3.html" class="sidebar-link">8.3 动态路由</a></li><li><a href="/./main/chapter8/8-4.html" class="sidebar-link">8.4 match</a></li><li><a href="/./main/chapter8/8-5.html" class="sidebar-link">8.5 导航守卫（上）</a></li><li><a href="/./main/chapter8/8-6.html" class="sidebar-link">8.6 导航守卫（中）</a></li><li><a href="/./main/chapter8/8-7.html" class="sidebar-link">8.7 导航守卫（下）</a></li><li><a href="/./main/chapter8/8-8.html" class="sidebar-link">8.8 路径切换</a></li><li><a href="/./main/chapter8/8-9.html" class="sidebar-link">8.9 router-view组件</a></li><li><a href="/./main/chapter8/8-10.html" class="sidebar-link">8.10 router-link组件</a></li><li><a href="/./main/chapter8/8-11.html" class="sidebar-link">8.11 history模式</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_6-11-slot-下"><a href="#_6-11-slot-下" class="header-anchor">#</a> 6.11 slot（下）</h1> <p>  这个小节我们来分析作用域插槽的运行时实现。在<code>render</code>函数执行时会调用我们上小节生成的代码，在生成<code>child.data.scopedSlots</code>属性时会调用<code>_u</code>函数，下面我们就来看看<code>_u</code>的定义</p> <div class="language-js extra-class"><pre class="language-js"><code>  target<span class="token punctuation">.</span>_u <span class="token operator">=</span> resolveScopedSlots
</code></pre></div><p><code>_u</code>函数实际上是<code>resolveScopedSlots</code>方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolveScopedSlots</span> <span class="token punctuation">(</span>
  <span class="token literal-property property">fns</span><span class="token operator">:</span> ScopedSlotsData<span class="token punctuation">,</span> <span class="token comment">// see flow/vnode</span>
  res<span class="token operator">?</span><span class="token operator">:</span> Object<span class="token punctuation">,</span>
  <span class="token comment">// the following are added in 2.6</span>
  hasDynamicKeys<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  contentHashKey<span class="token operator">?</span><span class="token operator">:</span> number
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> Function<span class="token punctuation">,</span> <span class="token literal-property property">$stable</span><span class="token operator">:</span> boolean <span class="token punctuation">}</span> <span class="token punctuation">{</span>
  res <span class="token operator">=</span> res <span class="token operator">||</span> <span class="token punctuation">{</span> <span class="token literal-property property">$stable</span><span class="token operator">:</span> <span class="token operator">!</span>hasDynamicKeys <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> fns<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> slot <span class="token operator">=</span> fns<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resolveScopedSlots</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> res<span class="token punctuation">,</span> hasDynamicKeys<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>slot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// marker for reverse proxying v-slot without scope on this.$slots</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>slot<span class="token punctuation">.</span>proxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        slot<span class="token punctuation">.</span>fn<span class="token punctuation">.</span>proxy <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
      res<span class="token punctuation">[</span>slot<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> slot<span class="token punctuation">.</span>fn
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>contentHashKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>res<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>$key <span class="token operator">=</span> contentHashKey
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre></div><p>  如果没有传入第二个参数<code>res</code>，那么就初始化<code>res</code>，初始化的<code>res</code>有一个参数<code>$stable</code>，也是就标识是否稳固的，它是由第三个参数取反得到的。<br>
  然后会遍历<code>fns</code>数组，然后遍历<code>fns</code>，如果得到的结果还是一个数组的话就递归调用<code>resolveScopedSlots</code>，这种复杂的情况我们就不去讨论了。<br>
  这里如果判断<code>slot.proxy</code>则给<code>slot.fn.proxy</code>设置为<code>true</code>。这是新语法的内容，我们之后再来分析。<br>
  然后将对应<code>key</code>和<code>fn</code>添加到<code>res</code>中，这里我们<code>slot.key</code>为<code>one</code>，<code>fn</code>则是我们上面代码生成的函数<code>fn:function(scope){return _c('div',{},[_v(_s(scope.data))])}</code>。<br>
  可以看到这个函数接收了<code>scope</code>参数，然后内部又返回一个<code>_c</code>函数的调用，其实不难猜测，这个函数会在子组件渲染时调用，然后通过子组件传入<code>scope</code>，那么就能实现使用子组件中数据的目的。但是这个函数作用域还是父组件的，所以访问<code>scope</code>以外的数据会向上寻找，去找父组件<code>child</code>中的<code>data</code>数据。接下来我们去验证一下我们的猜想吧！<br>
  继续把这个函数分析完，最后判断<code>contentHashKey</code>是否存在，也就是我们的第四个参数，这是一个作用域插槽的密钥，会保存到<code>res.$key</code>中，这个东西我们就不深入研究了。最后会返回<code>res</code>，也就是<code>child.data.scopedSlots</code>就等于<code>res</code>。<br>
  最后<code>res</code>其实就是<code>{ $stable: true, one: fn }</code>。<br>
  上面其实是我们父组件<code>render</code>过程会执行的内容，下面我们来看子组件的调用<code>vm._render</code>时会发生什么。<br>
  在子组件调用<code>vm._render</code>函数时会标准化<code>scopedSlots</code></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>_parentVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>$scopedSlots <span class="token operator">=</span> <span class="token function">normalizeScopedSlots</span><span class="token punctuation">(</span>
      _parentVnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>scopedSlots<span class="token punctuation">,</span>
      vm<span class="token punctuation">.</span>$slots<span class="token punctuation">,</span>
      vm<span class="token punctuation">.</span>$scopedSlots
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  这个我们之前简单分析过一部分，现在我们就来把这部分内容补充完整，这个时候我们传入的第一个参数<code>_parentVnode.data.scopedSlots</code>是存在的，就是我们上面的<code>res</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">normalizeScopedSlots</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">slots</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> Function <span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  <span class="token literal-property property">normalSlots</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  prevSlots<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> Function <span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token keyword">void</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span>
  <span class="token keyword">let</span> res
  <span class="token keyword">const</span> hasNormalSlots <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>normalSlots<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span>
  <span class="token keyword">const</span> isStable <span class="token operator">=</span> slots <span class="token operator">?</span> <span class="token operator">!</span><span class="token operator">!</span>slots<span class="token punctuation">.</span>$stable <span class="token operator">:</span> <span class="token operator">!</span>hasNormalSlots
  <span class="token keyword">const</span> key <span class="token operator">=</span> slots <span class="token operator">&amp;&amp;</span> slots<span class="token punctuation">.</span>$key
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>slots<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>slots<span class="token punctuation">.</span>_normalized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> slots<span class="token punctuation">.</span>_normalized
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
    isStable <span class="token operator">&amp;&amp;</span>
    prevSlots <span class="token operator">&amp;&amp;</span>
    prevSlots <span class="token operator">!==</span> emptyObject <span class="token operator">&amp;&amp;</span>
    key <span class="token operator">===</span> prevSlots<span class="token punctuation">.</span>$key <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>hasNormalSlots <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>prevSlots<span class="token punctuation">.</span>$hasNormal
    <span class="token keyword">return</span> prevSlots<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    res <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> slots<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>slots<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'$'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">normalizeScopedSlot</span><span class="token punctuation">(</span>normalSlots<span class="token punctuation">,</span> key<span class="token punctuation">,</span> slots<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>slots <span class="token operator">&amp;&amp;</span> Object<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>slots<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>slots<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>_normalized <span class="token operator">=</span> res
  <span class="token punctuation">}</span>
  <span class="token function">def</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">'$stable'</span><span class="token punctuation">,</span> isStable<span class="token punctuation">)</span>
  <span class="token function">def</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">'$key'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token function">def</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">'$hasNormal'</span><span class="token punctuation">,</span> hasNormalSlots<span class="token punctuation">)</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre></div><p>  这里<code>hasNormalSlots</code>为<code>false</code>、<code>isStable</code>为<code>true</code>，<code>key</code>为<code>undefined</code>，这里的<code>prevSlots</code>是等于<code>emptyObject</code>的。<code>slots._normalized</code>也是不存在的，所以直接会进入<code>else</code>逻辑。<br>
  else逻辑会遍历<code>slots</code>对象，然后判断<code>key[0]</code>不能等于<code>$</code>，也就是只去获取我们插槽名的<code>key</code>，像我们定义的<code>$stable</code>则忽略。然后会调用<code>normalizeScopedSlot</code>方法处理：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">normalizeScopedSlot</span><span class="token punctuation">(</span><span class="token parameter">normalSlots<span class="token punctuation">,</span> key<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">normalized</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
 <span class="token comment">// 这是一个使用新V-slot语法没有作用域的插槽，尽管它被编译为作用域插槽，但渲染函数用户仍期望它出现在this.$slots上，因为这种用法在语义上是一个正常的插槽</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token punctuation">.</span>proxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>normalSlots<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">get</span><span class="token operator">:</span> normalized<span class="token punctuation">,</span>
      <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> normalized
<span class="token punctuation">}</span>
</code></pre></div><p>  定义一个<code>normalized</code>函数，最后返回，如果<code>fn.proxy</code>存在，则会给<code>normalSlots</code>中添加插槽名属性，并且其<code>get</code>函数为<code>normalized</code>，我们看<code>normalized</code>函数</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> res <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  res <span class="token operator">=</span> res <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> res <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token operator">?</span> <span class="token punctuation">[</span>res<span class="token punctuation">]</span> <span class="token comment">// single vnode</span>
    <span class="token operator">:</span> <span class="token function">normalizeChildren</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token keyword">let</span> <span class="token literal-property property">vnode</span><span class="token operator">:</span> <span class="token operator">?</span>VNode <span class="token operator">=</span> res <span class="token operator">&amp;&amp;</span> res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">return</span> res <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span>vnode <span class="token operator">||</span>
    <span class="token punctuation">(</span>res<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> vnode<span class="token punctuation">.</span>isComment <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isAsyncPlaceholder</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// #9658, #10391</span>
  <span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">undefined</span>
    <span class="token operator">:</span> res
</code></pre></div><p>  首先如果传入参数的话就调用<code>fn</code>并将参数都传入，如果没有参数就给<code>fn</code>传入一个空对象。<code>fn</code>就是我们生成作用域插槽内容<code>vnode</code>的函数。<code>arguments</code>就是我们子组件想要传给父组件的数据。<br>
  然后判断生成的<code>vnode</code>如果是对象而不是一个数组，那么就将它包裹在一个数组中，如果是一个数组的话需要调用<code>normalizeChildren</code>对标准化。这个函数我们早就分析过了，这里就不赘述了。<br>
  然后定义<code>vnode</code>变量保存<code>res[0]</code>。最后如果<code>vnode</code>不存在或者<code>res.length</code>为1并且是注释节点但不是异步组件的占位节点就返回<code>undefined</code>。正常情况则返回<code>res</code>，即生成的<code>vnode</code>数组。<br>
  但是<code>normalized</code>方法在这里不会调用，而是会返回给<code>normalizeScopedSlots</code>函数的<code>res[key]</code>，接下来如果<code>slots</code>是可扩展的，就给<code>slots._normalized</code>赋值为<code>res</code>。<br>
  最后<code>res</code>就会赋值给<code>vm.$scopedSlots</code>，然后调用<code>render</code>函数时，子组件的<code>render</code>函数如下：<br> <code>_c('div',[_v(&quot;我是&quot;),_t(&quot;one&quot;,function(){return [_v(&quot;1&quot;)]},{&quot;data&quot;:&quot;子&quot;})],2)</code>。<br>
这里会执行<code>_t</code>方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> scopedSlotFn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$scopedSlots<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>scopedSlotFn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  props <span class="token operator">=</span> props <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  nodes <span class="token operator">=</span>
    <span class="token function">scopedSlotFn</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token punctuation">(</span><span class="token keyword">typeof</span> fallbackRender <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">fallbackRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> fallbackRender<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  然后这里<code>scopedSlotFn</code>其实就取到命名为<code>one</code>的插槽函数，也就是上面返回的<code>normalized</code>函数，然后这里就把我们传入的<code>props</code>，也就是<code>{ data: '子' }</code>给传入了。然后<code>normalized</code>会将这个参数传入<code>fn</code>执行，也就是<code>fn</code>那边接收的形参<code>scope</code>，这样我们就能访问的<code>scope.data</code>了。这也验证了我们之前的猜想是完全正确的。
实际上作用插槽就是将生成<code>vnode</code>过程延时执行，因为插槽是定义在父组件的，但是父组件先不去<code>render</code>插槽内容，而是把其放到一个函数中存起来延时执行，这个函数作用域是父组件，但是会在子组件<code>render</code>时被调用生<code>vnode</code>，这个过程还会传入子组件的数据，使得其能用子组件的一部分数据。<br>
  接下来我们分析一下<code>slot</code>插槽的更新过程，在<code>updateChildComponent</code>函中有这样一段逻辑：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// determine whether component has slot children</span>
  <span class="token comment">// we need to do this before overwriting $options._renderChildren.</span>
  <span class="token comment">// 在覆盖$options._renderChildren之前，确定组件是否有slot子级</span>

  <span class="token comment">// check if there are dynamic scopedSlots (hand-written or compiled but with</span>
  <span class="token comment">// dynamic slot names). Static scoped slots compiled from template has the</span>
  <span class="token comment">// &quot;$stable&quot; marker.</span>
  <span class="token comment">// 检查是否存在动态作用域slot（手写或编译，但具有动态插槽名称）。</span>
  <span class="token comment">// 从模板编译的静态作用域插槽具有“$stable”标记</span>
  <span class="token keyword">const</span> newScopedSlots <span class="token operator">=</span> parentVnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>scopedSlots
  <span class="token keyword">const</span> oldScopedSlots <span class="token operator">=</span> vm<span class="token punctuation">.</span>$scopedSlots
  <span class="token keyword">const</span> hasDynamicScopedSlot <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>newScopedSlots <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newScopedSlots<span class="token punctuation">.</span>$stable<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token punctuation">(</span>oldScopedSlots <span class="token operator">!==</span> emptyObject <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>oldScopedSlots<span class="token punctuation">.</span>$stable<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token punctuation">(</span>newScopedSlots <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>$scopedSlots<span class="token punctuation">.</span>$key <span class="token operator">!==</span> newScopedSlots<span class="token punctuation">.</span>$key<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token punctuation">(</span><span class="token operator">!</span>newScopedSlots <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>$scopedSlots<span class="token punctuation">.</span>$key<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

  <span class="token comment">// Any static slot children from the parent may have changed during parent's</span>
  <span class="token comment">// update. Dynamic scoped slots may also have changed. In such cases, a forced</span>
  <span class="token comment">// update is necessary to ensure correctness.</span>
  <span class="token comment">// 在父级更新期间，父级的任何静态插槽子级可能已更改。动态作用域插槽也可能已更改。</span>
  <span class="token comment">// 在这种情况下，需要强制更新以确保正确性</span>
  <span class="token keyword">const</span> needsForceUpdate <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>
    renderChildren <span class="token operator">||</span>               <span class="token comment">// has new static slots</span>
    vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_renderChildren <span class="token operator">||</span>  <span class="token comment">// has old static slots</span>
    hasDynamicScopedSlot
  <span class="token punctuation">)</span>
  vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_renderChildren <span class="token operator">=</span> renderChildren
</code></pre></div><p>会判断是否有动态内容的插槽</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// resolve slots + force update if has children</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>needsForceUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>$slots <span class="token operator">=</span> <span class="token function">resolveSlots</span><span class="token punctuation">(</span>renderChildren<span class="token punctuation">,</span> parentVnode<span class="token punctuation">.</span>context<span class="token punctuation">)</span>
    vm<span class="token punctuation">.</span><span class="token function">$forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  最后判断需要强制更新的话重新处理<code>vm.$slots</code>，然后调用强制更新。<br>
  下面我们来说一下什么是传统语法，什么是新语法。在2.6.x之后更新了一种全新的语法<code>v-slot</code>指令。这个指令好处在于实现插槽的统一，有这个指令我们就不需要<code>slot</code>和<code>slot-scope</code>了，我们上面的例子可以写成这样</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span> child <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;child&gt;
    &lt;template v-slot:one=&quot;scope&quot;&gt;{{ scope.data }}&lt;/template&gt;
  &lt;/child&gt;</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>  这和我们之前的<code>demo</code>是等价的，但是<code>v-slot</code>只能在<code>template</code>上使用，只有一种情况例外，就是只有默认插槽时可以将其写到组件上。<br>
  我们先来看<code>v-slot</code>的<code>parse</code>阶段逻辑，在之前分析<code>processSlotContent</code>时我们已经提到过<code>v-slot</code>，但是我们没有继续往下分析，现在我们来看这部分逻辑</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'template'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// v-slot on &lt;template&gt;</span>
    <span class="token keyword">const</span> slotBinding <span class="token operator">=</span> <span class="token function">getAndRemoveAttrByRegex</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> slotRE<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>slotBinding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>slotTarget <span class="token operator">||</span> el<span class="token punctuation">.</span>slotScope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unexpected mixed usage of different slot syntaxes.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            el
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>parent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">maybeComponent</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;template v-slot&gt; can only appear at the root level inside </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">the receiving component</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            el
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> dynamic <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getSlotName</span><span class="token punctuation">(</span>slotBinding<span class="token punctuation">)</span>
      el<span class="token punctuation">.</span>slotTarget <span class="token operator">=</span> name
      el<span class="token punctuation">.</span>slotTargetDynamic <span class="token operator">=</span> dynamic
      el<span class="token punctuation">.</span>slotScope <span class="token operator">=</span> slotBinding<span class="token punctuation">.</span>value <span class="token operator">||</span> emptySlotScopeToken <span class="token comment">// force it into a scoped slot for perf</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  如果是<code>template</code>标签的话执行if逻辑，首先要去获取<code>slotBinding</code>，这里使用了一个不同的方法去提取属性</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getAndRemoveAttrByRegex</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement<span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> RegExp</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> list <span class="token operator">=</span> el<span class="token punctuation">.</span>attrsList
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> attr <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>attr<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> attr
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  就是去<code>el.attrsList</code>中寻找<code>v-slot</code>指令，如果找到就把它从数组删除，最后返回这个属性对象。<br>
  接下来会做一个校验，如果我们<code>el.slotTarget || el.slotScope</code>为<code>true</code>的话，说明我们其实是混用了语法，这就要报一个警告了。所以我们要用新语法就都用新语法，不要新旧语法一起混用。<br>
  接下来还会判断父组件是否是组件，如果不是的话也会报一个警告，事实上我们应该直接在父组件下使用插槽，在插槽外面包裹其它内容是没有什么必要的。<br>
  接下来通过<code>getSlotName</code>方法去获取<code>name</code>和<code>dynamic</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getSlotName</span> <span class="token punctuation">(</span><span class="token parameter">binding</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> name <span class="token operator">=</span> binding<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>slotRE<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>binding<span class="token punctuation">.</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'#'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      name <span class="token operator">=</span> <span class="token string">'default'</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">v-slot shorthand syntax requires a slot name.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        binding
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> dynamicArgRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token comment">// dynamic [name]</span>
    <span class="token operator">?</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> name<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">dynamic</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
    <span class="token comment">// static name</span>
    <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token literal-property property">dynamic</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  这个方法太简单了，我们就不去一一分析了。<br>
  然后会将<code>name</code>赋值给<code>el.slotTarget</code>，<code>dynamic</code>赋值给<code>el.slotTargetDynamic</code>，<code>slotBinding.value</code>赋值给<code>el.slotScope</code>，如果不存在value就赋值为<code>_empty_</code>。这个值我们之前见过了。在<code>genScopedSlot</code> 中就有这个判断。实际上后续过程和旧语法过程也是基本一致的。不同的是这里<code>el.slotScope</code>会有一个默认值。<br>
在<code>genScopedSlot</code>中</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> isLegacySyntax <span class="token operator">=</span> el<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span><span class="token string">'slot-scope'</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> slotScope <span class="token operator">=</span> el<span class="token punctuation">.</span>slotScope <span class="token operator">===</span> emptySlotScopeToken
    <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>
    <span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>slotScope<span class="token punctuation">)</span>
  <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>slotScope<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">){</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'template'</span>
      <span class="token operator">?</span>  <span class="token function">genChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'undefined'</span>
      <span class="token operator">:</span> <span class="token function">genElement</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">`</span></span>
  <span class="token comment">// reverse proxy v-slot without scope on this.$slots</span>
  <span class="token keyword">const</span> reverseProxy <span class="token operator">=</span> slotScope <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,proxy:true</span><span class="token template-punctuation string">`</span></span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{key:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>slotTarget <span class="token operator">||</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;default&quot;</span><span class="token template-punctuation string">`</span></span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,fn:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fn<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reverseProxy<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><p>  如果没有定义作用域插槽，这里会把<code>el.slotScope</code>重置为空，然后还会添加一个<code>,proxy:true</code>，然后我们<code>resolveScopedSlots</code>会给<code>fn</code>做一个标记，之后在标准化函数中<code>normalizeScopedSlot</code>如果发现<code>fn.proxy</code>为<code>true</code>的话</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token punctuation">.</span>proxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>normalSlots<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">get</span><span class="token operator">:</span> normalized<span class="token punctuation">,</span>
      <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  把它添加到<code>vm.$slots</code>上，这就符合预期了，因为实际上使用<code>v-slot</code>时即使不使用作用域变量也会当成作用域插槽处理的，但是实际上它应该和普通插槽一样在vm.$slots中被管理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// v-slot on component, denotes default slot</span>
  <span class="token keyword">const</span> slotBinding <span class="token operator">=</span> <span class="token function">getAndRemoveAttrByRegex</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> slotRE<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>slotBinding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">maybeComponent</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">v-slot can only be used on components or &lt;template&gt;.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          slotBinding
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>slotScope <span class="token operator">||</span> el<span class="token punctuation">.</span>slotTarget<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unexpected mixed usage of different slot syntaxes.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          el
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>scopedSlots<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">To avoid scope ambiguity, the default slot should also use </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;template&gt; syntax when there are other named slots.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          slotBinding
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// add the component's children to its default slot</span>
    <span class="token keyword">const</span> slots <span class="token operator">=</span> el<span class="token punctuation">.</span>scopedSlots <span class="token operator">||</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>scopedSlots <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> dynamic <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getSlotName</span><span class="token punctuation">(</span>slotBinding<span class="token punctuation">)</span>
    <span class="token keyword">const</span> slotContainer <span class="token operator">=</span> slots<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createASTElement</span><span class="token punctuation">(</span><span class="token string">'template'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> el<span class="token punctuation">)</span>
    slotContainer<span class="token punctuation">.</span>slotTarget <span class="token operator">=</span> name
    slotContainer<span class="token punctuation">.</span>slotTargetDynamic <span class="token operator">=</span> dynamic
    slotContainer<span class="token punctuation">.</span>children <span class="token operator">=</span> el<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">c</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>c<span class="token punctuation">.</span>slotScope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>parent <span class="token operator">=</span> slotContainer
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    slotContainer<span class="token punctuation">.</span>slotScope <span class="token operator">=</span> slotBinding<span class="token punctuation">.</span>value <span class="token operator">||</span> emptySlotScopeToken
    <span class="token comment">// remove children as they are returned from scopedSlots now</span>
    el<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// mark el non-plain so data gets generated</span>
    el<span class="token punctuation">.</span>plain <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  最后如果不是在<code>template</code>使用时的<code>parse</code>如上。如果不是在组件上使用直接报一个警告。然后还是对混用语法报一个警告。<br>
  接下来是判断<code>el.scopedSlots</code>是否存在，我们知道组件的<code>el</code>存在<code>scopedSlots</code>说明其内部有具名插槽，我们组件上使用<code>v-slot</code>只能是只有一个默认插槽的情况，这种既使用简写又在内部写具名插槽是官网明确禁止的。
然后正常逻辑是初始化<code>el.scopedSlots</code>，获取<code>name</code>。然后创建一个<code>template</code>元素，再将插槽的内容都添加到<code>template</code>的<code>el</code>上，然后将子元素都添加到<code>template</code>下，这样其实就和我们写<code>template</code>效果是一样的。<br>
  以上就我们插槽的全部内容了。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/./main/chapter6/6-10.html" class="prev">
        6.10 slot（中）
      </a></span> <span class="next"><a href="/./main/chapter7/7-1.html">
        7.1 keep-alive（上）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.cb86b5c8.js" defer></script><script src="./assets/js/2.8a65079d.js" defer></script><script src="./assets/js/60.9a43de0b.js" defer></script>
  </body>
</html>

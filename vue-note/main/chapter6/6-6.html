<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>6.6 v-model（2） | 卷心菜笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="./logo.jpg">
    <meta name="description" content="基于vue@2.6.14的学习笔记">
    
    <link rel="preload" href="./assets/css/0.styles.74c59701.css" as="style"><link rel="preload" href="./assets/js/app.20317d9d.js" as="script"><link rel="preload" href="./assets/js/2.8a65079d.js" as="script"><link rel="preload" href="./assets/js/65.6ca1c75b.js" as="script"><link rel="prefetch" href="./assets/js/10.3d2f32ec.js"><link rel="prefetch" href="./assets/js/11.132a26b4.js"><link rel="prefetch" href="./assets/js/12.d0193009.js"><link rel="prefetch" href="./assets/js/13.07872830.js"><link rel="prefetch" href="./assets/js/14.96a92186.js"><link rel="prefetch" href="./assets/js/15.89c1bf18.js"><link rel="prefetch" href="./assets/js/16.78f7cadf.js"><link rel="prefetch" href="./assets/js/17.eee5b860.js"><link rel="prefetch" href="./assets/js/18.e94d03e8.js"><link rel="prefetch" href="./assets/js/19.9e73c1ac.js"><link rel="prefetch" href="./assets/js/20.ae18bc8e.js"><link rel="prefetch" href="./assets/js/21.d4a5ba0b.js"><link rel="prefetch" href="./assets/js/22.e7794d4a.js"><link rel="prefetch" href="./assets/js/23.adaee962.js"><link rel="prefetch" href="./assets/js/24.e1df98bf.js"><link rel="prefetch" href="./assets/js/25.c325e810.js"><link rel="prefetch" href="./assets/js/26.c24daaf7.js"><link rel="prefetch" href="./assets/js/27.a3f09949.js"><link rel="prefetch" href="./assets/js/28.123d6383.js"><link rel="prefetch" href="./assets/js/29.04a6e255.js"><link rel="prefetch" href="./assets/js/3.5a34bef2.js"><link rel="prefetch" href="./assets/js/30.f976c0a7.js"><link rel="prefetch" href="./assets/js/31.60d2f4c4.js"><link rel="prefetch" href="./assets/js/32.6b2a5515.js"><link rel="prefetch" href="./assets/js/33.6b80e89d.js"><link rel="prefetch" href="./assets/js/34.ea39628f.js"><link rel="prefetch" href="./assets/js/35.4c14bc3d.js"><link rel="prefetch" href="./assets/js/36.5f2b7559.js"><link rel="prefetch" href="./assets/js/37.57e976da.js"><link rel="prefetch" href="./assets/js/38.191568b8.js"><link rel="prefetch" href="./assets/js/39.f89500e6.js"><link rel="prefetch" href="./assets/js/4.9fb18247.js"><link rel="prefetch" href="./assets/js/40.a45a4a21.js"><link rel="prefetch" href="./assets/js/41.94ece143.js"><link rel="prefetch" href="./assets/js/42.224304d2.js"><link rel="prefetch" href="./assets/js/43.544241cd.js"><link rel="prefetch" href="./assets/js/44.6014c885.js"><link rel="prefetch" href="./assets/js/45.711ad2c3.js"><link rel="prefetch" href="./assets/js/46.19b76064.js"><link rel="prefetch" href="./assets/js/47.0a8f7a4f.js"><link rel="prefetch" href="./assets/js/48.da28ae74.js"><link rel="prefetch" href="./assets/js/49.97615384.js"><link rel="prefetch" href="./assets/js/5.0c239c66.js"><link rel="prefetch" href="./assets/js/50.06bd69e2.js"><link rel="prefetch" href="./assets/js/51.ea943f69.js"><link rel="prefetch" href="./assets/js/52.b4813218.js"><link rel="prefetch" href="./assets/js/53.c1ba1696.js"><link rel="prefetch" href="./assets/js/54.e1d1801c.js"><link rel="prefetch" href="./assets/js/55.ac7cd0ab.js"><link rel="prefetch" href="./assets/js/56.d55c7dcb.js"><link rel="prefetch" href="./assets/js/57.83bbfc8e.js"><link rel="prefetch" href="./assets/js/58.6996ec46.js"><link rel="prefetch" href="./assets/js/59.42c770e8.js"><link rel="prefetch" href="./assets/js/6.0600552c.js"><link rel="prefetch" href="./assets/js/60.919088d2.js"><link rel="prefetch" href="./assets/js/61.455d2404.js"><link rel="prefetch" href="./assets/js/62.40ba97a6.js"><link rel="prefetch" href="./assets/js/63.5b069dba.js"><link rel="prefetch" href="./assets/js/64.512e158a.js"><link rel="prefetch" href="./assets/js/66.0356130d.js"><link rel="prefetch" href="./assets/js/67.93a0d7df.js"><link rel="prefetch" href="./assets/js/68.7e44cc19.js"><link rel="prefetch" href="./assets/js/69.788a4d27.js"><link rel="prefetch" href="./assets/js/7.6346a45d.js"><link rel="prefetch" href="./assets/js/70.571f8a79.js"><link rel="prefetch" href="./assets/js/71.f54eb805.js"><link rel="prefetch" href="./assets/js/72.02cd77d0.js"><link rel="prefetch" href="./assets/js/73.66b6b1d0.js"><link rel="prefetch" href="./assets/js/74.96bf5acc.js"><link rel="prefetch" href="./assets/js/75.1b135bdd.js"><link rel="prefetch" href="./assets/js/76.6ed173f1.js"><link rel="prefetch" href="./assets/js/77.ee856c8d.js"><link rel="prefetch" href="./assets/js/78.b8fc2c30.js"><link rel="prefetch" href="./assets/js/79.7665732d.js"><link rel="prefetch" href="./assets/js/8.6ff51652.js"><link rel="prefetch" href="./assets/js/80.03e59e67.js"><link rel="prefetch" href="./assets/js/81.a6236c2f.js"><link rel="prefetch" href="./assets/js/82.88a5092b.js"><link rel="prefetch" href="./assets/js/83.e93ce178.js"><link rel="prefetch" href="./assets/js/84.8eb37a19.js"><link rel="prefetch" href="./assets/js/85.9d8d91db.js"><link rel="prefetch" href="./assets/js/86.14696351.js"><link rel="prefetch" href="./assets/js/87.51a4cddc.js"><link rel="prefetch" href="./assets/js/88.5cb86311.js"><link rel="prefetch" href="./assets/js/89.11fe5589.js"><link rel="prefetch" href="./assets/js/9.aaa202b7.js"><link rel="prefetch" href="./assets/js/90.b3555572.js">
    <link rel="stylesheet" href="./assets/css/0.styles.74c59701.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><!----> <span class="site-name">卷心菜笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./main/" class="nav-link router-link-active">
  正文
</a></div><div class="nav-item"><a href="/./appendix/mergeOptions.html" class="nav-link">
  附录
</a></div><div class="nav-item"><a href="/./util/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/w781223592/vue2.0-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/./main/" class="nav-link router-link-active">
  正文
</a></div><div class="nav-item"><a href="/./appendix/mergeOptions.html" class="nav-link">
  附录
</a></div><div class="nav-item"><a href="/./util/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/w781223592/vue2.0-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/./main/" aria-current="page" class="sidebar-link">前言</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第一章 初识Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter1/1-1.html" class="sidebar-link">1.1 Vue目录设计</a></li><li><a href="/./main/chapter1/1-2.html" class="sidebar-link">1.2 Vue入口文件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第二章 Vue初始化和挂载</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter2/2-1.html" class="sidebar-link">2.1 new Vue()时做了什么</a></li><li><a href="/./main/chapter2/2-2.html" class="sidebar-link">2.2 Vue实例挂载的实现</a></li><li><a href="/./main/chapter2/2-3.html" class="sidebar-link">2.3 Vue挂载时的mountComponent</a></li><li><a href="/./main/chapter2/2-4.html" class="sidebar-link">2.4 Virtual DOM</a></li><li><a href="/./main/chapter2/2-5.html" class="sidebar-link">2.5 最终的挂载方法_update</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第三章 组件化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter3/3-1.html" class="sidebar-link">3.1 创建组件vnode</a></li><li><a href="/./main/chapter3/3-2.html" class="sidebar-link">3.2 组件的patch过程</a></li><li><a href="/./main/chapter3/3-3.html" class="sidebar-link">3.3 合并配置</a></li><li><a href="/./main/chapter3/3-4.html" class="sidebar-link">3.4 生命周期（上）</a></li><li><a href="/./main/chapter3/3-5.html" class="sidebar-link">3.5 生命周期（下）</a></li><li><a href="/./main/chapter3/3-6.html" class="sidebar-link">3.6 组件的注册</a></li><li><a href="/./main/chapter3/3-7.html" class="sidebar-link">3.7 异步组件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第四章 响应式原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter4/4-1.html" class="sidebar-link">4.1 响应式对象</a></li><li><a href="/./main/chapter4/4-2.html" class="sidebar-link">4.2 依赖收集（上）</a></li><li><a href="/./main/chapter4/4-3.html" class="sidebar-link">4.3 依赖收集（下）</a></li><li><a href="/./main/chapter4/4-4.html" class="sidebar-link">4.4 派发更新</a></li><li><a href="/./main/chapter4/4-5.html" class="sidebar-link">4.5 nextTick</a></li><li><a href="/./main/chapter4/4-6.html" class="sidebar-link">4.6 检测变化的坑</a></li><li><a href="/./main/chapter4/4-7.html" class="sidebar-link">4.7 计算属性</a></li><li><a href="/./main/chapter4/4-8.html" class="sidebar-link">4.8 侦听器</a></li><li><a href="/./main/chapter4/4-9.html" class="sidebar-link">4.9 组件更新</a></li><li><a href="/./main/chapter4/4-10.html" class="sidebar-link">4.10 diff算法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第五章 编译</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter5/5-1.html" class="sidebar-link">5.1 初探编译器</a></li><li><a href="/./main/chapter5/5-2.html" class="sidebar-link">5.2 从入口开始</a></li><li><a href="/./main/chapter5/5-3.html" class="sidebar-link">5.3 parse之解析模板（上）</a></li><li><a href="/./main/chapter5/5-4.html" class="sidebar-link">5.4 parse之解析模板（下）</a></li><li><a href="/./main/chapter5/5-5.html" class="sidebar-link">5.5 parse之生成AST（1）</a></li><li><a href="/./main/chapter5/5-6.html" class="sidebar-link">5.6 parse之生成AST（2）</a></li><li><a href="/./main/chapter5/5-7.html" class="sidebar-link">5.7 parse之生成AST（3）</a></li><li><a href="/./main/chapter5/5-8.html" class="sidebar-link">5.8 parse之生成AST（4）</a></li><li><a href="/./main/chapter5/5-9.html" class="sidebar-link">5.9 parse之生成AST（5）</a></li><li><a href="/./main/chapter5/5-10.html" class="sidebar-link">5.10 optimize优化</a></li><li><a href="/./main/chapter5/5-11.html" class="sidebar-link">5.11 generate代码生成（1）</a></li><li><a href="/./main/chapter5/5-12.html" class="sidebar-link">5.12 generate代码生成（2）</a></li><li><a href="/./main/chapter5/5-13.html" class="sidebar-link">5.13 generate代码生成（3）</a></li><li><a href="/./main/chapter5/5-14.html" class="sidebar-link">5.14 generate代码生成（4）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>第六章 扩展</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter6/6-1.html" class="sidebar-link">6.1 events（1）</a></li><li><a href="/./main/chapter6/6-2.html" class="sidebar-link">6.2 events（2）</a></li><li><a href="/./main/chapter6/6-3.html" class="sidebar-link">6.3 events（3）</a></li><li><a href="/./main/chapter6/6-4.html" class="sidebar-link">6.4 events（4）</a></li><li><a href="/./main/chapter6/6-5.html" class="sidebar-link">6.5 v-model（1）</a></li><li><a href="/./main/chapter6/6-6.html" aria-current="page" class="active sidebar-link">6.6 v-model（2）</a></li><li><a href="/./main/chapter6/6-7.html" class="sidebar-link">6.7 v-model（3）</a></li><li><a href="/./main/chapter6/6-8.html" class="sidebar-link">6.8 v-model（4）</a></li><li><a href="/./main/chapter6/6-9.html" class="sidebar-link">6.9 slot（上）</a></li><li><a href="/./main/chapter6/6-10.html" class="sidebar-link">6.10 slot（中）</a></li><li><a href="/./main/chapter6/6-11.html" class="sidebar-link">6.11 slot（下）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第七章 内置组件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter7/7-1.html" class="sidebar-link">7.1 keep-alive（上）</a></li><li><a href="/./main/chapter7/7-2.html" class="sidebar-link">7.2 keep-alive（下）</a></li><li><a href="/./main/chapter7/7-3.html" class="sidebar-link">7.3 transition（上）</a></li><li><a href="/./main/chapter7/7-4.html" class="sidebar-link">7.4 transition（中）</a></li><li><a href="/./main/chapter7/7-5.html" class="sidebar-link">7.5 transition（下）</a></li><li><a href="/./main/chapter7/7-6.html" class="sidebar-link">7.6 transition-group</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第八章 Vue-router</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter8/8-1.html" class="sidebar-link">8.1 vue-router的注册</a></li><li><a href="/./main/chapter8/8-2.html" class="sidebar-link">8.2 VueRouter实例化</a></li><li><a href="/./main/chapter8/8-3.html" class="sidebar-link">8.3 动态路由</a></li><li><a href="/./main/chapter8/8-4.html" class="sidebar-link">8.4 match</a></li><li><a href="/./main/chapter8/8-5.html" class="sidebar-link">8.5 导航守卫（上）</a></li><li><a href="/./main/chapter8/8-6.html" class="sidebar-link">8.6 导航守卫（中）</a></li><li><a href="/./main/chapter8/8-7.html" class="sidebar-link">8.7 导航守卫（下）</a></li><li><a href="/./main/chapter8/8-8.html" class="sidebar-link">8.8 路径切换</a></li><li><a href="/./main/chapter8/8-9.html" class="sidebar-link">8.9 router-view组件</a></li><li><a href="/./main/chapter8/8-10.html" class="sidebar-link">8.10 router-link组件</a></li><li><a href="/./main/chapter8/8-11.html" class="sidebar-link">8.11 history模式</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_6-6-v-model-2"><a href="#_6-6-v-model-2" class="header-anchor">#</a> 6.6 v-model（2）</h1> <p>  上个小节我们分析了<code>v-model</code>的编译过程，这个小节我们来分析其运行时的过程，在我们<code>runtime</code>下的<code>patch.js</code>中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> nodeOps <span class="token keyword">from</span> <span class="token string">'web/runtime/node-ops'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createPatchFunction <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/vdom/patch'</span>
<span class="token keyword">import</span> baseModules <span class="token keyword">from</span> <span class="token string">'core/vdom/modules/index'</span>
<span class="token keyword">import</span> platformModules <span class="token keyword">from</span> <span class="token string">'web/runtime/modules/index'</span>

<span class="token comment">// the directive module should be applied last, after all</span>
<span class="token comment">// built-in modules have been applied.</span>
<span class="token keyword">const</span> modules <span class="token operator">=</span> platformModules<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>baseModules<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">patch</span><span class="token operator">:</span> Function <span class="token operator">=</span> <span class="token function">createPatchFunction</span><span class="token punctuation">(</span><span class="token punctuation">{</span> nodeOps<span class="token punctuation">,</span> modules <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>  这里会传入<code>modules</code>，这里<code>modules</code>是由平台化<code>modules</code>和<code>baseModules</code>合并而来的。这里<code>v-model</code>和我们之前事件处理其实是一致的，只不过我们之前事件处理方法定义在了平台化的<code>modules</code>中，而这里指令的处理则是放在通用的<code>modules</code>中。<br>
  通用的<code>modules</code>在<code>core/vdom/modules/index</code>中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> directives <span class="token keyword">from</span> <span class="token string">'./directives'</span>
<span class="token keyword">import</span> ref <span class="token keyword">from</span> <span class="token string">'./ref'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">[</span>
  ref<span class="token punctuation">,</span>
  directives
<span class="token punctuation">]</span>
</code></pre></div><p>  这里有个<code>directives</code>，我们来看它的逻辑</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">create</span><span class="token operator">:</span> updateDirectives<span class="token punctuation">,</span>
  <span class="token literal-property property">update</span><span class="token operator">:</span> updateDirectives<span class="token punctuation">,</span>
  <span class="token function-variable function">destroy</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">unbindDirectives</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vnode</span><span class="token operator">:</span> VNodeWithData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updateDirectives</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> emptyNode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  和我们事件<code>modules</code>一样，这里定义了三个<code>hook</code>钩子函数，而且都是去调用同一个函数<code>updateDirectives</code>，接下来我们看它的定义</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateDirectives</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">oldVnode</span><span class="token operator">:</span> VNodeWithData<span class="token punctuation">,</span> <span class="token literal-property property">vnode</span><span class="token operator">:</span> VNodeWithData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>directives <span class="token operator">||</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>directives<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_update</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这之前我们先看我们代码生成的结果</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;with(this){return _c('input',{directives:[{name:\&quot;model\&quot;,rawName:\&quot;v-model.trim\&quot;,value:(value),expression:\&quot;value\&quot;,modifiers:{\&quot;trim\&quot;:true}}],attrs:{\&quot;type\&quot;:\&quot;text\&quot;},domProps:{\&quot;value\&quot;:(value)},on:{\&quot;input\&quot;:function($event){if($event.target.composing)return;value=$event.target.value.trim()},\&quot;blur\&quot;:function($event){return $forceUpdate()}}})}&quot;</span>
</code></pre></div><p>  这里可以看到<code>data</code>里有<code>directives</code>指令，它是一个数组，保存了<code>model</code>的一些信息。这里我们如果判断新旧<code>vnode</code>中有一个有<code>directives</code>，那就执行<code>_update</code>方法，我来看这个方法执行了什么内容</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> isCreate <span class="token operator">=</span> oldVnode <span class="token operator">===</span> emptyNode
  <span class="token keyword">const</span> isDestroy <span class="token operator">=</span> vnode <span class="token operator">===</span> emptyNode
  <span class="token keyword">const</span> oldDirs <span class="token operator">=</span> <span class="token function">normalizeDirectives</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>directives<span class="token punctuation">,</span> oldVnode<span class="token punctuation">.</span>context<span class="token punctuation">)</span>
  <span class="token keyword">const</span> newDirs <span class="token operator">=</span> <span class="token function">normalizeDirectives</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>directives<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>context<span class="token punctuation">)</span>

  <span class="token keyword">const</span> dirsWithInsert <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> dirsWithPostpatch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre></div><p>  这里会根据新旧<code>vnode</code>的有无来判断是创建还是销毁。<br>
  然后会调用<code>normalizeDirectives</code>方法进行标准化事件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> emptyModifiers <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">normalizeDirectives</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">dirs</span><span class="token operator">:</span> <span class="token operator">?</span>Array<span class="token operator">&lt;</span>VNodeDirective<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">vm</span><span class="token operator">:</span> Component</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> VNodeDirective <span class="token punctuation">}</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// $flow-disable-line</span>
    <span class="token keyword">return</span> res
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> i<span class="token punctuation">,</span> dir
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dirs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dir <span class="token operator">=</span> dirs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dir<span class="token punctuation">.</span>modifiers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// $flow-disable-line</span>
      dir<span class="token punctuation">.</span>modifiers <span class="token operator">=</span> emptyModifiers
    <span class="token punctuation">}</span>
    res<span class="token punctuation">[</span><span class="token function">getRawDirName</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> dir
    dir<span class="token punctuation">.</span>def <span class="token operator">=</span> <span class="token function">resolveAsset</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">,</span> <span class="token string">'directives'</span><span class="token punctuation">,</span> dir<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// $flow-disable-line</span>
  <span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre></div><p>  如果没有<code>dirs</code>那么就直接<code>return</code>一个空对象。<br>
  遍历<code>dirs</code>数组，遍历结果用<code>dir</code>保存，如果不存在修饰符，那就将其设为空，这里会处理指令的名称</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getRawDirName</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">dir</span><span class="token operator">:</span> VNodeDirective</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">return</span> dir<span class="token punctuation">.</span>rawName <span class="token operator">||</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dir<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>dir<span class="token punctuation">.</span>modifiers <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
</code></pre></div><p>  会返回<code>dir.rawName</code>或者<code>dir.name</code>拼接修饰符的结果，将指令都按键值对形式存放到<code>res</code>对象中，然后会给<code>dir</code>添加一个<code>def</code>属性，<code>def</code>是由<code>resolveAsset</code>返回的结果。这个方法我们在3.6小节已经分析过了，只不过之前我们传入第二个参数<code>components</code>，而这里传入的是<code>directives</code>，然后就能取到在v<code>m.$options.directives</code>中的<code>model</code>指令，因为这里<code>dir.name</code>传入的是<code>model</code>，所以这里取到的是全局定义的<code>model</code>指令。最后这里会返回<code>res</code>。<br>
继续往下看<code>_update</code></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> key<span class="token punctuation">,</span> oldDir<span class="token punctuation">,</span> dir
  <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> newDirs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    oldDir <span class="token operator">=</span> oldDirs<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    dir <span class="token operator">=</span> newDirs<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// new directive, bind</span>
      <span class="token function">callHook</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token string">'bind'</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>def <span class="token operator">&amp;&amp;</span> dir<span class="token punctuation">.</span>def<span class="token punctuation">.</span>inserted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dirsWithInsert<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// existing directive, update</span>
      dir<span class="token punctuation">.</span>oldValue <span class="token operator">=</span> oldDir<span class="token punctuation">.</span>value
      dir<span class="token punctuation">.</span>oldArg <span class="token operator">=</span> oldDir<span class="token punctuation">.</span>arg
      <span class="token function">callHook</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token string">'update'</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>def <span class="token operator">&amp;&amp;</span> dir<span class="token punctuation">.</span>def<span class="token punctuation">.</span>componentUpdated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dirsWithPostpatch<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  这里<code>for</code>循环遍历<code>newDirs</code>，分别取到新旧节点的指令，然后接下来的if判断旧节点指令不存在的话就调用<code>callHook</code>方法，也就是添加指令逻辑</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">callHook</span> <span class="token punctuation">(</span><span class="token parameter">dir<span class="token punctuation">,</span> hook<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode<span class="token punctuation">,</span> isDestroy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fn <span class="token operator">=</span> dir<span class="token punctuation">.</span>def <span class="token operator">&amp;&amp;</span> dir<span class="token punctuation">.</span>def<span class="token punctuation">[</span>hook<span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode<span class="token punctuation">,</span> isDestroy<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>context<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">directive </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dir<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hook<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> hook</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  callHook方法定义非常简单，获取<code>dir.def</code>中传入的<code>hook</code>对应的钩子函数，这里传入的是<code>bind</code>，如果有<code>bind</code>函数的话就会执行<code>bind</code>钩子函数，没有定义的话就不会执行。我们要知道这里我们讲的是指令设计，并不单单局限于<code>v-model</code>。这里的<code>def</code>是什么我们后面会具体进行说明。<code>callHook</code>之后如果<code>dir.def.inserted</code>存在，就将<code>dir</code>添加到<code>dirsWithInsert</code>数组。<br>
  如果if不成立的话说明是更新逻辑，这里<code>arg</code>是<code>parse</code>时候添加的，比如<code>v-model:show</code>中<code>show</code>就是<code>arg</code>，也就是指令的参数，这个例子是<code>vue3</code>中<code>v-model</code>用法，一时间想不到合适的例子，所以借来用用，不要在vue2这么写。<br>
  这里会获取<code>arg</code>和<code>value</code>，然后调用<code>update hook</code>钩子。如果<code>dir.def</code>中存在<code>componentUpdated</code>那么会把<code>dir</code>添加到<code>dirsWithPostpatch</code>数组。<br>
然后继续往下看</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dirsWithInsert<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">callInsert</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dirsWithInsert<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callHook</span><span class="token punctuation">(</span>dirsWithInsert<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'inserted'</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isCreate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">mergeVNodeHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token string">'insert'</span><span class="token punctuation">,</span> callInsert<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">callInsert</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  如果<code>dirsWithInsert</code>数组不为空，那么会创建一个<code>callInsert</code>方法，这方法是用来遍历调用数组中指令对应的<code>inserted</code>钩子的。如果<code>isCreate</code>为<code>true</code>，说明是创建新节点过程，那么调用<code>mergeVNodeHook</code>方法将<code>callInsert</code>合并到<code>vnode</code>中<code>insert</code>钩子函数中一起调用。否则就直接调用<code>callInsert()</code>。<br>
然后继续往下</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dirsWithPostpatch<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">mergeVNodeHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> <span class="token string">'postpatch'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dirsWithPostpatch<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callHook</span><span class="token punctuation">(</span>dirsWithPostpatch<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'componentUpdated'</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  将<code>dirsWithPostpatch</code>中<code>'componentUpdated'</code>函数合并到<code>postpatch</code>中，等组件调用<code>postpatch</code>钩子时一起执行。<br>
  最后<code>_update</code>方法执行</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isCreate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> oldDirs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newDirs<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// no longer present, unbind</span>
        <span class="token function">callHook</span><span class="token punctuation">(</span>oldDirs<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'unbind'</span><span class="token punctuation">,</span> oldVnode<span class="token punctuation">,</span> oldVnode<span class="token punctuation">,</span> isDestroy<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  其实就是新节点没有的指令，但是旧节点有，说明指令要被移除，就调用指令定义的<code>unbind</code>钩子函数去移除。<br>
  说了这么多那么<code>dir.def</code>到底是个什么东西呢？其实我们上面说了它是全局注册的指令，那么我们就来看看这个<code>model</code>指令是怎么定义的吧!<br>
  model是一个平台化指令，定义在<code>web/runtime/directives/model.js</code>中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> directive <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">inserted</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">componentUpdated</span> <span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  可以看到它刚好<code>bind</code>和<code>update</code>方法都没有，而只有<code>componentUpdated</code>和<code>inserted</code>。我们也可以下看看另一个指令<code>v-show</code>指令的定义：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">bind</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token punctuation">{</span> value <span class="token punctuation">}</span><span class="token operator">:</span> VNodeDirective<span class="token punctuation">,</span> <span class="token literal-property property">vnode</span><span class="token operator">:</span> VNodeWithData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">update</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> oldValue <span class="token punctuation">}</span><span class="token operator">:</span> VNodeDirective<span class="token punctuation">,</span> <span class="token literal-property property">vnode</span><span class="token operator">:</span> VNodeWithData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">unbind</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  这就是我们正常的一个指令定义了，它具有<code>bind、update、unbind</code>方法。<br>
  接下来我们来看一下<code>mergeVNodeHook</code>方法，定义于<code>vdom/helpers/merge-hook</code>下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mergeVNodeHook</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">def</span><span class="token operator">:</span> Object<span class="token punctuation">,</span> <span class="token literal-property property">hookKey</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">hook</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>def <span class="token keyword">instanceof</span> <span class="token class-name">VNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    def <span class="token operator">=</span> def<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook <span class="token operator">||</span> <span class="token punctuation">(</span>def<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> invoker
  <span class="token keyword">const</span> oldHook <span class="token operator">=</span> def<span class="token punctuation">[</span>hookKey<span class="token punctuation">]</span>

  <span class="token keyword">function</span> <span class="token function">wrappedHook</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
    <span class="token comment">// important: remove merged hook to ensure it's called only once</span>
    <span class="token comment">// and prevent memory leak</span>
    <span class="token function">remove</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span>fns<span class="token punctuation">,</span> wrappedHook<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldHook<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// no existing hook</span>
    invoker <span class="token operator">=</span> <span class="token function">createFnInvoker</span><span class="token punctuation">(</span><span class="token punctuation">[</span>wrappedHook<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">/* istanbul ignore if */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldHook<span class="token punctuation">.</span>fns<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isTrue</span><span class="token punctuation">(</span>oldHook<span class="token punctuation">.</span>merged<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// already a merged invoker</span>
      invoker <span class="token operator">=</span> oldHook
      invoker<span class="token punctuation">.</span>fns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>wrappedHook<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span>fns<span class="token comment">// existing plain hook</span>
      invoker <span class="token operator">=</span> <span class="token function">createFnInvoker</span><span class="token punctuation">(</span><span class="token punctuation">[</span>oldHook<span class="token punctuation">,</span> wrappedHook<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  invoker<span class="token punctuation">.</span>merged <span class="token operator">=</span> <span class="token boolean">true</span>
  def<span class="token punctuation">[</span>hookKey<span class="token punctuation">]</span> <span class="token operator">=</span> invoker
<span class="token punctuation">}</span>
</code></pre></div><p>  首先这里会传入<code>def</code>也就是<code>vnode</code>，<code>hookKey</code>也就是<code>hook</code>名称，<code>hook</code>函数。<br>
  首先会判断<code>def</code>是否是<code>VNode</code>实例，如果是的话则会获取<code>def.data.hook</code>，我们知道只有组件vnode才必然有<code>data.hook</code>，而这里我们普通标签如果没有的话会初始化为一个空对象。</p> <div class="custom-block tip"><p class="custom-block-title">注意</p> <p>之前我提到一个我的认知错误，在这里会发现我们普通节点也可能会有hook。</p></div> <p>  接下来定义<code>invoker</code>，然后定义<code>oldHook</code>为<code>def</code>中对应的<code>hookKey</code>的函数，因为可能上面已经定义有该函数了。<br>
  接下来定义一个<code>wrappedHook</code>方法，这个方法会调用一次<code>hook</code>，然后调用<code>remove</code>方法将它从<code>invoker.fns</code>中删除，这里我们又见到了熟悉的<code>invoker.fns</code>。先继续往下看。<br>
  如果之前没有这个<code>hook</code>，那么就调用<code>createFnInvoker</code>方法创建<code>invoker</code>，这个方法相信不用我多说了吧，在<code>events</code>中我们就详细介绍过了，这里也调用了它，这是一种很好的事件管理机制。这里会把<code>wrappedHook</code>放在数组中传入，然后作为<code>invoker.fns</code>以供调用。<br>
  如果有相同名称的<code>hook</code>，就判断如果<code>oldHook.fns</code>不为空并且<code>oldHook.merged</code>为<code>true</code>，那么其实<code>oldHook</code>就是<code>invoker</code>函数，只要将它赋值为<code>invoker</code>，然后只需要将<code>wrappedHook</code>添加到<code>invoker.fns</code>中就可以了。<br>
  那么还有一种情况，那就是组件其实是有自己<code>hook</code>的，并且它会有<code>insert</code>钩子，这个钩子是创建组件<code>vnode</code>就带来的，并不是通过<code>mergeVNodeHook</code>函数添加的，所以它就是一个正常执行函数，而不是通过<code>invoker</code>管理的函数，这时候就要将它两放到一个数组中通过。<br>
  分析到这里其实我们也清楚了<code>oldHook.merged</code>就是通过<code>mergeVNodeHook</code>方法合并<code>hook</code>时为<code>invoker</code>添加的独有标识，最后将<code>def[hookKey]</code>赋值为<code>invoker</code>。<br>
  之后调用<code>vnode</code>中对应<code>hook</code>钩子时<code>wrappedHook</code>方法就会调用，并且调用之后就会移除，防止内存泄漏。<br>
  接下来我们需要了解一个问题，那就是<code>wrappedHook</code>方法是什么时候被调用的。我们在分析<code>_update</code>方法时说过，在创建时会将指令<code>insert</code>钩子合并到<code>data.hook</code>中，在<code>patch</code>阶段调用<code>invokerCreateHooks</code>时</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">invokeCreateHooks</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> insertedVnodeQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cbs<span class="token punctuation">.</span>create<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  i <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook <span class="token comment">// Reuse variable</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>create<span class="token punctuation">)</span><span class="token punctuation">)</span> i<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>insert<span class="token punctuation">)</span><span class="token punctuation">)</span> insertedVnodeQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  在这里存在<code>insert</code>方法时会先将其添加<code>insertedVnodeQueue</code>数组中，等到<code>patch</code>最后调用<code>invokeInsertHook</code>时调用队列中的方法。<br>
  如果不是<code>create</code>的情况那么不会调用<code>mergeVNodeHook</code>合并<code>hook</code>，而是直接去调用指令的<code>insert</code>钩子。<br>
  而对于<code>componentUpdated</code>钩子都是要合并到<code>postpatch hook</code>上。在更新过程中会执行一个<code>patchVnode</code>方法，这里面执行了</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>postpatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  这个当时令我百思不得其解的方法，原来是为指令做的。下个小节我们来分析<code>model</code>指令的<code>inserted</code>钩子和<code>componentUpdated</code>钩子函数。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/./main/chapter6/6-5.html" class="prev">
        6.5 v-model（1）
      </a></span> <span class="next"><a href="/./main/chapter6/6-7.html">
        6.7 v-model（3）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.20317d9d.js" defer></script><script src="./assets/js/2.8a65079d.js" defer></script><script src="./assets/js/65.6ca1c75b.js" defer></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>7.6 transition-group | 卷心菜笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="./logo.jpg">
    <meta name="description" content="基于vue@2.6.14的学习笔记">
    
    <link rel="preload" href="./assets/css/0.styles.34509ede.css" as="style"><link rel="preload" href="./assets/js/app.cb86b5c8.js" as="script"><link rel="preload" href="./assets/js/2.8a65079d.js" as="script"><link rel="preload" href="./assets/js/74.259c6d32.js" as="script"><link rel="prefetch" href="./assets/js/10.35fa5c54.js"><link rel="prefetch" href="./assets/js/11.a8d301ee.js"><link rel="prefetch" href="./assets/js/12.28dadb6d.js"><link rel="prefetch" href="./assets/js/13.959f52a9.js"><link rel="prefetch" href="./assets/js/14.9e967e5c.js"><link rel="prefetch" href="./assets/js/15.89c1bf18.js"><link rel="prefetch" href="./assets/js/16.78f7cadf.js"><link rel="prefetch" href="./assets/js/17.eee5b860.js"><link rel="prefetch" href="./assets/js/18.e94d03e8.js"><link rel="prefetch" href="./assets/js/19.c9b980d9.js"><link rel="prefetch" href="./assets/js/20.82c7f25f.js"><link rel="prefetch" href="./assets/js/21.5878b705.js"><link rel="prefetch" href="./assets/js/22.e7794d4a.js"><link rel="prefetch" href="./assets/js/23.b1e09bbf.js"><link rel="prefetch" href="./assets/js/24.e1df98bf.js"><link rel="prefetch" href="./assets/js/25.1c2fb721.js"><link rel="prefetch" href="./assets/js/26.36c3f7e0.js"><link rel="prefetch" href="./assets/js/27.a3f09949.js"><link rel="prefetch" href="./assets/js/28.123d6383.js"><link rel="prefetch" href="./assets/js/29.04a6e255.js"><link rel="prefetch" href="./assets/js/3.3554c1dd.js"><link rel="prefetch" href="./assets/js/30.f5e711c8.js"><link rel="prefetch" href="./assets/js/31.7ddb232a.js"><link rel="prefetch" href="./assets/js/32.3710a144.js"><link rel="prefetch" href="./assets/js/33.836eb573.js"><link rel="prefetch" href="./assets/js/34.c3f3eb0f.js"><link rel="prefetch" href="./assets/js/35.3e97ba3f.js"><link rel="prefetch" href="./assets/js/36.0ff1be33.js"><link rel="prefetch" href="./assets/js/37.57e976da.js"><link rel="prefetch" href="./assets/js/38.778b591d.js"><link rel="prefetch" href="./assets/js/39.f89500e6.js"><link rel="prefetch" href="./assets/js/4.414ef3ae.js"><link rel="prefetch" href="./assets/js/40.0bb1a72b.js"><link rel="prefetch" href="./assets/js/41.1b14daa9.js"><link rel="prefetch" href="./assets/js/42.da61de9e.js"><link rel="prefetch" href="./assets/js/43.afa151ce.js"><link rel="prefetch" href="./assets/js/44.beed5647.js"><link rel="prefetch" href="./assets/js/45.15cb664e.js"><link rel="prefetch" href="./assets/js/46.19b76064.js"><link rel="prefetch" href="./assets/js/47.81dd06b3.js"><link rel="prefetch" href="./assets/js/48.da28ae74.js"><link rel="prefetch" href="./assets/js/49.6ec02c7d.js"><link rel="prefetch" href="./assets/js/5.7771716e.js"><link rel="prefetch" href="./assets/js/50.33adc7e6.js"><link rel="prefetch" href="./assets/js/51.ad4dcf8f.js"><link rel="prefetch" href="./assets/js/52.1f63a577.js"><link rel="prefetch" href="./assets/js/53.f08905cc.js"><link rel="prefetch" href="./assets/js/54.95edb54c.js"><link rel="prefetch" href="./assets/js/55.4ad5a772.js"><link rel="prefetch" href="./assets/js/56.d55c7dcb.js"><link rel="prefetch" href="./assets/js/57.2bdbd5d4.js"><link rel="prefetch" href="./assets/js/58.6996ec46.js"><link rel="prefetch" href="./assets/js/59.42c770e8.js"><link rel="prefetch" href="./assets/js/6.f0272f8f.js"><link rel="prefetch" href="./assets/js/60.9a43de0b.js"><link rel="prefetch" href="./assets/js/61.9fda2ee3.js"><link rel="prefetch" href="./assets/js/62.40ba97a6.js"><link rel="prefetch" href="./assets/js/63.a8ceda24.js"><link rel="prefetch" href="./assets/js/64.063b5356.js"><link rel="prefetch" href="./assets/js/65.609bfe39.js"><link rel="prefetch" href="./assets/js/66.10bbf1b3.js"><link rel="prefetch" href="./assets/js/67.ed6fbab5.js"><link rel="prefetch" href="./assets/js/68.edf47e53.js"><link rel="prefetch" href="./assets/js/69.58c89969.js"><link rel="prefetch" href="./assets/js/7.44545bae.js"><link rel="prefetch" href="./assets/js/70.44d1903b.js"><link rel="prefetch" href="./assets/js/71.f54eb805.js"><link rel="prefetch" href="./assets/js/72.e0f8bc14.js"><link rel="prefetch" href="./assets/js/73.2292a46a.js"><link rel="prefetch" href="./assets/js/75.a5535961.js"><link rel="prefetch" href="./assets/js/76.2e270b76.js"><link rel="prefetch" href="./assets/js/77.a4bffe25.js"><link rel="prefetch" href="./assets/js/78.e00f48eb.js"><link rel="prefetch" href="./assets/js/79.dd1ef766.js"><link rel="prefetch" href="./assets/js/8.54165142.js"><link rel="prefetch" href="./assets/js/80.6d018d78.js"><link rel="prefetch" href="./assets/js/81.8647d108.js"><link rel="prefetch" href="./assets/js/82.9c326a94.js"><link rel="prefetch" href="./assets/js/83.0a8e8403.js"><link rel="prefetch" href="./assets/js/84.e1f731e8.js"><link rel="prefetch" href="./assets/js/85.446cc3ec.js"><link rel="prefetch" href="./assets/js/86.7800fc8e.js"><link rel="prefetch" href="./assets/js/87.51a4cddc.js"><link rel="prefetch" href="./assets/js/88.5cb86311.js"><link rel="prefetch" href="./assets/js/89.11fe5589.js"><link rel="prefetch" href="./assets/js/9.2a932dde.js"><link rel="prefetch" href="./assets/js/90.b3555572.js">
    <link rel="stylesheet" href="./assets/css/0.styles.34509ede.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><!----> <span class="site-name">卷心菜笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./main/" class="nav-link router-link-active">
  正文
</a></div><div class="nav-item"><a href="/./appendix/mergeOptions.html" class="nav-link">
  附录
</a></div><div class="nav-item"><a href="/./util/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/w781223592/vue2.0-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/./main/" class="nav-link router-link-active">
  正文
</a></div><div class="nav-item"><a href="/./appendix/mergeOptions.html" class="nav-link">
  附录
</a></div><div class="nav-item"><a href="/./util/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/w781223592/vue2.0-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/./main/" aria-current="page" class="sidebar-link">前言</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第一章 初识Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter1/1-1.html" class="sidebar-link">1.1 Vue目录设计</a></li><li><a href="/./main/chapter1/1-2.html" class="sidebar-link">1.2 Vue入口文件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第二章 Vue初始化和挂载</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter2/2-1.html" class="sidebar-link">2.1 new Vue()时做了什么</a></li><li><a href="/./main/chapter2/2-2.html" class="sidebar-link">2.2 Vue实例挂载的实现</a></li><li><a href="/./main/chapter2/2-3.html" class="sidebar-link">2.3 Vue挂载时的mountComponent</a></li><li><a href="/./main/chapter2/2-4.html" class="sidebar-link">2.4 Virtual DOM</a></li><li><a href="/./main/chapter2/2-5.html" class="sidebar-link">2.5 最终的挂载方法_update</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第三章 组件化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter3/3-1.html" class="sidebar-link">3.1 创建组件vnode</a></li><li><a href="/./main/chapter3/3-2.html" class="sidebar-link">3.2组件的patch过程</a></li><li><a href="/./main/chapter3/3-3.html" class="sidebar-link">3.3合并配置</a></li><li><a href="/./main/chapter3/3-4.html" class="sidebar-link">3.4生命周期（上）</a></li><li><a href="/./main/chapter3/3-5.html" class="sidebar-link">3.5生命周期（下）</a></li><li><a href="/./main/chapter3/3-6.html" class="sidebar-link">3.6组件的注册</a></li><li><a href="/./main/chapter3/3-7.html" class="sidebar-link">3.7 异步组件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第四章 响应式原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter4/4-1.html" class="sidebar-link">4.1 响应式对象</a></li><li><a href="/./main/chapter4/4-2.html" class="sidebar-link">4.2 依赖收集（上）</a></li><li><a href="/./main/chapter4/4-3.html" class="sidebar-link">4.3 依赖收集（下）</a></li><li><a href="/./main/chapter4/4-4.html" class="sidebar-link">4.4 派发更新</a></li><li><a href="/./main/chapter4/4-5.html" class="sidebar-link">4.5 nextTick</a></li><li><a href="/./main/chapter4/4-6.html" class="sidebar-link">4.6 检测变化的坑</a></li><li><a href="/./main/chapter4/4-7.html" class="sidebar-link">4.7 计算属性</a></li><li><a href="/./main/chapter4/4-8.html" class="sidebar-link">4.8 侦听器</a></li><li><a href="/./main/chapter4/4-9.html" class="sidebar-link">4.9 组件更新</a></li><li><a href="/./main/chapter4/4-10.html" class="sidebar-link">4.10 diff算法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第五章 编译</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter5/5-1.html" class="sidebar-link">5.1 初探编译器</a></li><li><a href="/./main/chapter5/5-2.html" class="sidebar-link">5.2 从入口开始</a></li><li><a href="/./main/chapter5/5-3.html" class="sidebar-link">5.3 parse之解析模板（上）</a></li><li><a href="/./main/chapter5/5-4.html" class="sidebar-link">5.4 parse之解析模板（下）</a></li><li><a href="/./main/chapter5/5-5.html" class="sidebar-link">5.5 parse之生成AST（1）</a></li><li><a href="/./main/chapter5/5-6.html" class="sidebar-link">5.6 parse之生成AST（2）</a></li><li><a href="/./main/chapter5/5-7.html" class="sidebar-link">5.7 parse之生成AST（3）</a></li><li><a href="/./main/chapter5/5-8.html" class="sidebar-link">5.8 parse之生成AST（4）</a></li><li><a href="/./main/chapter5/5-9.html" class="sidebar-link">5.9 parse之生成AST（5）</a></li><li><a href="/./main/chapter5/5-10.html" class="sidebar-link">5.10 optimize优化</a></li><li><a href="/./main/chapter5/5-11.html" class="sidebar-link">5.11 generate代码生成（1）</a></li><li><a href="/./main/chapter5/5-12.html" class="sidebar-link">5.12 generate代码生成（2）</a></li><li><a href="/./main/chapter5/5-13.html" class="sidebar-link">5.13 generate代码生成（3）</a></li><li><a href="/./main/chapter5/5-14.html" class="sidebar-link">5.14 generate代码生成（4）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第六章 扩展</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter6/6-1.html" class="sidebar-link">6.1 events（1）</a></li><li><a href="/./main/chapter6/6-2.html" class="sidebar-link">6.2 events（2）</a></li><li><a href="/./main/chapter6/6-3.html" class="sidebar-link">6.3 events（3）</a></li><li><a href="/./main/chapter6/6-4.html" class="sidebar-link">6.4 events（4）</a></li><li><a href="/./main/chapter6/6-5.html" class="sidebar-link">6.5 v-model（1）</a></li><li><a href="/./main/chapter6/6-6.html" class="sidebar-link">6.6 v-model（2）</a></li><li><a href="/./main/chapter6/6-7.html" class="sidebar-link">6.7v-model（3）</a></li><li><a href="/./main/chapter6/6-8.html" class="sidebar-link">6.8v-model（4）</a></li><li><a href="/./main/chapter6/6-9.html" class="sidebar-link">6.9 slot（上）</a></li><li><a href="/./main/chapter6/6-10.html" class="sidebar-link">6.10 slot（中）</a></li><li><a href="/./main/chapter6/6-11.html" class="sidebar-link">6.11 slot（下）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>第七章 内置组件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter7/7-1.html" class="sidebar-link">7.1 keep-alive（上）</a></li><li><a href="/./main/chapter7/7-2.html" class="sidebar-link">7.2 keep-alive（下）</a></li><li><a href="/./main/chapter7/7-3.html" class="sidebar-link">7.3 transition（上）</a></li><li><a href="/./main/chapter7/7-4.html" class="sidebar-link">7.4 transition（中）</a></li><li><a href="/./main/chapter7/7-5.html" class="sidebar-link">7.5 transition（下）</a></li><li><a href="/./main/chapter7/7-6.html" aria-current="page" class="active sidebar-link">7.6 transition-group</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第八章 Vue-router</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter8/8-1.html" class="sidebar-link">8.1 vue-router的注册</a></li><li><a href="/./main/chapter8/8-2.html" class="sidebar-link">8.2 VueRouter实例化</a></li><li><a href="/./main/chapter8/8-3.html" class="sidebar-link">8.3 动态路由</a></li><li><a href="/./main/chapter8/8-4.html" class="sidebar-link">8.4 match</a></li><li><a href="/./main/chapter8/8-5.html" class="sidebar-link">8.5 导航守卫（上）</a></li><li><a href="/./main/chapter8/8-6.html" class="sidebar-link">8.6 导航守卫（中）</a></li><li><a href="/./main/chapter8/8-7.html" class="sidebar-link">8.7 导航守卫（下）</a></li><li><a href="/./main/chapter8/8-8.html" class="sidebar-link">8.8 路径切换</a></li><li><a href="/./main/chapter8/8-9.html" class="sidebar-link">8.9 router-view组件</a></li><li><a href="/./main/chapter8/8-10.html" class="sidebar-link">8.10 router-link组件</a></li><li><a href="/./main/chapter8/8-11.html" class="sidebar-link">8.11 history模式</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_7-6-transition-group"><a href="#_7-6-transition-group" class="header-anchor">#</a> 7.6 transition-group</h1> <p>  这个小节我们来分析<code>transition-group</code>组件。这个组件不同于<code>transition</code>，它并不是一个抽象组件，它会真实渲染到页面，首先它<code>props</code>和<code>transition</code>大致相同，只是没有<code>mode</code>，然后会多出两个<code>props</code>，<code>tag</code>和<code>move-class</code>。<code>tag</code>默认为<code>span</code>，也就是真正要渲染到页面的标名。<code>move-class</code>有什么用我们后面会做说明。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
  <span class="token literal-property property">moveClass</span><span class="token operator">:</span> String
<span class="token punctuation">}</span><span class="token punctuation">,</span> transitionProps<span class="token punctuation">)</span>

<span class="token keyword">delete</span> props<span class="token punctuation">.</span>mode
</code></pre></div><p>  可以看到这里是使用了<code>transition</code>的<code>props</code>，这也是我们<code>transition</code>的<code>props</code>专门定在在外面的原因，然后会扩展<code>tag</code>和<code>moveClass</code>，并将<code>mode</code>删除。
接下来我们来看render函数的实现</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">const</span> <span class="token literal-property property">tag</span><span class="token operator">:</span> string <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>tag <span class="token operator">||</span> <span class="token string">'span'</span>
    <span class="token keyword">const</span> <span class="token literal-property property">map</span><span class="token operator">:</span> Object <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token literal-property property">prevChildren</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>prevChildren <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>children
    <span class="token keyword">const</span> <span class="token literal-property property">rawChildren</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$slots<span class="token punctuation">.</span>default <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> <span class="token literal-property property">children</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> <span class="token literal-property property">transitionData</span><span class="token operator">:</span> Object <span class="token operator">=</span> <span class="token function">extractTransitionData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
</code></pre></div><p>  这里先会获取<code>tag</code>，先从<code>props</code>取不到则取<code>this.$vnode.data.tag</code>，如果都没有则默认为<code>span</code>，创建一个<code>map</code>空对象。获取<code>this.children</code>保存到<code>this.prevChildren</code>。然后会获取默认插槽保存在<code>rawChildren</code>。然后将<code>this.children</code>初始化为空数组并保存在<code>children</code>。然后获取<code>transitionData</code>，这个方法我们已经分析过了。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rawChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token literal-property property">c</span><span class="token operator">:</span> VNode <span class="token operator">=</span> rawChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>key <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">String</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'__vlist'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        map<span class="token punctuation">[</span>c<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> c
        <span class="token punctuation">;</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>data <span class="token operator">||</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transition <span class="token operator">=</span> transitionData
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token literal-property property">opts</span><span class="token operator">:</span> <span class="token operator">?</span>VNodeComponentOptions <span class="token operator">=</span> c<span class="token punctuation">.</span>componentOptions
        <span class="token keyword">const</span> <span class="token literal-property property">name</span><span class="token operator">:</span> string <span class="token operator">=</span> opts <span class="token operator">?</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>Ctor<span class="token punctuation">.</span>options<span class="token punctuation">.</span>name <span class="token operator">||</span> opts<span class="token punctuation">.</span>tag <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">:</span> c<span class="token punctuation">.</span>tag
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;transition-group&gt; children must be keyed: &lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  接下来是个<code>for</code>循环，遍历插槽中的子节点，如果子节点<code>tag</code>存在，那就执行分支内逻辑，首先要保证<code>key</code>不能为空，然后<code>key</code>不能是以<code>'__vlist'</code>开头，否则就会直接报一个警告，让我们必须设置一个<code>key</code>值。<br>
  那么这里为什么判断<code>__vlist</code>，这个又是什么东西呢？对于我们<code>v-for</code>绑定的元素来说，在编译时会生成<code>_l</code>函数，也就是<code>renderList</code>辅助函数，最后会给生成的列表添加一个<code>_isVList</code>属性，那么在<code>_createElement</code>函数中执行<code>normalizeChildren</code>时会标准化<code>children</code>，如果判断到<code>childen._isVList</code>，就会执行</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>children<span class="token punctuation">.</span>_isVList<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token function">isDef</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token function">isUndef</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token function">isDef</span><span class="token punctuation">(</span>nestedIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token string">&quot;__vlist&quot;</span> <span class="token operator">+</span> nestedIndex <span class="token operator">+</span> <span class="token string">&quot;_&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;__&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  如果判断到没有设置<code>key</code>的话，会添加这么一个开头的<code>key</code>值。但是<code>transition-group</code>组件需要我们手动去指定唯一的<code>key</code>才能保证我们动画的正确性。<br>
  所以必须用户指定<code>key</code>才会执行<code>if</code>逻辑，将子节点添加到<code>children</code>数组，并对应<code>key</code>和<code>c</code>生成一个<code>map</code>对象。
  最后是这样一段逻辑</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>prevChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token literal-property property">kept</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> <span class="token literal-property property">removed</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> prevChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token literal-property property">c</span><span class="token operator">:</span> VNode <span class="token operator">=</span> prevChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      c<span class="token punctuation">.</span>data<span class="token punctuation">.</span>transition <span class="token operator">=</span> transitionData
      c<span class="token punctuation">.</span>data<span class="token punctuation">.</span>pos <span class="token operator">=</span> c<span class="token punctuation">.</span>elm<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>c<span class="token punctuation">.</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        kept<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        removed<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>kept <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> kept<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>removed <span class="token operator">=</span> removed
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> children<span class="token punctuation">)</span>
</code></pre></div><p>  这里是判断<code>prevChildren</code>，也就是之前的<code>children</code>，显然是对更新时的一个处理。<br>
  首先定义了<code>kept</code>和<code>removed</code>，分别保存更新后保留的<code>vnode</code>和被移除的<code>vnode</code>。接下来遍历<code>prevChildren</code>，这里也是个关键逻辑，会给所有子<code>vnode</code>添加<code>transition</code>属性这和我们<code>transition</code>组件是一致的。<br>
  然后这里还会计算元素相对视口的位置，并将其保存在<code>data.pos</code>中，接下来就找到<code>map</code>中有对应<code>key</code>的元素添加到<code>kept</code>，否则就添加到<code>removed</code>中。<br>
  然后这里将<code>this.kept</code>赋值为<code>h</code>函数返回的<code>vnode</code>，这里传入<code>kept</code>作为子节点，<code>tag</code>为我们定义的标签名。<code>this.removed</code>则是直接赋值为<code>removed</code>，最后返回一个<code>h</code>函数生成的<code>vnode</code>，这里传入的就是我们<code>children</code>数组，也就是最新的<code>vnode</code>。那么对于过渡和动画的管理其实和<code>transition</code>是没什么区别的，都是靠<code>modules</code>下<code>transition</code>文件中的逻辑去实现的，我们上小节分析<code>transition</code>时已经分析过了。<br>
  其实在执行<code>render</code>函数执行前会先执行<code>beforeMount</code>方法，我们来看它的定义</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">beforeMount</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_update
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">_update</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> hydrating</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> restoreActiveInstance <span class="token operator">=</span> <span class="token function">setActiveInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token comment">// force removing pass</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_vnode<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>kept<span class="token punctuation">,</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// hydrating</span>
        <span class="token boolean">true</span> <span class="token comment">// removeOnly (!important, avoids unnecessary moves)</span>
      <span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_vnode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>kept
      <span class="token function">restoreActiveInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token function">update</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>  这里先将<code>this._update</code>保存在<code>update</code>中，然后这里会重写<code>_update</code>钩子，然后会执行<code>this.__patch__</code>方法，这里比较特殊会先执行一次<code>patch</code>方法，我们来看这里传入的参数，首先旧节点传入<code>this._vnode</code>，然后新节点传入<code>this.kept</code>。这里特别注意第四个参数<code>removeOnly</code>传入的是<code>true</code>，也就是仅删除。这是什么意思呢？<br>
  我们知道<code>this.kept</code>保存的是新的<code>vnode</code>中和旧<code>vnode</code>中相同的部分，也就是说这里会删除旧节点中被移除的部分。仅做一个删除，而不做插入，因为我们需要计算过渡动画做一些特殊处理，这里是采用了<code>FLIP</code>技术。<br>
  因我们<code>diff</code>算法不能保证元素的位置保持不变，它可能改变元素的顺序导致位置发生变化，这样我们<code>FLIP</code>处理时就会发生问题。对此我们解决办法就是重写<code>_update</code>方法，让它分两步去更新，也就是第一次<code>patch</code>先删除需要移除的<code>dom</code>，也就是传<code>removeOnly</code>这个专属参数为<code>true</code>。这样在<code>patch</code>时不会执行任何插入逻辑，只会执行删除逻辑，也就是第一次更新只保证数量而不考虑元素顺序，这样就会触发元素离开过渡。<br>
  接下来了就是更新<code>this._vnode</code>为<code>kept</code>，然后调用<code>update</code>方法再做一次<code>patch</code>，这样就达到最后的状态。<br>
  这样做是为了实现一个缓动效果，也就是当我们在一个列表中间插入一个元素的话，会重新计算其他元素的位置，后面元素会移动来空出前面插入元素的位置，但是直接插入的话，只给插入元素一个动画，那么其它元素的突兀的移动就会使人感到生硬，那么能不能给其它元素也做个处理，让它们能有个平缓的移动移动效果呢？<code>transition-group</code>就为我们提供了这样的能力。<br>
  我们来看<code>update</code>时的处理，因为缓动就是要体现在更新时</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">updated</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token literal-property property">children</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>VNode<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>prevChildren
    <span class="token keyword">const</span> <span class="token literal-property property">moveClass</span><span class="token operator">:</span> string <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>moveClass <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token string">'v'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'-move'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>children<span class="token punctuation">.</span>length <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasMove</span><span class="token punctuation">(</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>elm<span class="token punctuation">,</span> moveClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// we divide the work into three loops to avoid mixing DOM reads and writes</span>
    <span class="token comment">// in each iteration - which helps prevent layout thrashing.</span>
    children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>callPendingCbs<span class="token punctuation">)</span>
    children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>recordPosition<span class="token punctuation">)</span>
    children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>applyTranslation<span class="token punctuation">)</span>
     <span class="token comment">// 省略部分逻辑</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>  首先获取之前的<code>children</code>，然后是获取<code>moveClass</code>类，接下来如果判断<code>children</code>长度为0或者<code>this.hasMove</code>方法调用结果为<code>false</code>那就什么都不做。<br>
  我们来看this.hasMove方法</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">hasMove</span> <span class="token punctuation">(</span>el<span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">moveClass</span><span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
    <span class="token comment">/* istanbul ignore if */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasTransition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* istanbul ignore if */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_hasMove<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_hasMove
    <span class="token punctuation">}</span>
    <span class="token comment">// Detect whether an element with the move class applied has</span>
    <span class="token comment">// CSS transitions. Since the element may be inside an entering</span>
    <span class="token comment">// transition at this very moment, we make a clone of it and remove</span>
    <span class="token comment">// all other transition classes applied to ensure only the move class</span>
    <span class="token comment">// is applied.</span>
    <span class="token keyword">const</span> <span class="token literal-property property">clone</span><span class="token operator">:</span> HTMLElement <span class="token operator">=</span> el<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>_transitionClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      el<span class="token punctuation">.</span>_transitionClasses<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">cls</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">removeClass</span><span class="token punctuation">(</span>clone<span class="token punctuation">,</span> cls<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">addClass</span><span class="token punctuation">(</span>clone<span class="token punctuation">,</span> moveClass<span class="token punctuation">)</span>
    clone<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>clone<span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token literal-property property">info</span><span class="token operator">:</span> Object <span class="token operator">=</span> <span class="token function">getTransitionInfo</span><span class="token punctuation">(</span>clone<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$el<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>clone<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_hasMove <span class="token operator">=</span> info<span class="token punctuation">.</span>hasTransform<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  首先如果不支持<code>transition</code>浏览器那就直接返回<code>false</code>。
  如果<code>this._hasMove</code>已经有值了那就直接返回就可以了，不需要重新计算一次，这里应该是会做一个缓存，我们往下就会看到。<br>
  接下来克隆<code>el</code>元素，<code>el</code>是<code>children</code>第一个子元素<code>dom</code>节点。<br>
  如果<code>el._transitionClasses</code>存在那么就遍历它并将其过渡有关类名都删除，最后只添加<code>moveClass</code>对应类名，当然这个过程是在克隆节点上做的。然后会将<code>clone</code>的<code>display</code>设置为<code>'none'</code>，然后会将<code>clone</code>插入到真实节点最后。<br>
  接下来通过<code>getTransitionInfo</code>方法获取<code>clone</code>的过渡信息，然后再将其从真实节点移除最后判断其<code>hasTransform</code>。其实就是判断我们是否定义有效的<code>moveClass</code>，它会覆盖移动过渡期间应用的 <code>CSS</code> 类，所以这里要把其它过渡类都删除单独判断它是否存在。最后就会保存到<code>this._hasMove</code>，因为这个东西也是不需要第二次计算的。<br>
  如果这个返回的是<code>false</code>那么就不需要再往下执行了。<br>
  接下来<code>update</code>做了三次循环</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">callPendingCbs</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">c</span><span class="token operator">:</span> VNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* istanbul ignore if */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>elm<span class="token punctuation">.</span>_moveCb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>elm<span class="token punctuation">.</span><span class="token function">_moveCb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* istanbul ignore if */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>elm<span class="token punctuation">.</span>_enterCb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>elm<span class="token punctuation">.</span><span class="token function">_enterCb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先挨个判断<code>_moveCb</code>和<code>_enterCb</code>方法是否存在，如果就调用它们。也就是首先保证入场动画要结束掉。
然后执行</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">recordPosition</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">c</span><span class="token operator">:</span> VNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  c<span class="token punctuation">.</span>data<span class="token punctuation">.</span>newPos <span class="token operator">=</span> c<span class="token punctuation">.</span>elm<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>保存元素新的位置</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">applyTranslation</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">c</span><span class="token operator">:</span> VNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> oldPos <span class="token operator">=</span> c<span class="token punctuation">.</span>data<span class="token punctuation">.</span>pos
  <span class="token keyword">const</span> newPos <span class="token operator">=</span> c<span class="token punctuation">.</span>data<span class="token punctuation">.</span>newPos
  <span class="token keyword">const</span> dx <span class="token operator">=</span> oldPos<span class="token punctuation">.</span>left <span class="token operator">-</span> newPos<span class="token punctuation">.</span>left
  <span class="token keyword">const</span> dy <span class="token operator">=</span> oldPos<span class="token punctuation">.</span>top <span class="token operator">-</span> newPos<span class="token punctuation">.</span>top
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dx <span class="token operator">||</span> dy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>data<span class="token punctuation">.</span>moved <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">const</span> s <span class="token operator">=</span> c<span class="token punctuation">.</span>elm<span class="token punctuation">.</span>style
    s<span class="token punctuation">.</span>transform <span class="token operator">=</span> s<span class="token punctuation">.</span>WebkitTransform <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dx<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dy<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px)</span><span class="token template-punctuation string">`</span></span>
    s<span class="token punctuation">.</span>transitionDuration <span class="token operator">=</span> <span class="token string">'0s'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  这里会计算节点新旧位置偏移量，如果计算出有偏移的话，就将<code>data.moved</code>置为<code>true</code>，然后为它添加一个偏移动画，偏移量就是根据<code>dx、dy</code>来计算的，然后过渡时间为0。那这是什么意思呢？其实我们仔细来看，计算偏移量时用的是旧的位置减去新的位置。然后加上这个动画后实际上就从新位置回到旧位置的，这个过程我们是无感知的。<br>
  加入我们在一个列表中间插入一个元素，那么其后面元素都会发生偏移，它们新位置其实已经改变了，<code>dom</code>已经可以计算出这个变化，但是还没有真正渲染到页面。那么这个时候加入一个<code>transform</code>让它立即无感知回到原处，然后后续给它动画让它去到真实的位置，这样就能达到缓动效果。<br>
当然我们还要看后续处理</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// force reflow to put everything in position</span>
  <span class="token comment">// assign to this to avoid being removed in tree-shaking</span>
  <span class="token comment">// $flow-disable-line</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_reflow <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>offsetHeight

  children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">c</span><span class="token operator">:</span> VNode</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>data<span class="token punctuation">.</span>moved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token literal-property property">el</span><span class="token operator">:</span> any <span class="token operator">=</span> c<span class="token punctuation">.</span>elm
      <span class="token keyword">const</span> <span class="token literal-property property">s</span><span class="token operator">:</span> any <span class="token operator">=</span> el<span class="token punctuation">.</span>style
      <span class="token function">addTransitionClass</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> moveClass<span class="token punctuation">)</span>
      s<span class="token punctuation">.</span>transform <span class="token operator">=</span> s<span class="token punctuation">.</span>WebkitTransform <span class="token operator">=</span> s<span class="token punctuation">.</span>transitionDuration <span class="token operator">=</span> <span class="token string">''</span>
      el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>transitionEndEvent<span class="token punctuation">,</span> el<span class="token punctuation">.</span><span class="token function-variable function">_moveCb</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">cb</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>target <span class="token operator">!==</span> el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e <span class="token operator">||</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">transform$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>propertyName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          el<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>transitionEndEvent<span class="token punctuation">,</span> cb<span class="token punctuation">)</span>
          el<span class="token punctuation">.</span>_moveCb <span class="token operator">=</span> <span class="token keyword">null</span>
          <span class="token function">removeTransitionClass</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> moveClass<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>  这里要调用一次强制重绘让我们之前的更改生效，也就是访问说<code>offsetHeight</code>是会导致浏览器重绘的，这里把它赋值给t<code>his._reflow</code>，这个没有任何意义，仅仅是防止被<code>tree-shaking</code>掉。<br>
  然后接下来会遍历<code>children</code>，并为有<code>data.move</code>的元素添加<code>moveClass</code>对应的类，然后把我们之前的<code>transform</code>转换样式去掉，这样才能元素才能向真实位置过渡。然后接下来监听<code>transitionend</code>事件。<br>
  然后其结束回调为<code>el._moveCb</code>函数，这个函数首先判断是否是当前元素触发，如果不是的话就<code>return</code>。
接下来判断如果没有<code>e</code>，也就是不是监听回调触发的话，或者<code>e.propertyName</code>为<code>transform</code>时执行if内部逻辑，会将事件监听移除，将<code>el._moveCb</code>重置为<code>false</code>，然后移除<code>moveClass</code>。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/./main/chapter7/7-5.html" class="prev">
        7.5 transition（下）
      </a></span> <span class="next"><a href="/./main/chapter8/8-1.html">
        8.1 vue-router的注册
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.cb86b5c8.js" defer></script><script src="./assets/js/2.8a65079d.js" defer></script><script src="./assets/js/74.259c6d32.js" defer></script>
  </body>
</html>

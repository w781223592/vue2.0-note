<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>8.2 VueRouter实例化 | 卷心菜笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="./logo.jpg">
    <meta name="description" content="基于vue@2.6.14的学习笔记">
    
    <link rel="preload" href="./assets/css/0.styles.88a4e9f5.css" as="style"><link rel="preload" href="./assets/js/app.2826a362.js" as="script"><link rel="preload" href="./assets/js/2.8a65079d.js" as="script"><link rel="preload" href="./assets/js/13.ce6b27c7.js" as="script"><link rel="prefetch" href="./assets/js/10.c266c0d8.js"><link rel="prefetch" href="./assets/js/11.e1eaa455.js"><link rel="prefetch" href="./assets/js/12.a175422e.js"><link rel="prefetch" href="./assets/js/14.4ab13b5a.js"><link rel="prefetch" href="./assets/js/15.89c1bf18.js"><link rel="prefetch" href="./assets/js/16.78f7cadf.js"><link rel="prefetch" href="./assets/js/17.eee5b860.js"><link rel="prefetch" href="./assets/js/18.e94d03e8.js"><link rel="prefetch" href="./assets/js/19.9e73c1ac.js"><link rel="prefetch" href="./assets/js/20.334ef7f2.js"><link rel="prefetch" href="./assets/js/21.ce6ec28c.js"><link rel="prefetch" href="./assets/js/22.8276901b.js"><link rel="prefetch" href="./assets/js/23.c4649d50.js"><link rel="prefetch" href="./assets/js/24.e1df98bf.js"><link rel="prefetch" href="./assets/js/25.c325e810.js"><link rel="prefetch" href="./assets/js/26.4ec079ec.js"><link rel="prefetch" href="./assets/js/27.0e97179e.js"><link rel="prefetch" href="./assets/js/28.0a90597d.js"><link rel="prefetch" href="./assets/js/29.04a6e255.js"><link rel="prefetch" href="./assets/js/3.5443ad74.js"><link rel="prefetch" href="./assets/js/30.4c6515c4.js"><link rel="prefetch" href="./assets/js/31.60d2f4c4.js"><link rel="prefetch" href="./assets/js/32.bf54c965.js"><link rel="prefetch" href="./assets/js/33.61b55587.js"><link rel="prefetch" href="./assets/js/34.c3f3eb0f.js"><link rel="prefetch" href="./assets/js/35.3e97ba3f.js"><link rel="prefetch" href="./assets/js/36.0ff1be33.js"><link rel="prefetch" href="./assets/js/37.2859b7ee.js"><link rel="prefetch" href="./assets/js/38.c2a0a515.js"><link rel="prefetch" href="./assets/js/39.0fcd1b2d.js"><link rel="prefetch" href="./assets/js/4.4dfc388f.js"><link rel="prefetch" href="./assets/js/40.a45a4a21.js"><link rel="prefetch" href="./assets/js/41.7d171f2d.js"><link rel="prefetch" href="./assets/js/42.f2f5ea2d.js"><link rel="prefetch" href="./assets/js/43.544241cd.js"><link rel="prefetch" href="./assets/js/44.6014c885.js"><link rel="prefetch" href="./assets/js/45.3c1b0136.js"><link rel="prefetch" href="./assets/js/46.2a63fa48.js"><link rel="prefetch" href="./assets/js/47.7131563e.js"><link rel="prefetch" href="./assets/js/48.c3d6bdc3.js"><link rel="prefetch" href="./assets/js/49.08f18c4b.js"><link rel="prefetch" href="./assets/js/5.7771716e.js"><link rel="prefetch" href="./assets/js/50.06bd69e2.js"><link rel="prefetch" href="./assets/js/51.ed19bd31.js"><link rel="prefetch" href="./assets/js/52.cdd244b0.js"><link rel="prefetch" href="./assets/js/53.7e1f2059.js"><link rel="prefetch" href="./assets/js/54.95edb54c.js"><link rel="prefetch" href="./assets/js/55.4ad5a772.js"><link rel="prefetch" href="./assets/js/56.d55c7dcb.js"><link rel="prefetch" href="./assets/js/57.9926dcec.js"><link rel="prefetch" href="./assets/js/58.0595fbec.js"><link rel="prefetch" href="./assets/js/59.4793d557.js"><link rel="prefetch" href="./assets/js/6.f0272f8f.js"><link rel="prefetch" href="./assets/js/60.f92f02e3.js"><link rel="prefetch" href="./assets/js/61.b3b4fa7d.js"><link rel="prefetch" href="./assets/js/62.773f83d2.js"><link rel="prefetch" href="./assets/js/63.f2e2a6e0.js"><link rel="prefetch" href="./assets/js/64.71a49175.js"><link rel="prefetch" href="./assets/js/65.3ebdd57e.js"><link rel="prefetch" href="./assets/js/66.7abb5241.js"><link rel="prefetch" href="./assets/js/67.ed6fbab5.js"><link rel="prefetch" href="./assets/js/68.8798425e.js"><link rel="prefetch" href="./assets/js/69.875b50ee.js"><link rel="prefetch" href="./assets/js/7.55ad3c14.js"><link rel="prefetch" href="./assets/js/70.44d1903b.js"><link rel="prefetch" href="./assets/js/71.897ebf84.js"><link rel="prefetch" href="./assets/js/72.05498643.js"><link rel="prefetch" href="./assets/js/73.ddf48f99.js"><link rel="prefetch" href="./assets/js/74.09357e4a.js"><link rel="prefetch" href="./assets/js/75.bb0567a1.js"><link rel="prefetch" href="./assets/js/76.ac9407c1.js"><link rel="prefetch" href="./assets/js/77.136d3e39.js"><link rel="prefetch" href="./assets/js/78.577e17e9.js"><link rel="prefetch" href="./assets/js/79.dd1ef766.js"><link rel="prefetch" href="./assets/js/8.8d9c7635.js"><link rel="prefetch" href="./assets/js/80.6d018d78.js"><link rel="prefetch" href="./assets/js/81.0caa34e0.js"><link rel="prefetch" href="./assets/js/82.88a5092b.js"><link rel="prefetch" href="./assets/js/83.cb5759fe.js"><link rel="prefetch" href="./assets/js/84.8eb37a19.js"><link rel="prefetch" href="./assets/js/85.446cc3ec.js"><link rel="prefetch" href="./assets/js/86.6ae4ae72.js"><link rel="prefetch" href="./assets/js/87.51a4cddc.js"><link rel="prefetch" href="./assets/js/88.5cb86311.js"><link rel="prefetch" href="./assets/js/89.11fe5589.js"><link rel="prefetch" href="./assets/js/9.9bd6d99d.js"><link rel="prefetch" href="./assets/js/90.b3555572.js">
    <link rel="stylesheet" href="./assets/css/0.styles.88a4e9f5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><!----> <span class="site-name">卷心菜笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./main/" class="nav-link router-link-active">
  正文
</a></div><div class="nav-item"><a href="/./appendix/mergeOptions.html" class="nav-link">
  附录
</a></div><div class="nav-item"><a href="/./util/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/w781223592/vue2.0-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/./main/" class="nav-link router-link-active">
  正文
</a></div><div class="nav-item"><a href="/./appendix/mergeOptions.html" class="nav-link">
  附录
</a></div><div class="nav-item"><a href="/./util/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/w781223592/vue2.0-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/./main/" aria-current="page" class="sidebar-link">前言</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第一章 初识Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter1/1-1.html" class="sidebar-link">1.1 Vue目录设计</a></li><li><a href="/./main/chapter1/1-2.html" class="sidebar-link">1.2 Vue入口文件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第二章 Vue初始化和挂载</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter2/2-1.html" class="sidebar-link">2.1 new Vue()时做了什么</a></li><li><a href="/./main/chapter2/2-2.html" class="sidebar-link">2.2 Vue实例挂载的实现</a></li><li><a href="/./main/chapter2/2-3.html" class="sidebar-link">2.3 Vue挂载时的mountComponent</a></li><li><a href="/./main/chapter2/2-4.html" class="sidebar-link">2.4 Virtual DOM</a></li><li><a href="/./main/chapter2/2-5.html" class="sidebar-link">2.5 最终的挂载方法_update</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第三章 组件化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter3/3-1.html" class="sidebar-link">3.1 创建组件vnode</a></li><li><a href="/./main/chapter3/3-2.html" class="sidebar-link">3.2组件的patch过程</a></li><li><a href="/./main/chapter3/3-3.html" class="sidebar-link">3.3合并配置</a></li><li><a href="/./main/chapter3/3-4.html" class="sidebar-link">3.4生命周期（上）</a></li><li><a href="/./main/chapter3/3-5.html" class="sidebar-link">3.5生命周期（下）</a></li><li><a href="/./main/chapter3/3-6.html" class="sidebar-link">3.6组件的注册</a></li><li><a href="/./main/chapter3/3-7.html" class="sidebar-link">3.7 异步组件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第四章 响应式原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter4/4-1.html" class="sidebar-link">4.1 响应式对象</a></li><li><a href="/./main/chapter4/4-2.html" class="sidebar-link">4.2 依赖收集（上）</a></li><li><a href="/./main/chapter4/4-3.html" class="sidebar-link">4.3 依赖收集（下）</a></li><li><a href="/./main/chapter4/4-4.html" class="sidebar-link">4.4 派发更新</a></li><li><a href="/./main/chapter4/4-5.html" class="sidebar-link">4.5 nextTick</a></li><li><a href="/./main/chapter4/4-6.html" class="sidebar-link">4.6 检测变化的坑</a></li><li><a href="/./main/chapter4/4-7.html" class="sidebar-link">4.7 计算属性</a></li><li><a href="/./main/chapter4/4-8.html" class="sidebar-link">4.8 侦听器</a></li><li><a href="/./main/chapter4/4-9.html" class="sidebar-link">4.9 组件更新</a></li><li><a href="/./main/chapter4/4-10.html" class="sidebar-link">4.10 diff算法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第五章 编译</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter5/5-1.html" class="sidebar-link">5.1 初探编译器</a></li><li><a href="/./main/chapter5/5-2.html" class="sidebar-link">5.2 从入口开始</a></li><li><a href="/./main/chapter5/5-3.html" class="sidebar-link">5.3 parse之解析模板（上）</a></li><li><a href="/./main/chapter5/5-4.html" class="sidebar-link">5.4 parse之解析模板（下）</a></li><li><a href="/./main/chapter5/5-5.html" class="sidebar-link">5.5 parse之生成AST（1）</a></li><li><a href="/./main/chapter5/5-6.html" class="sidebar-link">5.6 parse之生成AST（2）</a></li><li><a href="/./main/chapter5/5-7.html" class="sidebar-link">5.7 parse之生成AST（3）</a></li><li><a href="/./main/chapter5/5-8.html" class="sidebar-link">5.8 parse之生成AST（4）</a></li><li><a href="/./main/chapter5/5-9.html" class="sidebar-link">5.9 parse之生成AST（5）</a></li><li><a href="/./main/chapter5/5-10.html" class="sidebar-link">5.10 optimize优化</a></li><li><a href="/./main/chapter5/5-11.html" class="sidebar-link">5.11 generate代码生成（1）</a></li><li><a href="/./main/chapter5/5-12.html" class="sidebar-link">5.12 generate代码生成（2）</a></li><li><a href="/./main/chapter5/5-13.html" class="sidebar-link">5.11 generate代码生成（3）</a></li><li><a href="/./main/chapter5/5-14.html" class="sidebar-link">5.11 generate代码生成（4）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第六章 扩展</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter6/6-1.html" class="sidebar-link">6.1 events（1）</a></li><li><a href="/./main/chapter6/6-2.html" class="sidebar-link">6.1 events（2）</a></li><li><a href="/./main/chapter6/6-3.html" class="sidebar-link">6.1 events（3）</a></li><li><a href="/./main/chapter6/6-4.html" class="sidebar-link">6.1 events（4）</a></li><li><a href="/./main/chapter6/6-5.html" class="sidebar-link">6.5 v-model（1）</a></li><li><a href="/./main/chapter6/6-6.html" class="sidebar-link">6.6 v-model（3）</a></li><li><a href="/./main/chapter6/6-7.html" class="sidebar-link">6.7v-model（3）</a></li><li><a href="/./main/chapter6/6-8.html" class="sidebar-link">6.8v-model（4）</a></li><li><a href="/./main/chapter6/6-9.html" class="sidebar-link">6.9 slot（上）</a></li><li><a href="/./main/chapter6/6-10.html" class="sidebar-link">6.10 slot（中）</a></li><li><a href="/./main/chapter6/6-11.html" class="sidebar-link">6.11 slot（下）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第七章 内置组件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter7/7-1.html" class="sidebar-link">7.1 keep-alive（上）</a></li><li><a href="/./main/chapter7/7-2.html" class="sidebar-link">7.2 keep-alive（下）</a></li><li><a href="/./main/chapter7/7-3.html" class="sidebar-link">7.3 transition（上）</a></li><li><a href="/./main/chapter7/7-4.html" class="sidebar-link">7.4 transition（中）</a></li><li><a href="/./main/chapter7/7-5.html" class="sidebar-link">7.5 transition（下）</a></li><li><a href="/./main/chapter7/7-6.html" class="sidebar-link">7.6 transition-group</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>第八章 Vue-router</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter8/8-1.html" class="sidebar-link">8.1 vue-router的注册</a></li><li><a href="/./main/chapter8/8-2.html" aria-current="page" class="active sidebar-link">8.2 VueRouter实例化</a></li><li><a href="/./main/chapter8/8-3.html" class="sidebar-link">8.3 动态路由</a></li><li><a href="/./main/chapter8/8-4.html" class="sidebar-link">8.4 match</a></li><li><a href="/./main/chapter8/8-5.html" class="sidebar-link">8.5 导航守卫（上）</a></li><li><a href="/./main/chapter8/8-6.html" class="sidebar-link">8.5 导航守卫（中）</a></li><li><a href="/./main/chapter8/8-7.html" class="sidebar-link">8.5 导航守卫（下）</a></li><li><a href="/./main/chapter8/8-8.html" class="sidebar-link">8.8 路径切换</a></li><li><a href="/./main/chapter8/8-9.html" class="sidebar-link">8.9 router-view组件</a></li><li><a href="/./main/chapter8/8-10.html" class="sidebar-link">8.10 router-link组件</a></li><li><a href="/./main/chapter8/8-11.html" class="sidebar-link">8.11 history模式</a></li></ul></section></li><li><a href="/./main/finish.html" class="sidebar-link">结束感言</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_8-2-vuerouter实例化"><a href="#_8-2-vuerouter实例化" class="header-anchor">#</a> 8.2 VueRouter实例化</h1> <p>  上小节我们分析了<code>VueRouter</code>的注册过程，这个小节我们来分析一下<code>VueRouter</code>类在实例化过程中做了什么事。在<code>router.js</code>中可以看到<code>VueRouter</code>的定义。我们来看他的构造函数做了什么事。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">options</span><span class="token operator">:</span> RouterOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">VueRouter</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Router must be called with the new operator.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>apps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
    <span class="token keyword">this</span><span class="token punctuation">.</span>beforeHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resolveHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>afterHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>matcher <span class="token operator">=</span> <span class="token function">createMatcher</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>routes <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  先是初始化<code>app、apps</code>等属性，这些属性我们等后面用到时候再详细分析，这里把传入的<code>options</code>赋值给<code>this.options</code>，然后初始化<code>beforeHooks、resolveHooks、afterHooks</code>为空数组，接下来这个<code>matcher</code>是比较重要的东西，我们在下个小节详细分析它。<br>
  构造器最后是对<code>mode</code>的定义</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> mode <span class="token operator">=</span> options<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'hash'</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>fallback <span class="token operator">=</span>
    mode <span class="token operator">===</span> <span class="token string">'history'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>supportsPushState <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>fallback <span class="token operator">!==</span> <span class="token boolean">false</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mode <span class="token operator">=</span> <span class="token string">'hash'</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mode <span class="token operator">=</span> <span class="token string">'abstract'</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'history'</span><span class="token operator">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTML5History</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">'hash'</span><span class="token operator">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">case</span> <span class="token string">'abstract'</span><span class="token operator">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbstractHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">)</span>
      <span class="token keyword">break</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">invalid mode: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>mode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>首先将<code>mode</code>设置为传入的<code>mode</code>，如果没有传入的话就默认是<code>'hash'</code>，另外还有两种路由模式，<code>history</code>和<code>abstract</code>(抽象)模式。因为浏览器限制并不能完全支持<code>history</code>模式，所以在浏览器不支持<code>history</code>时还需要降级方案。这里通过<code>fallback</code>属性来判断是否需要降级。<br>
  当<code>mode</code>为<code>history</code>模式时并且<code>!supportPushState</code>并且没有传入<code>fallback</code>配置项为<code>false</code>时<code>this.fallback</code>为<code>true</code>，当它为<code>true</code>时就降级为<code>hash</code>模式。如果在非浏览器环境，则将<code>mode</code>设置为<code>abstract</code>模式。<br>
  接下来是一个<code>switch</code>判断，在不同模式下分别实例化不同的实例。然后对默认对错误的<code>mode</code>进行判断并抛出一个错误。如果我们设置了一个错误的<code>mode</code>它就会命中这个错误。最后我们来看一下<code>supportPushState</code>做了什么判断。<br>
  定义于<code>src/util/push-state.js</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> supportsPushState <span class="token operator">=</span>
  inBrowser <span class="token operator">&amp;&amp;</span>
  <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ua <span class="token operator">=</span> window<span class="token punctuation">.</span>navigator<span class="token punctuation">.</span>userAgent

    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token punctuation">(</span>ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Android 2.'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Android 4.0'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Mobile Safari'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
      ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Chrome'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
      ua<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'Windows Phone'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> window<span class="token punctuation">.</span>history <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> window<span class="token punctuation">.</span>history<span class="token punctuation">.</span>pushState <span class="token operator">===</span> <span class="token string">'function'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>  可以看到如果是在浏览器环境就执行这个自执行函数，然后对运行环境进行判断，如果满足这些条件就直接返回<code>false</code>，否则在<code>window.history</code>存在时返回其<code>pushState</code>的类型与<code>function</code>比较，如果是<code>function</code>类型则返回<code>true</code>。返回<code>true</code>时说明此时是支持<code>history</code>模式的。这也反映了<code>history</code>模式原理实际是<code>window</code>对象<code>history</code>的<code>pushState</code>方法。<br>
  接下来是通过<code>switch</code>对不同<code>mode</code>进行判断。根据不同的<code>mode</code>实例化不同的<code>class</code>，这几个<code>class</code>是继承自同一个叫做<code>History</code>的<code>class</code>的，这个我们之后再去分析。<br>
  接下来我们来分析<code>VueRouter</code>对象实例化调用时机，当我们开发一个<code>vue</code>的单页应用时，对于路由我们会放在一个<code>router</code>的文件夹去管理，我们会在<code>index.js</code>去导出路由对象，这个对象就是实例化<code>VueRouter</code>类并传入我们定义的路由配置所得到的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> VueRouter <span class="token keyword">from</span> <span class="token string">'vue-router'</span>
<span class="token keyword">import</span> Home <span class="token keyword">from</span> <span class="token string">'../views/Home.vue'</span>

Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueRouter<span class="token punctuation">)</span>

<span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">component</span><span class="token operator">:</span> Home
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  routes
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router
</code></pre></div><p>  这是一个最简单的路由使用示例，这里导出的是<code>router</code>是实例化<code>VueRouter</code>的对象，实例化时传入我们定义的<code>ur</code>和组件的关系的数组。在<code>main.js</code>中引入<code>router</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App'</span>
<span class="token keyword">import</span> router <span class="token keyword">from</span> <span class="token string">'../../router'</span>

<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">render</span><span class="token operator">:</span> <span class="token parameter">h</span> <span class="token operator">=&gt;</span> <span class="token function">h</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span><span class="token punctuation">,</span>
  router
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>并在实例化根<code>vue</code>时作为<code>options</code>传入，为什么这里需要传入<code>router</code>我们在上小节已经解释过了，在<code>router</code>定义时我们调用<code>Vue.use</code>去注册了<code>router</code>插件，由于在注册时通过<code>Vue.mixin</code>在全局混入了生命周期钩子，所以之后的每个组件都能初始化<code>router</code>了。<br>
  那么路由初始化又做了什么事呢？那就要从注册路由插件时混入的<code>beforeCreate</code>钩子说起了。在组件初始化过程中会调用<code>beforeCreate</code>钩子，而<code>beforeCreate</code>方法调用了<code>this._router.init</code>方法。这个<code>init</code>方法就来自于<code>VueRouter</code>类的<code>init</code>方法。接下来我们看<code>init</code>方法的定义：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">init</span> <span class="token punctuation">(</span>app<span class="token operator">:</span> any <span class="token comment">/* Vue component instance */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>
        install<span class="token punctuation">.</span>installed<span class="token punctuation">,</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">not installed. Make sure to call \`Vue.use(VueRouter)\` </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">before creating root instance.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>

    <span class="token comment">// set up app destroyed handler</span>
    <span class="token comment">// https://github.com/vuejs/vue-router/issues/2639</span>
    app<span class="token punctuation">.</span><span class="token function">$once</span><span class="token punctuation">(</span><span class="token string">'hook:destroyed'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// clean out app from this.apps array once destroyed</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token comment">// ensure we still have a main app or null if no apps</span>
      <span class="token comment">// we do not release the router so it can be reused</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">===</span> app<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">null</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// main app previously initialized</span>
    <span class="token comment">// return as we don't need to set up new history listener</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> app

    <span class="token keyword">const</span> history <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>history

    <span class="token keyword">if</span> <span class="token punctuation">(</span>history <span class="token keyword">instanceof</span> <span class="token class-name">HTML5History</span> <span class="token operator">||</span> history <span class="token keyword">instanceof</span> <span class="token class-name">HashHistory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token function-variable function">handleInitialScroll</span> <span class="token operator">=</span> <span class="token parameter">routeOrError</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> from <span class="token operator">=</span> history<span class="token punctuation">.</span>current
        <span class="token keyword">const</span> expectScroll <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>scrollBehavior
        <span class="token keyword">const</span> supportsScroll <span class="token operator">=</span> supportsPushState <span class="token operator">&amp;&amp;</span> expectScroll

        <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsScroll <span class="token operator">&amp;&amp;</span> <span class="token string">'fullPath'</span> <span class="token keyword">in</span> routeOrError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> routeOrError<span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> <span class="token function-variable function">setupListeners</span> <span class="token operator">=</span> <span class="token parameter">routeOrError</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        history<span class="token punctuation">.</span><span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">handleInitialScroll</span><span class="token punctuation">(</span>routeOrError<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      history<span class="token punctuation">.</span><span class="token function">transitionTo</span><span class="token punctuation">(</span>
        history<span class="token punctuation">.</span><span class="token function">getCurrentLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        setupListeners<span class="token punctuation">,</span>
        setupListeners
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    history<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">route</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>apps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span>_route <span class="token operator">=</span> route
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  显然首先是判断是否注册过路由，如果没有注册路由，显然是不能执行这个方法的。也就是说必须通过<code>Vue.use</code>注册才能使用，当然一般不会触发这种错误，因为我们不太可能去手动去调用<code>init</code>。至于这个报错实现方法<code>assert</code>定义在<code>util/warn.js</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">assert</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">condition</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">message</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[vue-router] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  其实就是根据第一个条件是否成立来判断是否触发报错。然后将参数<code>app push</code>到<code>this.apps</code>数组中。接下来的逻辑是监听组件<code>destroyed</code>钩子调用，这段代码来自一个<code>issues 2639</code>，大致是说明如果我们一个组件经过创建销毁再创建的过程。会重复的向<code>apps</code>中添加组件实例，最终造成内存泄漏，所以要在组件销毁时将这个组件实例从<code>apps</code>中删除。接下来判断<code>this.app</code>是否存在，如果存在说明已经被初始化过主程序了。所以接下来就不需要再新建一个<code>history</code>的监听器了，直接<code>return</code>就好了。<br>
  如果是第一次初始化的话就把<code>this.app</code>设置为这个根组件实例。然后接下来就是对<code>this.history</code>的处理，这个属性是<code>new VueRouter</code>时根据不同<code>mode</code>去<code>new</code>不同的<code>class</code>得到的。<br>
  接下来就是判断<code>history</code>是否是<code>HTML5History</code>或<code>HashHistory</code>的实例，如果是的话说明是<code>hash</code>或者<code>history</code>模式就定义<code>handleInitialScroll</code>方法。这个方法是用来处理页面滚动的，它接收一个路由对象参数或者一个错误信息<code>routerOrError</code>。然后声明一个常量<code>from</code>去引用h<code>istory.current</code>，这个<code>current</code>是路由的一些信息，如下所示：
</p><div class="center"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMIAAACSCAMAAAAgseX0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAFiUExURfr6+vX19ezs7NXVrP///4LH+vX1xnsfIRscHtXV1ezZ65Yvj+LE4PX19nJ2el9jaNGkzogSgKJFm/bs9fr2+rJmrcCBu7l0tO7u7lBRU6mqq9fY2aWnqnyAhOHi4+zDegBiAOvr7PX13pmBTIrD1beXAKLk+vX1vnpsAPbW1tQ2NvTLy9taWuqdneJ3d/HAwNhKSvnh4d9paf319fvr63sffavV1cn6+syZyKFEm4yPVNQ3N7m6vSAhJIiJitvb3Ds8P8jIyYeKjm9vcWltcc3O0KtXpfb29pGUl3x8fpGTl+za62hscYeKjdLS0mFhZNXVw8OPVOzs2YxRVOzWnVFRjsaOwre7vZecoPb2983Q0qOoq4CGi52iptze37C0t4WLkO7u74uRlaqusdy62pGXm+fP5d6+3OjR5r/CxOy8fRtxrKtxHvX14ZtaXYyPcZtaIV+o5YzB1aXi+ujR5wAAAHzk6CMAAAB2dFJOU////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////wABYqlHAAAACXBIWXMAAA7EAAAOxAGVKw4bAAALTElEQVR4Xu1dj4/ayBX2qpOUyijYYGOHZE9tql6u+zPsmgZXHOLUw1LlU7huewhV4F1RC2mv1aWp+P/V996MwWbx4gTb4BWfTuuxYXPz/M3zvM/vzazEmPkrVmhIz97+uiTaBYXEaqYn2gWFxEyzL9oFBZqwDQuuPBOtnWFbFlzZF62dQWJH5m9Em30/AFR+oLaiqrLmyy7TDabYuiq7mm3IqsGYoeJPnU50FQBn5ssG/dYuEGHBG1QANK7a0HnGZtBxvQ7mtJljaHJVK8uuojPNVjRHduEEWCjj13dtwtIXJmDBhFrQccC8xU2QNTjRqgp9gje+jeSETNglVnzhuHJMRw16CIBOYkupogmWjSaIT9BGbsIe+ML10hcY+4oPI3AFGkjQSV8dgi9YcKLZbfzEoE/QBPQU8UTa8UD6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"></div><p></p> <p>  然后是获取<code>this.options.scrollBehavior</code>引用保存到<code>expectScroll</code>变量中，这个是由用户自己定义的滚动行为具体可以看路由<a href="https://router.vuejs.org/zh/guide/advanced/scroll-behavior.html" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>  然后定义<code>supportsScroll</code>为<code>supportsPushState &amp;&amp; expectScroll</code>的判断结果，这是用来判断是否支持滚动的标识。如果有支持滚动并且<code>routerOrError</code>有<code>fullPath</code>属性的话就执行<code>handleScroll</code>方法。<br>
  然后定义<code>setupListeners</code>方法，这个方法通过名字可以看出它是去启动一个监听器，它调用<code>history.setupListeners</code>方法并且调用了<code>handleInitialScroll</code>方法。接下来调用了<code>history.transitionTo()</code>方法，这个方法应该就是跳转逻辑了，这里传入了三个参数，第一个参数是<code>history.getCurrentLocation()</code>方法的执行结果，而二、三参数则是上面定义的<code>setupListeners</code>。所以这个监听器创建方法应该是在这个函数中去执行的。最后<code>init</code>函数调用了<code>history.listen</code>方法，这个方法传入一个函数。这个函数作用是将<code>router.apps</code>中的<code>_route</code>替换成传入的<code>route</code>。<br>
  接下来我们先看看<code>transitionTo</code>方法的定义，该方法定义于<code>src/history/base</code>下的<code>History</code>类中，因为<code>history</code>对象都是从<code>History</code>的子类实例化来的，所以<code>history</code>继承了<code>History</code>原型的<code>transitionTo</code>方法。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">transitionTo</span> <span class="token punctuation">(</span>
    <span class="token parameter"><span class="token literal-property property">location</span><span class="token operator">:</span> RawLocation<span class="token punctuation">,</span>
    onComplete<span class="token operator">?</span><span class="token operator">:</span> Function<span class="token punctuation">,</span>
    onAbort<span class="token operator">?</span><span class="token operator">:</span> Function</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> route
    <span class="token comment">// catch redirect option https://github.com/vuejs/vue-router/issues/3201</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      route <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>current<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>errorCbs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// Exception should still be thrown</span>
      <span class="token keyword">throw</span> e
    <span class="token punctuation">}</span>
  	<span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  transitionTo方法内容比较多，它调用了<code>this.router.match</code>方法，<code>router</code>属性是在实例化<code>History</code>是添加的，如下是<code>history</code>类的构造器</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">router</span><span class="token operator">:</span> Router<span class="token punctuation">,</span> <span class="token literal-property property">base</span><span class="token operator">:</span> <span class="token operator">?</span>string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>router <span class="token operator">=</span> router
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  可以看到首先就是设置<code>this.router为router</code>，这里<code>router</code>是接收的第一个参数，但是<code>History</code>构造器是什么时候调用的呢？我们以<code>HashHistory</code>为例。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HashHistory</span> <span class="token keyword">extends</span> <span class="token class-name">History</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">router</span><span class="token operator">:</span> Router<span class="token punctuation">,</span> <span class="token literal-property property">base</span><span class="token operator">:</span> <span class="token operator">?</span>string<span class="token punctuation">,</span> <span class="token literal-property property">fallback</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> base<span class="token punctuation">)</span>
    <span class="token comment">// check history fallback deeplinking</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fallback <span class="token operator">&amp;&amp;</span> <span class="token function">checkFallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>base<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token function">ensureSlash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  HashHistory如上所示，它是<code>History</code>的子类，首先它就是调用父类构造器并把<code>router</code>对象和<code>base</code>字符串传入。所以我们来看<code>router</code>对象是什么，之前我们已经讲过在<code>new VueRouter</code>时执行了<code>new HashHistory()</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashHistory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>base<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fallback<span class="token punctuation">)</span>
</code></pre></div><p>  这里传入的<code>this</code>也就是<code>VueRouter</code>类的实例了，所以这里<code>transitionTo</code>方法第一段逻辑就是<code>this.router.match()</code>执行结果赋值给<code>route</code>，然后我们回过头来看<code>match</code>的定义：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">match</span> <span class="token punctuation">(</span>raw<span class="token operator">:</span> RawLocation<span class="token punctuation">,</span> current<span class="token operator">?</span><span class="token operator">:</span> Route<span class="token punctuation">,</span> redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> Location<span class="token punctuation">)</span><span class="token operator">:</span> Route <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>matcher<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> current<span class="token punctuation">,</span> redirectedFrom<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  match返回了<code>this.matcher.match</code>方法执行结果，所以我们还需要看看<code>matcher</code>是什么，我们之前分析<code>VueRouter</code>构造器初始化时唯独没有去分析<code>this.matcher</code>，这将是我们接下来分析的重点。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/./main/chapter8/8-1.html" class="prev">
        8.1 vue-router的注册
      </a></span> <span class="next"><a href="/./main/chapter8/8-3.html">
        8.3 动态路由
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.2826a362.js" defer></script><script src="./assets/js/2.8a65079d.js" defer></script><script src="./assets/js/13.ce6b27c7.js" defer></script>
  </body>
</html>

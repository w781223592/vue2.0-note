<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>5.3 parse之解析模板（上） | 卷心菜笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="./logo.jpg">
    <meta name="description" content="基于vue@2.6.14的学习笔记">
    
    <link rel="preload" href="./assets/css/0.styles.74c59701.css" as="style"><link rel="preload" href="./assets/js/app.20317d9d.js" as="script"><link rel="preload" href="./assets/js/2.8a65079d.js" as="script"><link rel="preload" href="./assets/js/51.ea943f69.js" as="script"><link rel="prefetch" href="./assets/js/10.3d2f32ec.js"><link rel="prefetch" href="./assets/js/11.132a26b4.js"><link rel="prefetch" href="./assets/js/12.d0193009.js"><link rel="prefetch" href="./assets/js/13.07872830.js"><link rel="prefetch" href="./assets/js/14.96a92186.js"><link rel="prefetch" href="./assets/js/15.89c1bf18.js"><link rel="prefetch" href="./assets/js/16.78f7cadf.js"><link rel="prefetch" href="./assets/js/17.eee5b860.js"><link rel="prefetch" href="./assets/js/18.e94d03e8.js"><link rel="prefetch" href="./assets/js/19.9e73c1ac.js"><link rel="prefetch" href="./assets/js/20.ae18bc8e.js"><link rel="prefetch" href="./assets/js/21.d4a5ba0b.js"><link rel="prefetch" href="./assets/js/22.e7794d4a.js"><link rel="prefetch" href="./assets/js/23.adaee962.js"><link rel="prefetch" href="./assets/js/24.e1df98bf.js"><link rel="prefetch" href="./assets/js/25.c325e810.js"><link rel="prefetch" href="./assets/js/26.c24daaf7.js"><link rel="prefetch" href="./assets/js/27.a3f09949.js"><link rel="prefetch" href="./assets/js/28.123d6383.js"><link rel="prefetch" href="./assets/js/29.04a6e255.js"><link rel="prefetch" href="./assets/js/3.5a34bef2.js"><link rel="prefetch" href="./assets/js/30.f976c0a7.js"><link rel="prefetch" href="./assets/js/31.60d2f4c4.js"><link rel="prefetch" href="./assets/js/32.6b2a5515.js"><link rel="prefetch" href="./assets/js/33.6b80e89d.js"><link rel="prefetch" href="./assets/js/34.ea39628f.js"><link rel="prefetch" href="./assets/js/35.4c14bc3d.js"><link rel="prefetch" href="./assets/js/36.5f2b7559.js"><link rel="prefetch" href="./assets/js/37.57e976da.js"><link rel="prefetch" href="./assets/js/38.191568b8.js"><link rel="prefetch" href="./assets/js/39.f89500e6.js"><link rel="prefetch" href="./assets/js/4.9fb18247.js"><link rel="prefetch" href="./assets/js/40.a45a4a21.js"><link rel="prefetch" href="./assets/js/41.94ece143.js"><link rel="prefetch" href="./assets/js/42.224304d2.js"><link rel="prefetch" href="./assets/js/43.544241cd.js"><link rel="prefetch" href="./assets/js/44.6014c885.js"><link rel="prefetch" href="./assets/js/45.711ad2c3.js"><link rel="prefetch" href="./assets/js/46.19b76064.js"><link rel="prefetch" href="./assets/js/47.0a8f7a4f.js"><link rel="prefetch" href="./assets/js/48.da28ae74.js"><link rel="prefetch" href="./assets/js/49.97615384.js"><link rel="prefetch" href="./assets/js/5.0c239c66.js"><link rel="prefetch" href="./assets/js/50.06bd69e2.js"><link rel="prefetch" href="./assets/js/52.b4813218.js"><link rel="prefetch" href="./assets/js/53.c1ba1696.js"><link rel="prefetch" href="./assets/js/54.e1d1801c.js"><link rel="prefetch" href="./assets/js/55.ac7cd0ab.js"><link rel="prefetch" href="./assets/js/56.d55c7dcb.js"><link rel="prefetch" href="./assets/js/57.83bbfc8e.js"><link rel="prefetch" href="./assets/js/58.6996ec46.js"><link rel="prefetch" href="./assets/js/59.42c770e8.js"><link rel="prefetch" href="./assets/js/6.0600552c.js"><link rel="prefetch" href="./assets/js/60.919088d2.js"><link rel="prefetch" href="./assets/js/61.455d2404.js"><link rel="prefetch" href="./assets/js/62.40ba97a6.js"><link rel="prefetch" href="./assets/js/63.5b069dba.js"><link rel="prefetch" href="./assets/js/64.512e158a.js"><link rel="prefetch" href="./assets/js/65.6ca1c75b.js"><link rel="prefetch" href="./assets/js/66.0356130d.js"><link rel="prefetch" href="./assets/js/67.93a0d7df.js"><link rel="prefetch" href="./assets/js/68.7e44cc19.js"><link rel="prefetch" href="./assets/js/69.788a4d27.js"><link rel="prefetch" href="./assets/js/7.6346a45d.js"><link rel="prefetch" href="./assets/js/70.571f8a79.js"><link rel="prefetch" href="./assets/js/71.f54eb805.js"><link rel="prefetch" href="./assets/js/72.02cd77d0.js"><link rel="prefetch" href="./assets/js/73.66b6b1d0.js"><link rel="prefetch" href="./assets/js/74.96bf5acc.js"><link rel="prefetch" href="./assets/js/75.1b135bdd.js"><link rel="prefetch" href="./assets/js/76.6ed173f1.js"><link rel="prefetch" href="./assets/js/77.ee856c8d.js"><link rel="prefetch" href="./assets/js/78.b8fc2c30.js"><link rel="prefetch" href="./assets/js/79.7665732d.js"><link rel="prefetch" href="./assets/js/8.6ff51652.js"><link rel="prefetch" href="./assets/js/80.03e59e67.js"><link rel="prefetch" href="./assets/js/81.a6236c2f.js"><link rel="prefetch" href="./assets/js/82.88a5092b.js"><link rel="prefetch" href="./assets/js/83.e93ce178.js"><link rel="prefetch" href="./assets/js/84.8eb37a19.js"><link rel="prefetch" href="./assets/js/85.9d8d91db.js"><link rel="prefetch" href="./assets/js/86.14696351.js"><link rel="prefetch" href="./assets/js/87.51a4cddc.js"><link rel="prefetch" href="./assets/js/88.5cb86311.js"><link rel="prefetch" href="./assets/js/89.11fe5589.js"><link rel="prefetch" href="./assets/js/9.aaa202b7.js"><link rel="prefetch" href="./assets/js/90.b3555572.js">
    <link rel="stylesheet" href="./assets/css/0.styles.74c59701.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><!----> <span class="site-name">卷心菜笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./main/" class="nav-link router-link-active">
  正文
</a></div><div class="nav-item"><a href="/./appendix/mergeOptions.html" class="nav-link">
  附录
</a></div><div class="nav-item"><a href="/./util/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/w781223592/vue2.0-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/./main/" class="nav-link router-link-active">
  正文
</a></div><div class="nav-item"><a href="/./appendix/mergeOptions.html" class="nav-link">
  附录
</a></div><div class="nav-item"><a href="/./util/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/w781223592/vue2.0-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/./main/" aria-current="page" class="sidebar-link">前言</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第一章 初识Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter1/1-1.html" class="sidebar-link">1.1 Vue目录设计</a></li><li><a href="/./main/chapter1/1-2.html" class="sidebar-link">1.2 Vue入口文件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第二章 Vue初始化和挂载</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter2/2-1.html" class="sidebar-link">2.1 new Vue()时做了什么</a></li><li><a href="/./main/chapter2/2-2.html" class="sidebar-link">2.2 Vue实例挂载的实现</a></li><li><a href="/./main/chapter2/2-3.html" class="sidebar-link">2.3 Vue挂载时的mountComponent</a></li><li><a href="/./main/chapter2/2-4.html" class="sidebar-link">2.4 Virtual DOM</a></li><li><a href="/./main/chapter2/2-5.html" class="sidebar-link">2.5 最终的挂载方法_update</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第三章 组件化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter3/3-1.html" class="sidebar-link">3.1 创建组件vnode</a></li><li><a href="/./main/chapter3/3-2.html" class="sidebar-link">3.2 组件的patch过程</a></li><li><a href="/./main/chapter3/3-3.html" class="sidebar-link">3.3 合并配置</a></li><li><a href="/./main/chapter3/3-4.html" class="sidebar-link">3.4 生命周期（上）</a></li><li><a href="/./main/chapter3/3-5.html" class="sidebar-link">3.5 生命周期（下）</a></li><li><a href="/./main/chapter3/3-6.html" class="sidebar-link">3.6 组件的注册</a></li><li><a href="/./main/chapter3/3-7.html" class="sidebar-link">3.7 异步组件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第四章 响应式原理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter4/4-1.html" class="sidebar-link">4.1 响应式对象</a></li><li><a href="/./main/chapter4/4-2.html" class="sidebar-link">4.2 依赖收集（上）</a></li><li><a href="/./main/chapter4/4-3.html" class="sidebar-link">4.3 依赖收集（下）</a></li><li><a href="/./main/chapter4/4-4.html" class="sidebar-link">4.4 派发更新</a></li><li><a href="/./main/chapter4/4-5.html" class="sidebar-link">4.5 nextTick</a></li><li><a href="/./main/chapter4/4-6.html" class="sidebar-link">4.6 检测变化的坑</a></li><li><a href="/./main/chapter4/4-7.html" class="sidebar-link">4.7 计算属性</a></li><li><a href="/./main/chapter4/4-8.html" class="sidebar-link">4.8 侦听器</a></li><li><a href="/./main/chapter4/4-9.html" class="sidebar-link">4.9 组件更新</a></li><li><a href="/./main/chapter4/4-10.html" class="sidebar-link">4.10 diff算法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>第五章 编译</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter5/5-1.html" class="sidebar-link">5.1 初探编译器</a></li><li><a href="/./main/chapter5/5-2.html" class="sidebar-link">5.2 从入口开始</a></li><li><a href="/./main/chapter5/5-3.html" aria-current="page" class="active sidebar-link">5.3 parse之解析模板（上）</a></li><li><a href="/./main/chapter5/5-4.html" class="sidebar-link">5.4 parse之解析模板（下）</a></li><li><a href="/./main/chapter5/5-5.html" class="sidebar-link">5.5 parse之生成AST（1）</a></li><li><a href="/./main/chapter5/5-6.html" class="sidebar-link">5.6 parse之生成AST（2）</a></li><li><a href="/./main/chapter5/5-7.html" class="sidebar-link">5.7 parse之生成AST（3）</a></li><li><a href="/./main/chapter5/5-8.html" class="sidebar-link">5.8 parse之生成AST（4）</a></li><li><a href="/./main/chapter5/5-9.html" class="sidebar-link">5.9 parse之生成AST（5）</a></li><li><a href="/./main/chapter5/5-10.html" class="sidebar-link">5.10 optimize优化</a></li><li><a href="/./main/chapter5/5-11.html" class="sidebar-link">5.11 generate代码生成（1）</a></li><li><a href="/./main/chapter5/5-12.html" class="sidebar-link">5.12 generate代码生成（2）</a></li><li><a href="/./main/chapter5/5-13.html" class="sidebar-link">5.13 generate代码生成（3）</a></li><li><a href="/./main/chapter5/5-14.html" class="sidebar-link">5.14 generate代码生成（4）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第六章 扩展</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter6/6-1.html" class="sidebar-link">6.1 events（1）</a></li><li><a href="/./main/chapter6/6-2.html" class="sidebar-link">6.2 events（2）</a></li><li><a href="/./main/chapter6/6-3.html" class="sidebar-link">6.3 events（3）</a></li><li><a href="/./main/chapter6/6-4.html" class="sidebar-link">6.4 events（4）</a></li><li><a href="/./main/chapter6/6-5.html" class="sidebar-link">6.5 v-model（1）</a></li><li><a href="/./main/chapter6/6-6.html" class="sidebar-link">6.6 v-model（2）</a></li><li><a href="/./main/chapter6/6-7.html" class="sidebar-link">6.7 v-model（3）</a></li><li><a href="/./main/chapter6/6-8.html" class="sidebar-link">6.8 v-model（4）</a></li><li><a href="/./main/chapter6/6-9.html" class="sidebar-link">6.9 slot（上）</a></li><li><a href="/./main/chapter6/6-10.html" class="sidebar-link">6.10 slot（中）</a></li><li><a href="/./main/chapter6/6-11.html" class="sidebar-link">6.11 slot（下）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第七章 内置组件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter7/7-1.html" class="sidebar-link">7.1 keep-alive（上）</a></li><li><a href="/./main/chapter7/7-2.html" class="sidebar-link">7.2 keep-alive（下）</a></li><li><a href="/./main/chapter7/7-3.html" class="sidebar-link">7.3 transition（上）</a></li><li><a href="/./main/chapter7/7-4.html" class="sidebar-link">7.4 transition（中）</a></li><li><a href="/./main/chapter7/7-5.html" class="sidebar-link">7.5 transition（下）</a></li><li><a href="/./main/chapter7/7-6.html" class="sidebar-link">7.6 transition-group</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第八章 Vue-router</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./main/chapter8/8-1.html" class="sidebar-link">8.1 vue-router的注册</a></li><li><a href="/./main/chapter8/8-2.html" class="sidebar-link">8.2 VueRouter实例化</a></li><li><a href="/./main/chapter8/8-3.html" class="sidebar-link">8.3 动态路由</a></li><li><a href="/./main/chapter8/8-4.html" class="sidebar-link">8.4 match</a></li><li><a href="/./main/chapter8/8-5.html" class="sidebar-link">8.5 导航守卫（上）</a></li><li><a href="/./main/chapter8/8-6.html" class="sidebar-link">8.6 导航守卫（中）</a></li><li><a href="/./main/chapter8/8-7.html" class="sidebar-link">8.7 导航守卫（下）</a></li><li><a href="/./main/chapter8/8-8.html" class="sidebar-link">8.8 路径切换</a></li><li><a href="/./main/chapter8/8-9.html" class="sidebar-link">8.9 router-view组件</a></li><li><a href="/./main/chapter8/8-10.html" class="sidebar-link">8.10 router-link组件</a></li><li><a href="/./main/chapter8/8-11.html" class="sidebar-link">8.11 history模式</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_5-3-parse之解析模板-上"><a href="#_5-3-parse之解析模板-上" class="header-anchor">#</a> 5.3 parse之解析模板（上）</h1> <p>  上个小节我们从入口开始分析了编译的整体流程，这个小节开始根据<code>baseCompile</code>这个核心函数来分析我们的编译过程中的三个核心内容。接下来我们就来分析<code>parse</code>方法生成<code>AST</code>语法树的过程吧！<br>
  首先我们需要简单了解一下什么是AST（<code>Abstract Syntax Tree</code>，<code>AST</code>抽象语法树），它是源代码语法结构的一种抽象表示。它以树状的形式表现编程语言的语法结构，树上的每个节点都表示源代码中的一种结构。<br>
  之所以说语法是“抽象”的，是因为这里的语法并不会表示出真实语法中出现的每个细节。比如，嵌套括号被隐含在树的结构中，并没有以节点的形式呈现；而类似于<code>if-condition-then</code>这样的条件跳转语句，可以使用带有两个分支的节点来表示。<br>
  和抽象语法树相对的是具体语法树（通常称作分析树）。一般的，在源代码的翻译和编译过程中，语法分析器创建出分析树。一旦<code>AST</code>被创建出来，在后续的处理过程中，比如语义分析阶段，会添加一些信息。<br>
  在计算机科学和语言学中，语法分析（英语：<code>syntactic analysis</code>，也叫<code>parsing</code>）是根据某种给定的形式文法对由单词序列（如英语单词序列）构成的输入文本进行分析并确定其语法结构的一种过程。<br>
  语法分析器（parser）通常是作为编译器或解释器的组件出现的，它的作用是进行语法检查、并构建由输入的单词组成的数据结构（一般是语法分析树、抽象语法树等层次化的数据结构）。语法分析器通常使用一个独立的词法分析器从输入字符流中分离出一个个的“单词”，并将单词流作为其输入。实际开发中，语法分析器可以手工编写，也可以使用工具（半）自动生成。<br>
  像我们<code>babel</code>为什么能将<code>es6</code>编译成<code>es5</code>，就是因为它会先生成<code>AST</code>，说白了就是做翻译，比如<code>let</code>和<code>var</code>翻译后都是声明变量意思，然后我们预先定义好把<code>let</code>转化为<code>var</code>的规则，当解析到<code>let</code>单词时就可以把它处理了。<br>
  简单了解什么是<code>AST</code>后，接下来我们就正式分析<code>parse</code>生成<code>AST</code>的过程，<code>parse</code>方法定义在<code>compiler/parser/index.js</code>中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parse</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">template</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> CompilerOptions</span>
<span class="token punctuation">)</span><span class="token operator">:</span> ASTElement <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>

  <span class="token function">parseHTML</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    warn<span class="token punctuation">,</span>
    <span class="token literal-property property">expectHTML</span><span class="token operator">:</span> options<span class="token punctuation">.</span>expectHTML<span class="token punctuation">,</span>
    <span class="token literal-property property">isUnaryTag</span><span class="token operator">:</span> options<span class="token punctuation">.</span>isUnaryTag<span class="token punctuation">,</span>
    <span class="token literal-property property">canBeLeftOpenTag</span><span class="token operator">:</span> options<span class="token punctuation">.</span>canBeLeftOpenTag<span class="token punctuation">,</span>
    <span class="token literal-property property">shouldDecodeNewlines</span><span class="token operator">:</span> options<span class="token punctuation">.</span>shouldDecodeNewlines<span class="token punctuation">,</span>
    <span class="token literal-property property">shouldDecodeNewlinesForHref</span><span class="token operator">:</span> options<span class="token punctuation">.</span>shouldDecodeNewlinesForHref<span class="token punctuation">,</span>
    <span class="token literal-property property">shouldKeepComment</span><span class="token operator">:</span> options<span class="token punctuation">.</span>comments<span class="token punctuation">,</span>
    <span class="token literal-property property">outputSourceRange</span><span class="token operator">:</span> options<span class="token punctuation">.</span>outputSourceRange<span class="token punctuation">,</span>
    <span class="token function">start</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> unary<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">end</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">chars</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">text</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">start</span><span class="token operator">:</span> number<span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">comment</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">text</span><span class="token operator">:</span> string<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> root
<span class="token punctuation">}</span>
</code></pre></div><p>  这个方法复杂的过分，光其定义代码就足足近400行，如果放在我们文档中足足有9页之多，所以我们只能分开来分析它了。<br>
  简化后来看<code>parse</code>非常简单，就是执行一些代码然后执行<code>parseHTML</code>方法，这个方法调用时传了<code>template</code>和一个复杂的对象。<br>
  然后我们来看看<code>parseHTML</code>方法，其定义在<code>compiler/parser/html-parser.js</code>，代码开头是大量的正则和常量</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Regular Expressions for parsing tags and attributes</span>
<span class="token keyword">const</span> attribute <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*([^\s&quot;'&lt;&gt;\/=]+)(?:\s*(=)\s*(?:&quot;([^&quot;]*)&quot;+|'([^']*)'+|([^\s&quot;'=&lt;&gt;`]+)))?</span><span class="token regex-delimiter">/</span></span>
<span class="token keyword">const</span> dynamicArgAttribute <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*((?:v-[\w-]+:|@|:|#)\[[^=]+?\][^\s&quot;'&lt;&gt;\/=]*)(?:\s*(=)\s*(?:&quot;([^&quot;]*)&quot;+|'([^']*)'+|([^\s&quot;'=&lt;&gt;`]+)))?</span><span class="token regex-delimiter">/</span></span>
<span class="token keyword">const</span> ncname <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[a-zA-Z_][\\-\\.0-9_a-zA-Z</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>unicodeRegExp<span class="token punctuation">.</span>source<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]*</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> qnameCapture <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">((?:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\:)?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> startTagOpen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>qnameCapture<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token keyword">const</span> startTagClose <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*(\/?)&gt;</span><span class="token regex-delimiter">/</span></span>
<span class="token keyword">const</span> endTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^&lt;\\/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>qnameCapture<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">[^&gt;]*&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token keyword">const</span> doctype <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;!DOCTYPE [^&gt;]+&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span>
<span class="token comment">// #7298: escape - to avoid being passed as HTML comment when inlined in page</span>
<span class="token keyword">const</span> comment <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;!\--</span><span class="token regex-delimiter">/</span></span>
<span class="token keyword">const</span> conditionalComment <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;!\[</span><span class="token regex-delimiter">/</span></span>

<span class="token comment">// Special Elements (can contain anything)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> isPlainTextElement <span class="token operator">=</span> <span class="token function">makeMap</span><span class="token punctuation">(</span><span class="token string">'script,style,textarea'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> reCache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">const</span> decodingMap <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'&amp;lt;'</span><span class="token operator">:</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'&amp;gt;'</span><span class="token operator">:</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'&amp;quot;'</span><span class="token operator">:</span> <span class="token string">'&quot;'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'&amp;amp;'</span><span class="token operator">:</span> <span class="token string">'&amp;'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'&amp;#10;'</span><span class="token operator">:</span> <span class="token string">'\n'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'&amp;#9;'</span><span class="token operator">:</span> <span class="token string">'\t'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'&amp;#39;'</span><span class="token operator">:</span> <span class="token string">&quot;'&quot;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> encodedAttr <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;(?:lt|gt|quot|amp|#39);</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>
<span class="token keyword">const</span> encodedAttrWithNewLines <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;(?:lt|gt|quot|amp|#39|#10|#9);</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>

<span class="token comment">// #5992</span>
<span class="token keyword">const</span> isIgnoreNewlineTag <span class="token operator">=</span> <span class="token function">makeMap</span><span class="token punctuation">(</span><span class="token string">'pre,textarea'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">shouldIgnoreFirstNewline</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> html</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> tag <span class="token operator">&amp;&amp;</span> <span class="token function">isIgnoreNewlineTag</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> html<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'\n'</span>

<span class="token keyword">function</span> <span class="token function">decodeAttr</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> shouldDecodeNewlines</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> re <span class="token operator">=</span> shouldDecodeNewlines <span class="token operator">?</span> encodedAttrWithNewLines <span class="token operator">:</span> encodedAttr
  <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>re<span class="token punctuation">,</span> <span class="token parameter">match</span> <span class="token operator">=&gt;</span> decodingMap<span class="token punctuation">[</span>match<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>  这种复杂的逻辑，我们把它放到<a href="/./appendix/compile.html">compile文档</a>中解析，接下来我们就来看<code>parseHTML</code>的内容，首先是执行</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parseHTML</span><span class="token punctuation">(</span><span class="token parameter">html<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> expectHTML <span class="token operator">=</span> options<span class="token punctuation">.</span>expectHTML
  <span class="token keyword">const</span> isUnaryTag <span class="token operator">=</span> options<span class="token punctuation">.</span>isUnaryTag <span class="token operator">||</span> no
  <span class="token keyword">const</span> canBeLeftOpenTag <span class="token operator">=</span> options<span class="token punctuation">.</span>canBeLeftOpenTag <span class="token operator">||</span> no
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> last<span class="token punctuation">,</span> lastTag
<span class="token punctuation">}</span>
</code></pre></div><p>  定义一些变量，<code>stack</code>是很有用的一个东西，我们接下来用到时会详细的分析，然后<code>expectHTML</code>、<code>isUnaryTag</code>和<code>canBeLeftOpenTag</code>是几个编译配置选项。还定义了<code>index、last、lastTag</code>等变量，这个等我们用到了再去逐一去分析。<br>
  接下来<code>parseHTML</code>中执行了一段很复杂的<code>while</code>循环</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">while</span> <span class="token punctuation">(</span>html<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    last <span class="token operator">=</span> html
    <span class="token comment">// Make sure we're not in a plaintext content element like script/style</span>
    <span class="token comment">// 确保我们不在像script/style这样的纯文本内容元素中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lastTag <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isPlainTextElement</span><span class="token punctuation">(</span>lastTag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>html <span class="token operator">===</span> last<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  我们把它拆解来看其实就是这么几个<code>if</code>语句。这里判断得<code>html</code>其实就是我们传入的<code>template</code>，这里首先是把<code>last</code>赋值为<code>html</code>。然后第一个判断是判断如果不存在<code>lastTag</code>或者<code>lastTag</code>不是纯文本元素标签时就会执行<code>if</code>中的逻辑。<br>
  从这里也可以看出<code>last</code>其实就接下来要处理的模板字符串，<code>lastTag</code>应该就是下一个处理的标签了。然后我们来<code>if</code>中的内容</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> textEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span>
  <span class="token comment">// 如果是以&lt;开头的话</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>textEnd <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Comment:</span>
    <span class="token comment">// 如果为注释节点的话</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// http://en.wikipedia.org/wiki/Conditional_comment#Downlevel-revealed_conditional_comment</span>
    <span class="token comment">// 如果为条件注释的话</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>conditionalComment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// Doctype:</span>
    <span class="token comment">// 如果是doctype的话</span>
    <span class="token keyword">const</span> doctypeMatch <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>doctype<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>doctypeMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// End tag:</span>
    <span class="token comment">// 如果是结束标签</span>
    <span class="token keyword">const</span> endTagMatch <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>endTagMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// Start tag:</span>
    <span class="token comment">// 如果开始标签</span>
    <span class="token keyword">const</span> startTagMatch <span class="token operator">=</span> <span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>startTagMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  可以看到先要获取第一个<code>'&lt;'</code>标记的位置保存在<code>textEnd</code>中，接下来又是一个大的<code>if</code>判断，判断<code>html</code>是不是以<code>'&lt;'</code>标记开头，也就是标签的开始。如果满足是以<code>'&lt;'</code>开头的话就又分了五种情况讨论：<br>
  ①注释节点的情况；<br>
  ②条件注释的情况；<br>
  ③DOCTYPE标签的情况；<br>
  ④如果是结束标签的'&lt;'；<br>
  ⑤如果是开始标签的'&lt;'。<br>
  接下来我们就这五种情况开始分析：<br>
  如果是注释节点的话:</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> commentEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'--&gt;'</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>commentEnd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// options.shouldKeepComment为Vue 选项 comments 的值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>shouldKeepComment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span><span class="token function">comment</span><span class="token punctuation">(</span>html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> commentEnd<span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> index <span class="token operator">+</span> commentEnd <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token function">advance</span><span class="token punctuation">(</span>commentEnd <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span>
      <span class="token keyword">continue</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  对于正则这部分我们前面已经说过了，这里就不纠结怎么实现注释节点的判断了。这里首先获取<code>'--&gt;'</code>在<code>html</code>中的位置保存在<code>commentEnd</code>，因为我们需要找到注释节点的结束位置，才能确定注释节点的内容有多少，并且<code>comment</code>正则只能判断条件注释的开头，只有找到结束标识才能确定是注释节点，如果找不到的话则不是注释节点，那么就什么都不做。<br>
  接下来判断<code>options.shouldKeepComment</code>，也就是用户配置的<code>comments</code>选项为<code>true</code>时就执行<code>options.comment</code>方法去处理注释节点，这个方法是传入的<code>options</code>中的方法，这个方法我们暂时不放到这里去讲，等我们回过头讲解<code>parse</code>方法时再去分析它。这里我们分析一下它传入的参数，第一个参数是<code>html.substring(4, commentEnd)</code>，也就是从<code>html</code>第5个位置开始截取到<code>'--&gt;'</code>的位置，为什么是从第5位开始，因为我们前4位是<code>&lt;!--</code>，所以第一个参数截取的是注释节点的内容；第二个参数是<code>index</code>，目前我们还你没有看到它在哪里修改所以可以认为它是初始值0；第三个参数是一个计算，计算值其实就是注释节点结束标记<code>'--&gt;'</code>中<code>'&gt;'</code>后面一位索引。<br>
  需要注意的是：这里计算的是<code>template</code>从一开始到目前处理位置的索引，而不是注释节点内容长度的索引。因为<code>index</code>可能不是0，如果注释节点前面还有其它内容的话，比如
<code>'&lt;div&gt;a&lt;/div&gt;&lt;!-- 注释 --&gt;'</code>
可以看到注释节点之前有个<code>div</code>标签，这种情况下<code>index</code>就是12，也就是注释节点开始的位置。为什么是这样我们下面就会说明。
最后是执行<code>advance</code>方法然后跳到下一个循环</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">advance</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    index <span class="token operator">+=</span> n
    html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  这里传入的<code>n</code>是<code>commentEnd + 3</code>，这个计算出来的是注释节点的长度，这是为什么呢？我们从<code>advance</code>方法就可以得到答案，<code>index += n</code>然后把<code>html</code>截取从第n位开始到最后一位并赋值给<code>html</code>。<br>
  我们一开始<code>index</code>为<code>0</code>，如果处理的第一个节点是注释节点的话，这里的n就是计算出的注释节点长度，然后执行<code>advance</code>方法后<code>index</code>变为注释节点内容后一位索引，然后还要截取<code>html</code>字符串，也就是把注释节点去掉。
这样下次循环就开始从注释节点后面开始解析了，但是<code>index</code>这时已经记录上次处理字符串的长度。实际上不光是注释节点会这么处理，所有节点解析都会通过<code>advance</code>方法处理。所以<code>index</code>是永远累加的，表示的是当前解析位置相对于初始模板字符串的索引，也就是用来记录我们解析位置的。而<code>html</code>则是一直被截取的，表示当前为解析的模板内容。而每次循环时候都会将<code>html</code>赋值给<code>last</code>，所以<code>last</code>就是当前要解析的模板，也可以说是当前还未被解析的模板。<br>
  如果是条件注释节点：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// http://en.wikipedia.org/wiki/Conditional_comment#Downlevel-revealed_conditional_comment</span>
  <span class="token comment">// 如果为条件注释的话</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>conditionalComment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> conditionalEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">']&gt;'</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>conditionalEnd <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">advance</span><span class="token punctuation">(</span>conditionalEnd <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token keyword">continue</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  和注释节点基本相同的，但是对于条件注释我们是不做任何处理的。<br>
  如果是<code>DOCTYPE</code>节点：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> doctypeMatch <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>doctype<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>doctypeMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">advance</span><span class="token punctuation">(</span>doctypeMatch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
    <span class="token keyword">continue</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  同样是没有做任何处理的，<code>Vue</code>也不会保留<code>DOCTYPE</code>节点，因为原则上不应该在<code>Vue template</code>中去写<code>DOCTYPE</code>节点的。<br>
  如果是开始标签：</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token comment">// Start tag:</span>
    <span class="token comment">// 如果开始标签</span>
    <span class="token keyword">const</span> startTagMatch <span class="token operator">=</span> <span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>startTagMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handleStartTag</span><span class="token punctuation">(</span>startTagMatch<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldIgnoreFirstNewline</span><span class="token punctuation">(</span>startTagMatch<span class="token punctuation">.</span>tagName<span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">advance</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">continue</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>  实际上<code>vue</code>是先判断结束标签再判断开始标签的，但是正常情况我们去模板的处理都是先从开始标签开始的，我们按照模板解析顺序来分析就更容易理解了。<br>
  这里执行<code>parseStartTag</code>方法后得到<code>startTagMatch</code>，接下来看<code>parseStartTag</code>方法：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagOpen<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">tagName</span><span class="token operator">:</span> start<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">attrs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">start</span><span class="token operator">:</span> index
      <span class="token punctuation">}</span>
      <span class="token function">advance</span><span class="token punctuation">(</span>start<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
      <span class="token keyword">let</span> end<span class="token punctuation">,</span> attr
      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>end <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagClose<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>attr <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>dynamicArgAttribute<span class="token punctuation">)</span> <span class="token operator">||</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        attr<span class="token punctuation">.</span>start <span class="token operator">=</span> index
        <span class="token function">advance</span><span class="token punctuation">(</span>attr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
        attr<span class="token punctuation">.</span>end <span class="token operator">=</span> index
        match<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 一元标签斜杠</span>
        match<span class="token punctuation">.</span>unarySlash <span class="token operator">=</span> end<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token function">advance</span><span class="token punctuation">(</span>end<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
        match<span class="token punctuation">.</span>end <span class="token operator">=</span> index
        <span class="token keyword">return</span> match
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  这里假如我们用这样一个模板去匹配</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>我是模板<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>start</code>结果如下：<code>['&lt;div', 'div', index: 0, input: '&lt;div&gt;我是模板&lt;/div&gt;', groups: undefined]</code><br>
  这个是一个有两个元素的数组，<code>index</code>这是匹配结果开始位置，<code>input</code>是搜索的字符串，<code>group</code>为捕获组，这里我们是没有定义捕获组名称，所以是<code>undefined</code>。<br>
  如果匹配成功的话就创建<code>match</code>对象，<code>match</code>对象中放着<code>tagName</code>，取<code>start</code>第二个元素也就是这里的<code>'div'</code>，也就是匹配的内容，<code>attrs</code>初始化为空数组，<code>start</code>则是设置为<code>index</code>，这里<code>index</code>不是我们<code>match</code>结果中的<code>index</code>，是记录解析模板位置的标识。
<code>start[0]</code>是真正匹配到的内容，也就是<code>'&lt;div'</code>，这里获得匹配内容的长度然后同样交给<code>advance</code>去处理。<br>
  接下来定义<code>end</code>和<code>attr</code>，<code>end</code>是用来保存<code>startTagClose</code>标签结果的，也就是匹配开始标签的闭合标记。接下来这个<code>while</code>循环就要在<code>end</code>不存在时候才会执行，因为我们解析到<code>'&lt;div'</code>时，它后面还可能添加了属性，所以要通过匹配动态命名属性或匹配属性的正则去<code>match</code>匹配，匹配的结果用<code>attr</code>保存。所以这段逻辑就是去处理标签的属性了，因为不确定有几个属性，所以这里要用<code>while</code>来做循环，当匹配到闭合标记时属性就一定被解析完了，所以跳出循环。<br>
  我们来看<code>while</code>循环体做了什么，将<code>index</code>赋值给<code>attr.start</code>，然后<code>advance</code>。这个单词有前进的意思，我们解析过程也是在一步步“前进”。然后<code>attr.end</code>再赋值为<code>index</code>，因为<code>advance</code>执行后<code>index</code>改变了，这里就是记录属性的起始位置和末位的下一位，注意<code>end</code>不是末位而是末位的下一位。然后将<code>attr</code>添加到<code>match.attrs</code>中。<br>
  当匹配到开始标签结束标识时或者匹配不到属性时会跳出循环，这时再判断<code>end</code>如果存在，就将<code>match.unarySlash</code>赋值为<code>end[1]</code>，顾名思义一元标签斜杠，一元标签就是指单标签as：<code>&lt;input/&gt;</code>。这时<code>end[1]</code>就是<code>'/'</code>，如果不是单标签就是空字符串，然后调用前进方法，接着把<code>match.end</code>设置为<code>index</code>，最后把<code>match</code>给返回。<br>
  如果返回的<code>match</code>不为<code>null</code>，那就执行<code>handleStartTag</code>方法</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">handleStartTag</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> tagName <span class="token operator">=</span> match<span class="token punctuation">.</span>tagName
    <span class="token keyword">const</span> unarySlash <span class="token operator">=</span> match<span class="token punctuation">.</span>unarySlash

    <span class="token keyword">if</span> <span class="token punctuation">(</span>expectHTML<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>lastTag <span class="token operator">===</span> <span class="token string">'p'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNonPhrasingTag</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">parseEndTag</span><span class="token punctuation">(</span>lastTag<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canBeLeftOpenTag</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> lastTag <span class="token operator">===</span> tagName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">parseEndTag</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> unary <span class="token operator">=</span> <span class="token function">isUnaryTag</span><span class="token punctuation">(</span>tagName<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span>unarySlash
    <span class="token keyword">const</span> l <span class="token operator">=</span> match<span class="token punctuation">.</span>attrs<span class="token punctuation">.</span>length
    <span class="token keyword">const</span> attrs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> args <span class="token operator">=</span> match<span class="token punctuation">.</span>attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">||</span> args<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">||</span> args<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">''</span>
      <span class="token keyword">const</span> shouldDecodeNewlines <span class="token operator">=</span> tagName <span class="token operator">===</span> <span class="token string">'a'</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'href'</span>
        <span class="token operator">?</span> options<span class="token punctuation">.</span>shouldDecodeNewlinesForHref
        <span class="token operator">:</span> options<span class="token punctuation">.</span>shouldDecodeNewlines
      attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">decodeAttr</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> shouldDecodeNewlines<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>outputSourceRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>start <span class="token operator">=</span> args<span class="token punctuation">.</span>start <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>length
        attrs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>end <span class="token operator">=</span> args<span class="token punctuation">.</span>end
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>unary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">tag</span><span class="token operator">:</span> tagName<span class="token punctuation">,</span> <span class="token literal-property property">lowerCasedTag</span><span class="token operator">:</span> tagName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">attrs</span><span class="token operator">:</span> attrs<span class="token punctuation">,</span> <span class="token literal-property property">start</span><span class="token operator">:</span> match<span class="token punctuation">.</span>start<span class="token punctuation">,</span> <span class="token literal-property property">end</span><span class="token operator">:</span> match<span class="token punctuation">.</span>end <span class="token punctuation">}</span><span class="token punctuation">)</span>
      lastTag <span class="token operator">=</span> tagName
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      options<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>tagName<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> unary<span class="token punctuation">,</span> match<span class="token punctuation">.</span>start<span class="token punctuation">,</span> match<span class="token punctuation">.</span>end<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>  这里首先是获取标签名和一元斜杠。然后如果<code>expectHTML</code>存在的话就执行一段代码，这段代码调用<code>parseEndTag</code>方法，这是用来解析结束标签的，我们放到后面分析。<br>
  然后定义<code>unary</code>，<code>unary</code>则是先判断<code>tagName</code>是不是一元标签，如果是的话返回<code>true</code>，如果不是的话再取<code>unarySlash</code>的结果。定义<code>l</code>去获取属性列表<code>attrs</code>的长度，然后<code>l</code>会作为下面循环的最大长度，这里还会生成一个长度为<code>l</code>的数组<code>attrs</code>。
  然后定义<code>value</code>，那么<code>value</code>是什么呢？其实是正则<code>attribute</code>匹配到的第三、四、五个捕获组。其实就是属性值，因为每次匹配都只有一个会被捕获到，所以就挨个去取，如果都取不到就返回空字符串。<br>
  然后就是对<code>shouldDecodeNewlines</code> 问题的处理，这个我们都分析过了。接下来就是把属性名和属性值都放到<code>attrs</code>数组中，这里处理<code>value</code>时用了<code>decodeAttr</code>方法去把一些<code>html</code>实体转化为对应字符。<br>
  接下来如果是非生产环境，并且<code>outputSourceRange</code>为<code>true</code>的话还要给<code>attrs</code>中的元素设置<code>start</code>和<code>end</code>属性。但是这里要处理<code>start</code>，因为我们属性总是在<code>tag</code>标签后面通过空格等空白字符分隔的，这时<code>args.start</code>是空格的索引，然后这里就是要把这个空格跳过。<code>end</code>的话直接去<code>args.end</code>就可以了。<br>
  循环完成后判断非一元标签的情况，如果是非一元标签就要往<code>stack</code>数组中<code>push</code>一个对象，这个对象是这样的：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token comment">// 标签名称</span>
    <span class="token literal-property property">lowerCasedTag</span><span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token comment">// 标签名全部小写处理</span>
    <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token comment">// 标签开始索引</span>
    <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">37</span><span class="token punctuation">,</span> <span class="token comment">// 左标签结束索引</span>
    <span class="token literal-property property">attrs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token comment">// a属性</span>
      <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">36</span><span class="token punctuation">,</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">29</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&quot;sda&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span> 
  <span class="token punctuation">}</span>
</code></pre></div><p>  stack是什么我们在后面的分析中就会详细说明，这里先留一个悬念，只要记住遇到非一元标签的开始标签就会往里面添加内容。然后接下来就会将<code>lastTag</code>赋值为<code>tagName</code>，这里<code>lastTag</code>其实就是表示正在处理的标签名，<code>lastTag</code>是很重要的一个变量，这里我们需要记住它是在处理开始标签时第一次被赋值的。<br>
  接下来如果<code>options.start</code>存在就执行<code>options.start</code>方法去处理，这里传入的参数有点多，有<code>tagName、attrs、unary、match.start、match.end</code>。这个方法也是在<code>parse</code>函数中调用<code>parseHTML</code>时传入的，我们之后再来分析。因为<code>parse</code>方法是有很多前置实现的，这些方法都要依赖这些实现，所以这些方法才会定义在<code>parse</code>函数中。<br>
  接下来的判断就是看是否是需要忽略首个空白字符的标签，并且标签内第一个字符是空白字符就前进一格。到这里解析开始标签就结束了，但是好像没有调用前进方法，唯一调用还是在特定条件下跳过空格。但是我们思考一下为什么这里个时候执行判断是不是需要忽略首位空格内容的标签。这说明这个时候已经开始解析到标签中的内容了。假设还是我们上面那个例子，说明这个时候解析的应该是<code>'我是模板&lt;/div&gt;'</code>这部分内容了。<br>
  实际上我们回想一下解析开始标签的方法<code>parseStartTag</code>，其实在这里面解析到开始标签的结束标记<code>'&gt;'</code>时已经执行<code>advance</code>了，所以我们前进是在这里面做的。可以看到我们解析<code>template</code>就是按顺序一步步解析的，一旦解析完立马截掉这部分继续下一部分的解析，<code>parseHTML</code>就是这样设计的。<br>
  到目前为止我们还有最后一种情况没有分析：那就是匹配到结束标签的情况。我们还有一点没有提到，之前讲的四个判断包括之后我们要分析的匹配到结束标签的情况都同一执行了<code>continue</code>方法，也就是会进入下一次循环。下一次循环会发生什么我们放到下一个小节去分析。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/./main/chapter5/5-2.html" class="prev">
        5.2 从入口开始
      </a></span> <span class="next"><a href="/./main/chapter5/5-4.html">
        5.4 parse之解析模板（下）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.20317d9d.js" defer></script><script src="./assets/js/2.8a65079d.js" defer></script><script src="./assets/js/51.ea943f69.js" defer></script>
  </body>
</html>

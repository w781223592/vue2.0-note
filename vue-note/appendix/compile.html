<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>compile | 卷心菜笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="./logo.jpg">
    <meta name="description" content="基于vue@2.6.14的学习笔记">
    
    <link rel="preload" href="./assets/css/0.styles.74c59701.css" as="style"><link rel="preload" href="./assets/js/app.20317d9d.js" as="script"><link rel="preload" href="./assets/js/2.8a65079d.js" as="script"><link rel="preload" href="./assets/js/17.eee5b860.js" as="script"><link rel="prefetch" href="./assets/js/10.3d2f32ec.js"><link rel="prefetch" href="./assets/js/11.132a26b4.js"><link rel="prefetch" href="./assets/js/12.d0193009.js"><link rel="prefetch" href="./assets/js/13.07872830.js"><link rel="prefetch" href="./assets/js/14.96a92186.js"><link rel="prefetch" href="./assets/js/15.89c1bf18.js"><link rel="prefetch" href="./assets/js/16.78f7cadf.js"><link rel="prefetch" href="./assets/js/18.e94d03e8.js"><link rel="prefetch" href="./assets/js/19.9e73c1ac.js"><link rel="prefetch" href="./assets/js/20.ae18bc8e.js"><link rel="prefetch" href="./assets/js/21.d4a5ba0b.js"><link rel="prefetch" href="./assets/js/22.e7794d4a.js"><link rel="prefetch" href="./assets/js/23.adaee962.js"><link rel="prefetch" href="./assets/js/24.e1df98bf.js"><link rel="prefetch" href="./assets/js/25.c325e810.js"><link rel="prefetch" href="./assets/js/26.c24daaf7.js"><link rel="prefetch" href="./assets/js/27.a3f09949.js"><link rel="prefetch" href="./assets/js/28.123d6383.js"><link rel="prefetch" href="./assets/js/29.04a6e255.js"><link rel="prefetch" href="./assets/js/3.5a34bef2.js"><link rel="prefetch" href="./assets/js/30.f976c0a7.js"><link rel="prefetch" href="./assets/js/31.60d2f4c4.js"><link rel="prefetch" href="./assets/js/32.6b2a5515.js"><link rel="prefetch" href="./assets/js/33.6b80e89d.js"><link rel="prefetch" href="./assets/js/34.ea39628f.js"><link rel="prefetch" href="./assets/js/35.4c14bc3d.js"><link rel="prefetch" href="./assets/js/36.5f2b7559.js"><link rel="prefetch" href="./assets/js/37.57e976da.js"><link rel="prefetch" href="./assets/js/38.191568b8.js"><link rel="prefetch" href="./assets/js/39.f89500e6.js"><link rel="prefetch" href="./assets/js/4.9fb18247.js"><link rel="prefetch" href="./assets/js/40.a45a4a21.js"><link rel="prefetch" href="./assets/js/41.94ece143.js"><link rel="prefetch" href="./assets/js/42.224304d2.js"><link rel="prefetch" href="./assets/js/43.544241cd.js"><link rel="prefetch" href="./assets/js/44.6014c885.js"><link rel="prefetch" href="./assets/js/45.711ad2c3.js"><link rel="prefetch" href="./assets/js/46.19b76064.js"><link rel="prefetch" href="./assets/js/47.0a8f7a4f.js"><link rel="prefetch" href="./assets/js/48.da28ae74.js"><link rel="prefetch" href="./assets/js/49.97615384.js"><link rel="prefetch" href="./assets/js/5.0c239c66.js"><link rel="prefetch" href="./assets/js/50.06bd69e2.js"><link rel="prefetch" href="./assets/js/51.ea943f69.js"><link rel="prefetch" href="./assets/js/52.b4813218.js"><link rel="prefetch" href="./assets/js/53.c1ba1696.js"><link rel="prefetch" href="./assets/js/54.e1d1801c.js"><link rel="prefetch" href="./assets/js/55.ac7cd0ab.js"><link rel="prefetch" href="./assets/js/56.d55c7dcb.js"><link rel="prefetch" href="./assets/js/57.83bbfc8e.js"><link rel="prefetch" href="./assets/js/58.6996ec46.js"><link rel="prefetch" href="./assets/js/59.42c770e8.js"><link rel="prefetch" href="./assets/js/6.0600552c.js"><link rel="prefetch" href="./assets/js/60.919088d2.js"><link rel="prefetch" href="./assets/js/61.455d2404.js"><link rel="prefetch" href="./assets/js/62.40ba97a6.js"><link rel="prefetch" href="./assets/js/63.5b069dba.js"><link rel="prefetch" href="./assets/js/64.512e158a.js"><link rel="prefetch" href="./assets/js/65.6ca1c75b.js"><link rel="prefetch" href="./assets/js/66.0356130d.js"><link rel="prefetch" href="./assets/js/67.93a0d7df.js"><link rel="prefetch" href="./assets/js/68.7e44cc19.js"><link rel="prefetch" href="./assets/js/69.788a4d27.js"><link rel="prefetch" href="./assets/js/7.6346a45d.js"><link rel="prefetch" href="./assets/js/70.571f8a79.js"><link rel="prefetch" href="./assets/js/71.f54eb805.js"><link rel="prefetch" href="./assets/js/72.02cd77d0.js"><link rel="prefetch" href="./assets/js/73.66b6b1d0.js"><link rel="prefetch" href="./assets/js/74.96bf5acc.js"><link rel="prefetch" href="./assets/js/75.1b135bdd.js"><link rel="prefetch" href="./assets/js/76.6ed173f1.js"><link rel="prefetch" href="./assets/js/77.ee856c8d.js"><link rel="prefetch" href="./assets/js/78.b8fc2c30.js"><link rel="prefetch" href="./assets/js/79.7665732d.js"><link rel="prefetch" href="./assets/js/8.6ff51652.js"><link rel="prefetch" href="./assets/js/80.03e59e67.js"><link rel="prefetch" href="./assets/js/81.a6236c2f.js"><link rel="prefetch" href="./assets/js/82.88a5092b.js"><link rel="prefetch" href="./assets/js/83.e93ce178.js"><link rel="prefetch" href="./assets/js/84.8eb37a19.js"><link rel="prefetch" href="./assets/js/85.9d8d91db.js"><link rel="prefetch" href="./assets/js/86.14696351.js"><link rel="prefetch" href="./assets/js/87.51a4cddc.js"><link rel="prefetch" href="./assets/js/88.5cb86311.js"><link rel="prefetch" href="./assets/js/89.11fe5589.js"><link rel="prefetch" href="./assets/js/9.aaa202b7.js"><link rel="prefetch" href="./assets/js/90.b3555572.js">
    <link rel="stylesheet" href="./assets/css/0.styles.74c59701.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><!----> <span class="site-name">卷心菜笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./main/" class="nav-link">
  正文
</a></div><div class="nav-item"><a href="/./appendix/mergeOptions.html" class="nav-link">
  附录
</a></div><div class="nav-item"><a href="/./util/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/w781223592/vue2.0-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/./main/" class="nav-link">
  正文
</a></div><div class="nav-item"><a href="/./appendix/mergeOptions.html" class="nav-link">
  附录
</a></div><div class="nav-item"><a href="/./util/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/w781223592/vue2.0-note" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>附录</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./appendix/mergeOptions.html" class="sidebar-link">合并options</a></li><li><a href="/./appendix/initProxy.html" class="sidebar-link">初始化proxy</a></li><li><a href="/./appendix/initRender.html" class="sidebar-link">初始化render</a></li><li><a href="/./appendix/initState.html" class="sidebar-link">初始化state</a></li><li><a href="/./appendix/watcher.html" class="sidebar-link">watcher</a></li><li><a href="/./appendix/patch.html" class="sidebar-link">patch</a></li><li><a href="/./appendix/vue-router.html" class="sidebar-link">vue-router</a></li><li><a href="/./appendix/compile.html" aria-current="page" class="active sidebar-link">compile</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./appendix/compile.html#parse准备工作" class="sidebar-link">parse准备工作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./appendix/compile.html#_1-baseoptions" class="sidebar-link">1 baseOptions</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#_2-预处理" class="sidebar-link">2. 预处理</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#_3-属性增强处理" class="sidebar-link">3. 属性增强处理</a></li></ul></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#parse正则常量分析" class="sidebar-link">parse正则常量分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./appendix/compile.html#onre" class="sidebar-link">onRE</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#dirre" class="sidebar-link">dirRE</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#foraliasre" class="sidebar-link">forAliasRE</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#foriteratorre" class="sidebar-link">forIteratorRE</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#stripparensre" class="sidebar-link">stripParensRE</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#dynamicargre" class="sidebar-link">dynamicArgRE</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#argre" class="sidebar-link">argRE</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#bindre" class="sidebar-link">bindRE</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#propbindre" class="sidebar-link">propBindRE</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#modifierre" class="sidebar-link">modifierRE</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#slotre" class="sidebar-link">slotRE</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#linebreakre" class="sidebar-link">lineBreakRE</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#whitespace" class="sidebar-link">whitespace</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#invalidattributere" class="sidebar-link">invalidAttributeRE</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#decodehtmlcached" class="sidebar-link">decodeHTMLCached</a></li></ul></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#parsehtml正则常量分析" class="sidebar-link">parseHTML正则常量分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./appendix/compile.html#attribute" class="sidebar-link">attribute</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#dynamicargattribute" class="sidebar-link">dynamicArgAttribute</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#ncname" class="sidebar-link">ncname</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#qnamecapure" class="sidebar-link">qnameCapure</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#starttagopen" class="sidebar-link">startTagOpen</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#starttagclose" class="sidebar-link">startTagClose</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#endtag" class="sidebar-link">endTag</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#doctype" class="sidebar-link">doctype</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#comment" class="sidebar-link">comment</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#conditionalcomment" class="sidebar-link">conditionalComment</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#isplaintextelement" class="sidebar-link">isPlainTextElement</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#decodingmap" class="sidebar-link">decodingMap</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#encodedattr" class="sidebar-link">encodedAttr</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#encodedattrwithnewlines" class="sidebar-link">encodedAttrWithNewLines</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#isignorenewlinetag" class="sidebar-link">isIgnoreNewlineTag</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#shouldignorefirstnewline" class="sidebar-link">shouldIgnoreFirstNewline</a></li><li class="sidebar-sub-header"><a href="/./appendix/compile.html#decodeattr" class="sidebar-link">decodeAttr</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="compile"><a href="#compile" class="header-anchor">#</a> compile</h1> <h2 id="parse准备工作"><a href="#parse准备工作" class="header-anchor">#</a> parse准备工作</h2> <h3 id="_1-baseoptions"><a href="#_1-baseoptions" class="header-anchor">#</a> 1 baseOptions</h3> <p>作为一个平台相关的选项被传入<code>createCompiler</code>中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> baseOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./options'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createCompiler <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'compiler/index'</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> compile<span class="token punctuation">,</span> compileToFunctions <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createCompiler</span><span class="token punctuation">(</span>baseOptions<span class="token punctuation">)</span>
</code></pre></div><p>我们来看看<code>baseOptions</code>中有什么配置：
在<code>platforms/web/compiler/options.js</code>中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  isPreTag<span class="token punctuation">,</span>
  mustUseProp<span class="token punctuation">,</span>
  isReservedTag<span class="token punctuation">,</span>
  getTagNamespace
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/index'</span>

<span class="token keyword">import</span> modules <span class="token keyword">from</span> <span class="token string">'./modules/index'</span>
<span class="token keyword">import</span> directives <span class="token keyword">from</span> <span class="token string">'./directives/index'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> genStaticKeys <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'shared/util'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> isUnaryTag<span class="token punctuation">,</span> canBeLeftOpenTag <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./util'</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">baseOptions</span><span class="token operator">:</span> CompilerOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">expectHTML</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  modules<span class="token punctuation">,</span>
  directives<span class="token punctuation">,</span>
  isPreTag<span class="token punctuation">,</span>
  isUnaryTag<span class="token punctuation">,</span>
  mustUseProp<span class="token punctuation">,</span>
  canBeLeftOpenTag<span class="token punctuation">,</span>
  isReservedTag<span class="token punctuation">,</span>
  getTagNamespace<span class="token punctuation">,</span>
  <span class="token literal-property property">staticKeys</span><span class="token operator">:</span> <span class="token function">genStaticKeys</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先是<code>expectHTML</code>为<code>true</code>，<code>modules</code>则是在<code>'./modules/index'</code>中定义，然后<code>directives</code>定义在<code>'./directives/index'</code>。<br>
这些<code>util</code>工具都可以在<code>util</code>文档中找到，这里就不细说了。<br>
我们先来看<code>modules</code>是什么，在<code>compiler/modules/index</code>中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> klass <span class="token keyword">from</span> <span class="token string">'./class'</span>
<span class="token keyword">import</span> style <span class="token keyword">from</span> <span class="token string">'./style'</span>
<span class="token keyword">import</span> model <span class="token keyword">from</span> <span class="token string">'./model'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">[</span>
  klass<span class="token punctuation">,</span>
  style<span class="token punctuation">,</span>
  model
<span class="token punctuation">]</span>
</code></pre></div><p>导出这么一个数组，然后分别看一下<code>klass、style、model</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// klass</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">staticKeys</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'staticClass'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  transformNode<span class="token punctuation">,</span>
  genData
<span class="token punctuation">}</span>
<span class="token comment">// style</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">staticKeys</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'staticStyle'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  transformNode<span class="token punctuation">,</span>
  genData
<span class="token punctuation">}</span>
<span class="token comment">// model</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  preTransformNode
<span class="token punctuation">}</span>
</code></pre></div><p>然后把这么三个对象放到一个数组中去返回就是我们<code>modules</code>了，知道<code>modules</code>是个什么东西后就很容易理解<code>staticKeys</code>了，<code>genStatickeys</code>就是把<code>modules</code>所有项的<code>staticKeys</code>数组合并到一个数组并转化为字符串。所以就是<br> <code>'staticClass', 'staticStyle'</code><br>
再来看<code>directives</code>，在<code>compiler/directives/index</code>中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> model <span class="token keyword">from</span> <span class="token string">'./model'</span>
<span class="token keyword">import</span> text <span class="token keyword">from</span> <span class="token string">'./text'</span>
<span class="token keyword">import</span> html <span class="token keyword">from</span> <span class="token string">'./html'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  model<span class="token punctuation">,</span>
  text<span class="token punctuation">,</span>
  html
<span class="token punctuation">}</span>
</code></pre></div><p><code>model、text、html</code>都是一个函数。大概说到这里我们就可以往后看<code>parse</code>方法了，这些细节实现等我们执行到的时候再去分析会比较容易理解。<br>
在执行<code>parse</code>时会传入<code>options</code>配置，就是在<code>baseOptions</code>基础上合并了<code>$mount</code>方法中传入的配置，我们来把它写出来</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">comments</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token literal-property property">delimiters</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  <span class="token literal-property property">outputSourceRange</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">shouldDecodeNewlines</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">shouldDecodeNewlinesForHref</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token function-variable function">warn</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> range<span class="token punctuation">,</span> tip</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">__proto__</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">canBeLeftOpenTag</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">directives</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token function-variable function">model</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">,</span> <span class="token function-variable function">text</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">,</span> <span class="token function-variable function">html</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">expectHTML</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">getTagNamespace</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">getTagNamespace</span><span class="token punctuation">(</span><span class="token parameter">tag</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">isPreTag</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">tag</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">isReservedTag</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">tag</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">isUnaryTag</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>…<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function-variable function">mustUseProp</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> type<span class="token punctuation">,</span> attr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    staticKeys<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-预处理"><a href="#_2-预处理" class="header-anchor">#</a> 2. 预处理</h3> <h4 id="pretransformnode"><a href="#pretransformnode" class="header-anchor">#</a> preTransformNode</h4> <p>在<code>start</code>钩子函数中我们会执行<code>preTransformNode</code>方法的，我们知道<code>modules</code>数组在<code>web</code>平台有三个元素，但是有<code>preTransformNode</code>只有<code>model.js</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">preTransformNode</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement<span class="token punctuation">,</span> <span class="token literal-property property">options</span><span class="token operator">:</span> CompilerOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'input'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> map <span class="token operator">=</span> el<span class="token punctuation">.</span>attrsMap
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token punctuation">[</span><span class="token string">'v-model'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> typeBinding
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span><span class="token string">':type'</span><span class="token punctuation">]</span> <span class="token operator">||</span> map<span class="token punctuation">[</span><span class="token string">'v-bind:type'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      typeBinding <span class="token operator">=</span> <span class="token function">getBindingAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'type'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>typeBinding <span class="token operator">&amp;&amp;</span> map<span class="token punctuation">[</span><span class="token string">'v-bind'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      typeBinding <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>map<span class="token punctuation">[</span><span class="token string">'v-bind'</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">).type</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
</code></pre></div><p>如果是<code>input</code>标签的话，先获取<code>attrsMap</code>，如果不存在<code>v-model</code>属性的话直接返回，然后看有没有绑定动态的<code>type</code>，如果绑定了就调用<code>getBindingAttr</code>方法去处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getBindingAttr</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement<span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  getStatic<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span>string <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dynamicValue <span class="token operator">=</span>
    <span class="token function">getAndRemoveAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">':'</span> <span class="token operator">+</span> name<span class="token punctuation">)</span> <span class="token operator">||</span>
    <span class="token function">getAndRemoveAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'v-bind:'</span> <span class="token operator">+</span> name<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dynamicValue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">parseFilters</span><span class="token punctuation">(</span>dynamicValue<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>getStatic <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> staticValue <span class="token operator">=</span> <span class="token function">getAndRemoveAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>staticValue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>staticValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后通过<code>getAndRemoveAttr</code>方法处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getAndRemoveAttr</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement<span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  removeFromMap<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span>string <span class="token punctuation">{</span>
  <span class="token keyword">let</span> val
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>val <span class="token operator">=</span> el<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> list <span class="token operator">=</span> el<span class="token punctuation">.</span>attrsList
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> list<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">===</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>removeFromMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">delete</span> el<span class="token punctuation">.</span>attrsMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> val
<span class="token punctuation">}</span>
</code></pre></div><p>这个方法功能也很简单，如果这个属性值存在然后就把它从<code>attrsList</code>中删除，然后属性值会保存在<code>val</code>中，如果第三个参数为<code>true</code>，就把<code>attrsMap</code>中的属性也删除。最后返回<code>val</code>。简单描述这个功能就是取完即删，对象删除与否则全看第三个参数是否为<code>true</code>。<br>
显然这里是只删数组没有删对象。最后得到<code>dynamicValue</code>就是属性值<code>type</code>属性值。<br>
接下来再判断属性值存在的话就执行<code>parseFilters</code>方法去解析过滤器并返回，如果<code>dynamicValue</code>不存在再判断第三个参数没有传入<code>false</code>的话就去解析静态属性，如果解析到的话就将其属性值经过<code>JSON.stringify</code>处理后返回，这里为什么本身是个字符串还要经过处理呢？因为这是要保证我们它最终能被处理成字符串，因为我们后面代码生成时候通过<code>new Function</code>处理时单层字符串可能就会被变成一个变量，所以这里处理成一个双层字符串，确保最后生成的代码是一个字符串。<br>
回到<code>preTransformNode</code>函数中<br>
将获取到的<code>type</code>值赋值给<code>typeBinding</code>，如果没取到<code>type</code>值并且<code>typeBinding</code>也不存在，但是存在<code>v-bind</code>，这里就涉及了另一种绑定属性的方式，同时绑定多个属性：</p> <div class="language-vue extra-class"><pre class="language-vue"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-bind</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{ type: 'text' }<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这样去绑定<code>type</code>时就要把<code>typeBinding</code>处理为<code>(map['v-bind']).type</code>的形式，然后判断<code>typeBinding</code>存在的话就会执行下面逻辑：</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">if</span> <span class="token punctuation">(</span>typeBinding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ifCondition <span class="token operator">=</span> <span class="token function">getAndRemoveAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'v-if'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> ifConditionExtra <span class="token operator">=</span> ifCondition <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&amp;&amp;(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ifCondition<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>
      <span class="token keyword">const</span> hasElse <span class="token operator">=</span> <span class="token function">getAndRemoveAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'v-else'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span>
      <span class="token keyword">const</span> elseIfCondition <span class="token operator">=</span> <span class="token function">getAndRemoveAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'v-else-if'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
     <span class="token operator">...</span>省略部分代码
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里执行了一大段逻辑，先获取<code>v-if</code>属性保存在<code>ifCondition</code>中，如果获取到的话将他处理为<code>&amp;&amp; ifCondition</code>的形式。接下来判断有没有<code>v-else</code>属性，如果有的话会返回<code>''</code>，这时判断不为<code>null</code>的话就会给<code>hasElse</code>赋值为<code>true</code>，最后获取<code>v-else-if</code>属性值。<br>
再往下看是关于<code>checkbox</code>逻辑</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 1. checkbox</span>
  <span class="token keyword">const</span> branch0 <span class="token operator">=</span> <span class="token function">cloneASTElement</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
  <span class="token comment">// process for on the main node</span>
  <span class="token function">processFor</span><span class="token punctuation">(</span>branch0<span class="token punctuation">)</span>
  <span class="token function">addRawAttr</span><span class="token punctuation">(</span>branch0<span class="token punctuation">,</span> <span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'checkbox'</span><span class="token punctuation">)</span>
  <span class="token function">processElement</span><span class="token punctuation">(</span>branch0<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  branch0<span class="token punctuation">.</span>processed <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// prevent it from double-processed</span>
  branch0<span class="token punctuation">.</span>if <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>typeBinding<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)==='checkbox'</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> ifConditionExtra
  <span class="token function">addIfCondition</span><span class="token punctuation">(</span>branch0<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">exp</span><span class="token operator">:</span> branch0<span class="token punctuation">.</span>if<span class="token punctuation">,</span>
    <span class="token literal-property property">block</span><span class="token operator">:</span> branch0
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>首先是执行<code>cloneASTElement</code>方法获取<code>branch0</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">cloneASTElement</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createASTElement</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>tag<span class="token punctuation">,</span> el<span class="token punctuation">.</span>attrsList<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> el<span class="token punctuation">.</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>里面实际上是调用<code>createASTElement</code>克隆一个<code>AST</code>，取到之后还会做一些处理，比如处理<code>v-for</code>、将其<code>type</code>属性值设置为<code>checkbox</code>并添加到<code>el.attrsList</code>数组中。然后执行<code>processElement</code>方法，这里会将<code>options</code>作为参数传入，为其中的属性增强处理提供<code>options</code>参数。这些<code>process</code>系列方法我们会在正文中一一分析，<code>processElement</code>中的属性增强方法<code>transforms</code>我们会在本文档后面分析。<br>
接下来会给<code>branch0.processed</code>赋值为<code>true</code>，这个需要特别注意，因为这里已经进行过<code>process</code>系列函数处理了，后面在<code>start</code>钩子中如果遇到<code>processed</code>为<code>true</code>就会跳过这方法的处理，避免重复处理。<br>
接下来这个就是对判断的一个拼接，相当于<code>typeBinding === checkbox &amp;&amp; ifConditionExtra</code>。然后将其赋值给<code>branch0.if</code>。<br>
最后调用<code>addIfCondition</code>将<code>v-if</code>指令信息添加到元素对象中。<br>
然后接下来对<code>radio</code>和其他情况也做同一处理</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 2. add radio else-if condition</span>
  <span class="token keyword">const</span> branch1 <span class="token operator">=</span> <span class="token function">cloneASTElement</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
  <span class="token function">getAndRemoveAttr</span><span class="token punctuation">(</span>branch1<span class="token punctuation">,</span> <span class="token string">'v-for'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token function">addRawAttr</span><span class="token punctuation">(</span>branch1<span class="token punctuation">,</span> <span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'radio'</span><span class="token punctuation">)</span>
  <span class="token function">processElement</span><span class="token punctuation">(</span>branch1<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token function">addIfCondition</span><span class="token punctuation">(</span>branch0<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">exp</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>typeBinding<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)==='radio'</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> ifConditionExtra<span class="token punctuation">,</span>
    <span class="token literal-property property">block</span><span class="token operator">:</span> branch1
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 3. other</span>
  <span class="token keyword">const</span> branch2 <span class="token operator">=</span> <span class="token function">cloneASTElement</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
  <span class="token function">getAndRemoveAttr</span><span class="token punctuation">(</span>branch2<span class="token punctuation">,</span> <span class="token string">'v-for'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token function">addRawAttr</span><span class="token punctuation">(</span>branch2<span class="token punctuation">,</span> <span class="token string">':type'</span><span class="token punctuation">,</span> typeBinding<span class="token punctuation">)</span>
  <span class="token function">processElement</span><span class="token punctuation">(</span>branch2<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token function">addIfCondition</span><span class="token punctuation">(</span>branch0<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">exp</span><span class="token operator">:</span> ifCondition<span class="token punctuation">,</span>
    <span class="token literal-property property">block</span><span class="token operator">:</span> branch2
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>我们先接着往后看</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasElse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    branch0<span class="token punctuation">.</span>else <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>elseIfCondition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    branch0<span class="token punctuation">.</span>elseif <span class="token operator">=</span> elseIfCondition
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> branch0
</code></pre></div><p>如果<code>hasElse</code>存在则将<code>branch0.else</code>设置为<code>true</code>，如果<code>elseIfCondition</code>存在就将<code>branch0.elseif</code>设置为<code>elseIfCondition</code>。<br>
其实不难看出，实际上是强行添加<code>v-if</code>指令为<code>input</code>标签做了扩展，因为<code>input</code>标签对于不同<code>type</code>值表现不同，因为动态绑定<code>type</code>就可能动态切换。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>data[type]<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>type<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  扩展为
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>type === 'checkbox'<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>checkbox<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>data[type]<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">v-else-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>type === 'radio'<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>radio<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>data[type]<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">v-else</span> <span class="token attr-name">:type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>type<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>data[type]<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>就是对于绑定了<code>v-model</code>并且是动态<code>type</code>的<code>input</code>会在编译阶段就扩展为三种形式，这便于我们在代码生成时对其做判断处理，从而实现不同的功能。如果这里不做区分，那么在代码生成时就会做更多的工作。<br>
当然即使这里手动给其添加了<code>v-if</code>等信息，但是我们在编写代码时仍然可以给它添加<code>v-if</code>等指令，因为它会做一个标记并做合并和兼容处理。<br>
所以这里的预处理只是针对<code>input</code>标签的处理。</p> <h4 id="parsefilters"><a href="#parsefilters" class="header-anchor">#</a> parseFilters</h4> <p>这个方法是非常复杂的，是专门用来处理过滤器的，可谓是出力不讨好，因为我们开发中使用过滤器是比较少的。我们可能会在开发过程中这样去使用一个过滤器：</p> <div class="language-html extra-class"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>{{ data | filter('a') }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>也可能这样：</p> <div class="language-html extra-class"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">:data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>data | filter<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这个东西就要分成两部分来处理了，一个是<code>'|'</code>前面的<code>data</code>，一个是后面的<code>filter</code>。那么这应该怎么处理呢？可能我们会想到通过<code>'|'</code>来截取。但是真有这么简单吗？如果改成下面这样：</p> <div class="language-html extra-class"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">:data</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">'</span>data | filter' + 1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>你会发现简单的通过<code>'|'</code>来处理是非常不严谨的。对于这种情况我们对几种情况下的<code>'|'</code>不做处理</p> <ol><li>单引号或者双引号内的</li> <li>模板字符串``中的</li> <li>正则表达式中</li> <li>连续的两个||，也就是或运算</li></ol> <p>但是真的就只是这几中情况吗？显然不是的，对于 <code>|</code> 按位运算符来说就无法识别了，那这不是没有完全的语言能力了吗？其实<code>Vue</code>也只是尽可能处理多的情况，对于这种冲突的情况则也不必非要实现，我们完全可以用计算属性的方案去代替。<code>Vue</code>只能尽可能给用户带来好的体验。<br>
下面我们来说实现过程，对于前两条我们很容易就可以实现，但是对于第三条正则就不很好判断了，我们知道正则要写在两个<code>/</code>中间，但是只判断两个<code>/</code>中间的<code>'|'</code>是不行的，因为/还能作为一个除法运算符来使用。<br>
这是一个非常复杂的过程</p> <div class="language-js extra-class"><pre class="language-js"><code>    a <span class="token operator">=</span> b
    <span class="token operator">/</span>c<span class="token operator">|</span>d<span class="token operator">/</span>g
</code></pre></div><p>这么一个表达式你说是正则还是除法呢？这其实是个除法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1</span>
<span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">1</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>

<span class="token comment">// 2</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">1</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>
</code></pre></div><p>这两段代码第一句后面都是<code>{}</code>，这在我们字符串中表现是一致的，但是第一个是标识正则的，第二是表示除法的。
所以/代表是什么含义应该综合考虑上下文语境，<code>ECMA</code>规范中清楚的告诉我们需要多中标志符号类型（<code>goal symbols</code>）来综合判断，还要考虑<code>js</code>自动插入<code>';'</code>的机制，以及其他可能有歧义的地方。这将是个复杂而庞大的工作。<br>
对于<code>Vue</code>来说，为了精确识别过滤器而投入大量的精力去写大量的代码，这显然是不值得的，并且运行性能也会受到影响，所以只要简单的实现一部分功能就可以了。<br>
然后我们来看代码实现</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">let</span> inSingle <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 不是 \ 前的 ' 设置为true</span>
  <span class="token keyword">let</span> inDouble <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 双引号中</span>
  <span class="token keyword">let</span> inTemplateString <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 斜引号中</span>
  <span class="token keyword">let</span> inRegex <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 正则中</span>
  <span class="token keyword">let</span> curly <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 遇到 { 加一，遇到 } 减一</span>
  <span class="token keyword">let</span> square <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 遇到 [ 加一，遇到 ] 减一</span>
  <span class="token keyword">let</span> paren <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 遇到 ( 加一，遇到 ) 减一</span>
  <span class="token keyword">let</span> lastFilterIndex <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> c<span class="token punctuation">,</span> prev<span class="token punctuation">,</span> i<span class="token punctuation">,</span> expression<span class="token punctuation">,</span> filters
</code></pre></div><p>先定义了一些变量，接下来是一个大的for循环，用来遍历传入的字符串</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> exp<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    prev <span class="token operator">=</span> c
    c <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inSingle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果当前读取的字符存在于由单引号包裹的字符串内</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">===</span> <span class="token number">0x27</span> <span class="token operator">&amp;&amp;</span> prev <span class="token operator">!==</span> <span class="token number">0x5C</span><span class="token punctuation">)</span> inSingle <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inDouble<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// 如果当前读取的字符存在于由双引号包裹的字符串内</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">===</span> <span class="token number">0x22</span> <span class="token operator">&amp;&amp;</span> prev <span class="token operator">!==</span> <span class="token number">0x5C</span><span class="token punctuation">)</span> inDouble <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inTemplateString<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果当前读取的字符存在于模板字符串内</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">===</span> <span class="token number">0x60</span> <span class="token operator">&amp;&amp;</span> prev <span class="token operator">!==</span> <span class="token number">0x5C</span><span class="token punctuation">)</span> inTemplateString <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inRegex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果当前读取的字符存在于正则表达式内</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">===</span> <span class="token number">0x2f</span> <span class="token operator">&amp;&amp;</span> prev <span class="token operator">!==</span> <span class="token number">0x5C</span><span class="token punctuation">)</span> inRegex <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      c <span class="token operator">===</span> <span class="token number">0x7C</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">// pipe |</span>
      exp<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0x7C</span> <span class="token operator">&amp;&amp;</span>
      exp<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token number">0x7C</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>curly <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>square <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>paren
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果当前读取的字符是过滤器的分界线</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>expression <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// first filter, end of expression</span>
        lastFilterIndex <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
        expression <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">pushFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">0x22</span><span class="token operator">:</span> inDouble <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">break</span>         <span class="token comment">// &quot;</span>
        <span class="token keyword">case</span> <span class="token number">0x27</span><span class="token operator">:</span> inSingle <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">break</span>         <span class="token comment">// '</span>
        <span class="token keyword">case</span> <span class="token number">0x60</span><span class="token operator">:</span> inTemplateString <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">break</span> <span class="token comment">// `</span>
        <span class="token keyword">case</span> <span class="token number">0x28</span><span class="token operator">:</span> paren<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token keyword">break</span>                 <span class="token comment">// (</span>
        <span class="token keyword">case</span> <span class="token number">0x29</span><span class="token operator">:</span> paren<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token keyword">break</span>                 <span class="token comment">// )</span>
        <span class="token keyword">case</span> <span class="token number">0x5B</span><span class="token operator">:</span> square<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token keyword">break</span>                <span class="token comment">// [</span>
        <span class="token keyword">case</span> <span class="token number">0x5D</span><span class="token operator">:</span> square<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token keyword">break</span>                <span class="token comment">// ]</span>
        <span class="token keyword">case</span> <span class="token number">0x7B</span><span class="token operator">:</span> curly<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token keyword">break</span>                 <span class="token comment">// {</span>
        <span class="token keyword">case</span> <span class="token number">0x7D</span><span class="token operator">:</span> curly<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token keyword">break</span>                 <span class="token comment">// }</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">===</span> <span class="token number">0x2f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// /</span>
        <span class="token comment">// 简单判断是否在正则表达式内</span>
        <span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token keyword">let</span> p
        <span class="token comment">// find first non-whitespace prev char</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> j <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          p <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!==</span> <span class="token string">' '</span><span class="token punctuation">)</span> <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>p <span class="token operator">||</span> <span class="token operator">!</span>validDivisionCharRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          inRegex <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>首先让<code>prev = c</code>，然后下面为c赋值为<code>exp.charCodeAt(i)</code>，也就是i位字符的<code>Unicode</code>码，所以每次循环是<code>prev</code>会保存前一位字符<code>Unicode</code>码。<br>
然后我先来看<code>else</code>逻辑，先是一个<code>switch</code>判断，这个内容比较简单我们就不详细分析了。然后如果<code>c</code>为<code>/</code>字符，那就找到它前面不为空的一个字符<code>p</code>。然后判断如果<code>p</code>前面不存在实际字符，那么它就是正则表达式。或者<code>p</code>不是<code>validDivisionCharRE</code>正则中的任何一种字符</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> validDivisionCharRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\w).+\-_$\]]</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>匹配<code>字母、数字、.、+、-、_、$、]</code>中的一种。<br>
如果<code>p</code>是其中之一，那么后面就不是正则。<br>
然后我们再去看前面一堆<code>if</code>和<code>else if</code>逻辑，可以看到都是判断'、&quot;、`、/等符号的闭合，最后一个则是判断<code>'|'</code>符，并且前后都不是<code>'|'</code>，也就是不是或运算；并且不是在各种括号中，那就将到<code>'|'</code>下一位索引保存在<code>lastFilterIndex</code>中，然后把前面的内容去掉首尾括号保存到<code>expression</code> 中，但是这个前提是<code>expression</code> 为<code>undefined</code>，否则要执行<code>pushFilter</code>方法</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">pushFilter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>filters <span class="token operator">||</span> <span class="token punctuation">(</span>filters <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>lastFilterIndex<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    lastFilterIndex <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>这个是针对有多个过滤器的情况</p> <div class="language-html extra-class"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>data | filter1 | filter2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>其实就是检测到第二个<code>'|'</code>，就把第一个<code>filter1</code>过滤器添加到<code>filters</code>，至于后面的<code>filter2</code>，我们执行完循环后继续往下看</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>expression <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    expression <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lastFilterIndex <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">pushFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>如果这个时候<code>expression</code> 为<code>undefined</code>，说明没有过滤器直接将所有字符串首尾空格去掉后赋值给<code>expression</code> ，如果其已经有值了就执行<code>pushFilter</code>把最后一个过滤器给添加到<code>filters</code>中，所以最后这段逻辑是把最后一个过滤器添加到<code>filters</code>数组中，所以上面的<code>filter2</code>问题也解决了。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>filters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> filters<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      expression <span class="token operator">=</span> <span class="token function">wrapFilter</span><span class="token punctuation">(</span>expression<span class="token punctuation">,</span> filters<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> expression
</code></pre></div><p>最后一段代码判断<code>filters</code>存在，就执行循环，我们来看<code>wrapFilter</code>方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">wrapFilter</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">exp</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">filter</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">const</span> i <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// _f: resolveFilter</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_f(&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filter<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;)(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>exp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    <span class="token keyword">const</span> args <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_f(&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;)(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>exp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args <span class="token operator">!==</span> <span class="token string">')'</span> <span class="token operator">?</span> <span class="token string">','</span> <span class="token operator">+</span> args <span class="token operator">:</span> args<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个方法就是把过滤器包装成一个<code>code</code>字符串，因为多个过滤器是要在前一个过滤器处理后再去处理的，所以这里其实是做成了嵌套的样子，判断括号是为了处理过滤器再传入参数的情况。这部分比较难描述，就不多做介绍了。</p> <h3 id="_3-属性增强处理"><a href="#_3-属性增强处理" class="header-anchor">#</a> 3. 属性增强处理</h3> <p>我们在指向性<code>processElement</code>方法时会有这样一段逻辑</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> transforms<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    element <span class="token operator">=</span> transforms<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token operator">||</span> element
  <span class="token punctuation">}</span>
</code></pre></div><p>这个其实就是执行<code>modules</code>中的<code>transformNode</code>属性方法，这个方法主要是用来处理<code>style</code>和<code>class</code>逻辑的，其实就是对其属性做一个增强。<br>
我们先到<code>web/compiler/modules/class.js</code>中看对<code>class</code>的处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">transformNode</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement<span class="token punctuation">,</span> <span class="token literal-property property">options</span><span class="token operator">:</span> CompilerOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> warn <span class="token operator">=</span> options<span class="token punctuation">.</span>warn <span class="token operator">||</span> baseWarn
  <span class="token keyword">const</span> staticClass <span class="token operator">=</span> <span class="token function">getAndRemoveAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'class'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> staticClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">parseText</span><span class="token punctuation">(</span>staticClass<span class="token punctuation">,</span> options<span class="token punctuation">.</span>delimiters<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">class=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>staticClass<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;: </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token string">'Interpolation inside attributes has been removed. '</span> <span class="token operator">+</span>
        <span class="token string">'Use v-bind or the colon shorthand instead. For example, '</span> <span class="token operator">+</span>
        <span class="token string">'instead of &lt;div class=&quot;{{ val }}&quot;&gt;, use &lt;div :class=&quot;val&quot;&gt;.'</span><span class="token punctuation">,</span>
        el<span class="token punctuation">.</span>rawAttrsMap<span class="token punctuation">[</span><span class="token string">'class'</span><span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>staticClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    el<span class="token punctuation">.</span>staticClass <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>staticClass<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> classBinding <span class="token operator">=</span> <span class="token function">getBindingAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'class'</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* getStatic */</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>classBinding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    el<span class="token punctuation">.</span>classBinding <span class="token operator">=</span> classBinding
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先获取静态<code>staticClass</code>属性，然后就是对属性插值表达式的判断，因为属性是不允许的写插值的，所以这里要报一个警告。<br>
然后如果获取到静态<code>class</code>，就将再做一层<code>JSON</code>字符串转换并赋值给<code>el.staticClass</code>。<br>
接下来获取动态<code>class</code>的值<code>classBinging</code>，如果<code>classBinging</code>存在则将其赋值给<code>el.classBinging</code>。<br>
然后<code>class.js</code>中 还定义了一个<code>genData</code>方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genData</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>staticClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">staticClass:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>staticClass<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>classBinding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">class:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>classBinding<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> data
<span class="token punctuation">}</span>
</code></pre></div><p>将静态<code>class</code>和动态<code>class</code>做一个拼接后返回，中间用<code>','</code>分割。并且带有各自的前缀。
再来看<code>style.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">transformNode</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement<span class="token punctuation">,</span> <span class="token literal-property property">options</span><span class="token operator">:</span> CompilerOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> warn <span class="token operator">=</span> options<span class="token punctuation">.</span>warn <span class="token operator">||</span> baseWarn
  <span class="token keyword">const</span> staticStyle <span class="token operator">=</span> <span class="token function">getAndRemoveAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'style'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>staticStyle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* istanbul ignore if */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">parseText</span><span class="token punctuation">(</span>staticStyle<span class="token punctuation">,</span> options<span class="token punctuation">.</span>delimiters<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">style=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>staticStyle<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;: </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token string">'Interpolation inside attributes has been removed. '</span> <span class="token operator">+</span>
          <span class="token string">'Use v-bind or the colon shorthand instead. For example, '</span> <span class="token operator">+</span>
          <span class="token string">'instead of &lt;div style=&quot;{{ val }}&quot;&gt;, use &lt;div :style=&quot;val&quot;&gt;.'</span><span class="token punctuation">,</span>
          el<span class="token punctuation">.</span>rawAttrsMap<span class="token punctuation">[</span><span class="token string">'style'</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    el<span class="token punctuation">.</span>staticStyle <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token function">parseStyleText</span><span class="token punctuation">(</span>staticStyle<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> styleBinding <span class="token operator">=</span> <span class="token function">getBindingAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">'style'</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* getStatic */</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>styleBinding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    el<span class="token punctuation">.</span>styleBinding <span class="token operator">=</span> styleBinding
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">genData</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> ASTElement</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>staticStyle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">staticStyle:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>staticStyle<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>styleBinding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">style:(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>styleBinding<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">),</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> data
<span class="token punctuation">}</span>
</code></pre></div><p>与<code>class</code>处理基本上完全一致，就不赘述了。</p> <h2 id="parse正则常量分析"><a href="#parse正则常量分析" class="header-anchor">#</a> parse正则常量分析</h2> <h3 id="onre"><a href="#onre" class="header-anchor">#</a> onRE</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> onRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^@|^v-on:</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>匹配v-on:指令或@开头属性</p> <h3 id="dirre"><a href="#dirre" class="header-anchor">#</a> dirRE</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> dirRE <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VBIND_PROP_SHORTHAND</span> <span class="token comment">//vbind_prop_shortHand</span>
  <span class="token operator">?</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^v-|^@|^:|^\.|^#</span><span class="token regex-delimiter">/</span></span>
  <span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^v-|^@|^:|^#</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>匹配是否是指令。然后这里在不同环境变量下会有不同的定义，VBIND_PROP_SHORTHAND为true的话则是会多一个^.，其实是为v-bind.prop修饰符准备的，我们知道.prop修饰可以把属性处理为DOM property而不是一个props，但是它还有下面这种写法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">'&lt;div&gt;&lt;span .text-content=&quot;foo&quot;&gt;&lt;/span&gt;&lt;/div&gt;'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token string">'hello'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token string">'&lt;span&gt;qux&lt;/span&gt;'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>绑定text-content.prop时直接简写为.text-content，所以这个东西就是来检测.prop的。</p> <h3 id="foraliasre"><a href="#foraliasre" class="header-anchor">#</a> forAliasRE</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> forAliasRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">([\s\S]*?)\s+(?:in|of)\s+([\s\S]*)</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>这个正则稍微复杂一些，先匹配任意字符直到遇到空白字符后跟一个in或of为止，然后再加若干空白字符，最后再匹配剩余所有字符。<br>
显然这是用来处理for in 或者for of循环的。as: 'item in list'。这里只会捕获item和list</p> <h3 id="foriteratorre"><a href="#foriteratorre" class="header-anchor">#</a> forIteratorRE</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> forIteratorRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">,([^,\}\]]*)(?:,([^,\}\]]*))?$</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>对于for循环我们可以写多种形式(item, index) of list和(value, key, index) in object，这个正则就是对迭代项进行处理的，因为它们都是逗号分隔的，所以这里要匹配逗号。</p> <h3 id="stripparensre"><a href="#stripparensre" class="header-anchor">#</a> stripParensRE</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> stripParensRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\(|\)$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>
</code></pre></div><p>这个就是匹配左右括号的，很显然上面处理forIteratorRE时会受到小括号影响，所以在其之前得通过本正则去掉左右括号。</p> <h3 id="dynamicargre"><a href="#dynamicargre" class="header-anchor">#</a> dynamicArgRE</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> dynamicArgRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\[.*\]$</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>匹配动态的参数比如v-bind:[show]中的show</p> <h3 id="argre"><a href="#argre" class="header-anchor">#</a> argRE</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> argRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">:(.*)$</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>捕获':'后面的参数</p> <h3 id="bindre"><a href="#bindre" class="header-anchor">#</a> bindRE</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> bindRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^:|^\.|^v-bind:</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>匹配':'、'.'、'v-bind'开头</p> <h3 id="propbindre"><a href="#propbindre" class="header-anchor">#</a> propBindRE</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> propBindRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\.</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>只匹配.prop修饰符</p> <h3 id="modifierre"><a href="#modifierre" class="header-anchor">#</a> modifierRE</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> modifierRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.[^.\]]+(?=[^\]]*$)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>
</code></pre></div><p>匹配修饰符</p> <h3 id="slotre"><a href="#slotre" class="header-anchor">#</a> slotRE</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> slotRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^v-slot(:|$)|^#</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>匹配插槽指令</p> <h3 id="linebreakre"><a href="#linebreakre" class="header-anchor">#</a> lineBreakRE</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> lineBreakRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\r\n]</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>匹配换行符合回车符</p> <h3 id="whitespace"><a href="#whitespace" class="header-anchor">#</a> whitespace</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> whitespaceRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[ \f\t\r\n]+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>
</code></pre></div><p>匹配空白字符</p> <h3 id="invalidattributere"><a href="#invalidattributere" class="header-anchor">#</a> invalidAttributeRE</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> invalidAttributeRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\s&quot;'&lt;&gt;\/=]</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>匹配无效的属性，含有空白、'、&quot;、&lt;&gt;、/、=等字符</p> <h3 id="decodehtmlcached"><a href="#decodehtmlcached" class="header-anchor">#</a> decodeHTMLCached</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> decodeHTMLCached <span class="token operator">=</span> <span class="token function">cached</span><span class="token punctuation">(</span>he<span class="token punctuation">.</span>decode<span class="token punctuation">)</span>
</code></pre></div><p>he是一个三方库，用来解码html实体，cached可以做一个缓存。</p> <h2 id="parsehtml正则常量分析"><a href="#parsehtml正则常量分析" class="header-anchor">#</a> parseHTML正则常量分析</h2> <h3 id="attribute"><a href="#attribute" class="header-anchor">#</a> attribute</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> attribute <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*([^\s&quot;'&lt;&gt;\/=]+)(?:\s*(=)\s*(?:&quot;([^&quot;]*)&quot;+|'([^']*)'+|([^\s&quot;'=&lt;&gt;`]+)))?</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>匹配标签的属性，可以看到它定义非常复杂，但是总的来说分为5个捕获组：</p> <ol><li>先以非空字符开头，然后匹配不以空字符、单双引号、左右尖括号、左右斜杠、等号开头的几个字符，其实就是为了匹配我们的属性名。</li> <li>捕获一个等号，允许前后有若干空字符</li> <li>捕获&quot; &quot;内的非双引号字符，也就是匹配属性值</li> <li>捕获' '内非单引号的内容，也就是匹配属性值另一种形式</li> <li>捕获等号后面的若干非空字符，也就是匹配属性值没有用引号包裹情况
比如<code>class=&quot;className&quot;`` class='className'</code> <code>class=className</code> 这几种情况，其实还有一种情况比如只有属性没有属性值，如<code>input</code>的<code>disabled</code>属性也可以匹配到。</li></ol> <h3 id="dynamicargattribute"><a href="#dynamicargattribute" class="header-anchor">#</a> dynamicArgAttribute</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> dynamicArgAttribute <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*((?:v-[\w-]+:|@|:|#)\[[^=]+?\][^\s&quot;'&lt;&gt;\/=]*)(?:\s*(=)\s*(?:&quot;([^&quot;]*)&quot;+|'([^']*)'+|([^\s&quot;'=&lt;&gt;`]+)))?</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>这个显然是动态属性名匹配了，比如<code>v-modal:[name]=&quot;realName&quot;</code>形式，这个只能匹配动态属性且属性名也是动态的属性，<code>attribute</code>则是所有属性名都能匹配，它们是包含关系。</p> <h3 id="ncname"><a href="#ncname" class="header-anchor">#</a> ncname</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> unicodeRegExp <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">a-zA-Z\u00B7\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u037D\u037F-\u1FFF\u200C-\u200D\u203F-\u2040\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD</span><span class="token regex-delimiter">/</span></span>

<span class="token keyword">const</span> ncname <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[a-zA-Z_][\\-\\.0-9_a-zA-Z</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>unicodeRegExp<span class="token punctuation">.</span>source<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]*</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><p>unicodeRegExp是一堆乱七八糟的字符·À-ÖØ-öø-ͽͿ-῿-‿-⁀⁰-↏Ⰰ-⿯、-퟿豈-﷏ﷰ-�，
下面了解几个问题
一、合法的 XML 名称是什么样的？<br>
首先在 XML 中，标签是用户自己定义的，比如：<code>&lt;bug&gt;&lt;/bug&gt;</code>。</p> <p>正因为这样，所以不同的文档中如果定义了相同的元素(标签)，就会产生冲突，为此，XML 允许用户为标签指定前缀：<code>&lt;k:bug&gt;&lt;/k:bug&gt;</code>，前缀是字母 k。</p> <p>除了前缀还可以使用命名空间，即使用标签的 xmlns 属性，为前缀赋予与指定命名空间相关联的限定名称：</p> <div class="language-html extra-class"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">k:</span>bug</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>k</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.xxx.com/xxx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">k:</span>bug</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>二、什么是 ncname？<br>
ncname 的全称是 An XML name that does not contain a colon (😃 即：不包含冒号(:)的 XML 名称。也就是说 ncname 就是不包含前缀的XML标签名称。大家可以在这里找到关于 ncname 的概念。</p> <p>三、什么是 qname？
<a href="https://www.w3.org/TR/1999/REC-xml-names-19990114/#NT-QName" target="_blank" rel="noopener noreferrer">链接<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
其实 qname 就是：&lt;前缀:标签名称&gt;，也就是合法的XML标签。</p> <p>了解了这些，我们再来看 ncname 的正则表达式，它定义了 ncname 的合法组成，这个正则所匹配的内容很简单：字母或下划线开头，后面可以跟任意数量的字符、中横线和 .。</p> <h3 id="qnamecapure"><a href="#qnamecapure" class="header-anchor">#</a> qnameCapure</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> qnameCapture <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">((?:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\:)?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><p>其实就是检查是否是合法的标签名称，由可选的前缀、冒号和名称组成，这个就是匹配标签名称。</p> <h3 id="starttagopen"><a href="#starttagopen" class="header-anchor">#</a> startTagOpen</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> startTagOpen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>qnameCapture<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</code></pre></div><p>这个很好理解匹配开始标签的开始，以&lt;开头以及标签名</p> <h3 id="starttagclose"><a href="#starttagclose" class="header-anchor">#</a> startTagClose</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> startTagClose <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*(\/?)&gt;</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>这个则是开始标签的闭合，匹配/&gt;或&gt;，因为对于一元标签，开始标签也是结束标签。</p> <h3 id="endtag"><a href="#endtag" class="header-anchor">#</a> endTag</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> endTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^&lt;\\/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>qnameCapture<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">[^&gt;]*&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</code></pre></div><p>匹配结束标签<code>&lt;/xxx&gt;</code>的形式</p> <h3 id="doctype"><a href="#doctype" class="header-anchor">#</a> doctype</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> doctype <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;!DOCTYPE [^&gt;]+&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span>
</code></pre></div><p>匹配DOCTYPE标签</p> <h3 id="comment"><a href="#comment" class="header-anchor">#</a> comment</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> comment <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;!\--</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>匹配注释节点，这里使用<code>&lt;!\--</code>而不是<code>&lt;!--</code>是为了允许Vue把代码内联到html中，否则会被认为是注释节点</p> <h3 id="conditionalcomment"><a href="#conditionalcomment" class="header-anchor">#</a> conditionalComment</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> conditionalComment <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;!\[</span><span class="token regex-delimiter">/</span></span>
</code></pre></div><p>匹配条件注释</p> <h3 id="isplaintextelement"><a href="#isplaintextelement" class="header-anchor">#</a> isPlainTextElement</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> isPlainTextElement <span class="token operator">=</span> <span class="token function">makeMap</span><span class="token punctuation">(</span><span class="token string">'script,style,textarea'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre></div><p>判断标签是不是纯文本标签（包括：script、style、textare）</p> <h3 id="decodingmap"><a href="#decodingmap" class="header-anchor">#</a> decodingMap</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> decodingMap <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'&amp;lt;'</span><span class="token operator">:</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'&amp;gt;'</span><span class="token operator">:</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'&amp;quot;'</span><span class="token operator">:</span> <span class="token string">'&quot;'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'&amp;amp;'</span><span class="token operator">:</span> <span class="token string">'&amp;'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'&amp;#10;'</span><span class="token operator">:</span> <span class="token string">'\n'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'&amp;#9;'</span><span class="token operator">:</span> <span class="token string">'\t'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'&amp;#39;'</span><span class="token operator">:</span> <span class="token string">&quot;'&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这些key是特殊的html实体，值则是对应字符</p> <h3 id="encodedattr"><a href="#encodedattr" class="header-anchor">#</a> encodedAttr</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> encodedAttr <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;(?:lt|gt|quot|amp|#39);</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>
</code></pre></div><p>匹配上面的那些特殊字符</p> <h3 id="encodedattrwithnewlines"><a href="#encodedattrwithnewlines" class="header-anchor">#</a> encodedAttrWithNewLines</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> encodedAttrWithNewLines <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;(?:lt|gt|quot|amp|#39|#10|#9);</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>
</code></pre></div><p>比encodedAttr多了换号符和制表符</p> <h3 id="isignorenewlinetag"><a href="#isignorenewlinetag" class="header-anchor">#</a> isIgnoreNewlineTag</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> isIgnoreNewlineTag <span class="token operator">=</span> <span class="token function">makeMap</span><span class="token punctuation">(</span><span class="token string">'pre,textarea'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre></div><p>判断是不是pre、textarea标签</p> <h3 id="shouldignorefirstnewline"><a href="#shouldignorefirstnewline" class="header-anchor">#</a> shouldIgnoreFirstNewline</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">shouldIgnoreFirstNewline</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> html</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> tag <span class="token operator">&amp;&amp;</span> <span class="token function">isIgnoreNewlineTag</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> html<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'\n'</span>
</code></pre></div><p>在pre和textarea标签中会忽略内容的第一个换行符，这是浏览器的行为，所以Vue也要实现这个行为。所以这里就是判断这些标签中第一个是不是换行服。</p> <h3 id="decodeattr"><a href="#decodeattr" class="header-anchor">#</a> decodeAttr</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">decodeAttr</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> shouldDecodeNewlines</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> re <span class="token operator">=</span> shouldDecodeNewlines <span class="token operator">?</span> encodedAttrWithNewLines <span class="token operator">:</span> encodedAttr
  <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>re<span class="token punctuation">,</span> <span class="token parameter">match</span> <span class="token operator">=&gt;</span> decodingMap<span class="token punctuation">[</span>match<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>解码html实体，其实就是把decodingMap中html实体解码。
根据传入的shouldDecodeNewlines判断是否解码换行符合制表符。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/./appendix/vue-router.html" class="prev">
        vue-router
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.20317d9d.js" defer></script><script src="./assets/js/2.8a65079d.js" defer></script><script src="./assets/js/17.eee5b860.js" defer></script>
  </body>
</html>
